<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DailyGlow - Ton Coach Beaut√© Personnel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Paddle SDK -->
    <script src="https://cdn.paddle.com/paddle/paddle.js"></script>
    <style>
        /* Fix d√©bordement mobile */
        html, body {
            max-width: 100%;
            overflow-x: hidden;
        }

        #moodTrackerSection {
            max-width: 100%;
            overflow-x: hidden;
            padding: 15px;
            box-sizing: border-box;
        }

        #moodTrackerSection > * {
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Fix les emojis mood qui d√©passent */
        .mood-options, .mood-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 100%;
        }

        .mood-option, .mood-item {
            flex: 0 0 auto;
            min-width: 70px;
            max-width: 80px;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ffeef8 0%, #e6f2ff 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            padding: 40px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: #ff6b6b;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.2em;
            font-weight: 400;
        }

        .subtitle {
            text-align: center;
            color: #8e9aaf;
            margin-bottom: 30px;
            font-size: 1em;
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #f0f0f0;
            z-index: 1;
        }

        .progress-step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            position: relative;
            z-index: 2;
        }

        .progress-step.active {
            background: linear-gradient(135deg, #ff6b6b, #ffb6b9);
        }

        .section {
            display: none;
            animation: slideIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #5c677d;
            font-weight: 400;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #f5f5f5;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: #fafafa;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #ffb6b9;
            background: white;
        }
        .mood-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.2);
            border-color: #a29bfe !important;
        }

        .mood-option.selected {
            background: linear-gradient(135deg, #f5f3ff, #e8e5ff);
            border-color: #6c5ce7 !important;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }

        .trigger-btn.selected {
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            color: white !important;
            border-color: #667eea !important;
        }

        button {
            background: linear-gradient(135deg, #ff6b6b, #ffb6b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .skin-type-grid, .concerns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .skin-type-option, .concern-option {
            padding: 20px 15px;
            border: 2px solid #f5f5f5;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            background: linear-gradient(135deg, #ffffff, #fafafa);
            position: relative;
            overflow: hidden;
        }

        .skin-type-option::before, .concern-option::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #ff6b6b, #ffb6b9);
            border-radius: 15px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: -1;
        }

        .skin-type-option:hover, .concern-option:hover {
            border-color: #ffb6b9;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 182, 185, 0.3);
        }

        .skin-type-option:hover::before, .concern-option:hover::before {
            opacity: 0.1;
        }

        .skin-type-option.selected, .concern-option.selected {
            background: linear-gradient(135deg, #fff0f5, #ffe6ec);
            color: #ff6b6b;
            border-color: #ffb6b9;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.2);
        }

        .skin-type-option strong {
            display: block;
            margin-bottom: 8px;
            font-size: 1.1em;
            color: #5c677d;
        }

        .skin-type-option.selected strong, .concern-option.selected strong {
            color: #ff6b6b;
        }

        .skin-type-option span {
            display: block;
            font-size: 1.5em;
            margin-bottom: 8px;
        }

        .concern-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .concern-option span {
            font-size: 1.8em;
        }

        .result {
            background: linear-gradient(135deg, #fff5f7, #fef8fa);
            padding: 30px;
            border-radius: 20px;
            margin-top: 20px;
        }

        .routine-item {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            animation: slideInRight 0.3s ease;
            color: #5c677d;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .notification.show {
            display: block;
        }

        /* Styles pour les photos */
        .photo-upload-zone {
            border: 3px dashed #ffe0e6;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #fff9fa, #fff5f7);
        }

        .photo-upload-zone:hover {
            border-color: #ffb6b9;
            background: linear-gradient(135deg, #fff5f7, #ffeef1);
        }

        .upload-content i {
            font-size: 3em;
            color: #ff6b6b;
            margin-bottom: 15px;
        }

        .photo-types {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .photo-type-btn {
            padding: 10px 20px;
            border: 2px solid #f5f5f5;
            border-radius: 25px;
            background: white;
            color: #8e9aaf;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-type-btn.active {
            background: linear-gradient(135deg, #ff6b6b, #ffb6b9);
            color: white;
            border-color: #ff6b6b;
        }

        .photo-gallery {
            margin: 30px 0;
            min-height: 200px;
        }

        .gallery-empty {
            text-align: center;
            padding: 40px;
            color: #c8d3e0;
        }

        .gallery-empty i {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Styles pour l'assistant */
        .ai-welcome {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #fff5f7, #ffeef1);
            border-radius: 20px;
            margin-bottom: 30px;
        }

        .ai-avatar {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .ai-sections {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 30px 0;
        }

        .ai-section {
            background: white;
            border: 2px solid #f5f5f5;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .ai-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 182, 185, 0.15);
            border-color: #ffb6b9;
        }

        .ai-section-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .ai-section h4 {
            color: #5c677d;
            margin: 10px 0 5px 0;
        }

        .ai-section p {
            color: #8e9aaf;
            font-size: 0.9em;
        }

        .ai-output {
            background: linear-gradient(135deg, #fafbfc, #f5f7f9);
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            min-height: 200px;
            border: 2px dashed #e8ecf1;
            transition: all 0.3s ease;
        }

        .ai-output.active {
            border-color: #ffb6b9;
            background: linear-gradient(135deg, #fff9fa, #fff5f7);
            border-style: solid;
        }

        .ai-placeholder {
            text-align: center;
            color: #c8d3e0;
            padding: 40px 20px;
        }

        .ai-placeholder i {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .ai-recommendation {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #ff6b6b;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .ai-loading {
            text-align: center;
            padding: 40px;
            color: #ff6b6b;
        }

        .ai-loading i {
            font-size: 2em;
            margin-bottom: 15px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            margin: 10px 5px;
            border-radius: 25px;
            background: linear-gradient(135deg, #ff6b6b, #ffb6b9);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .form-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
        }

        .section-title {
            color: #5c677d;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 400;
        }

        h2 {
            color: #5c677d;
            font-weight: 400;
        }

        h3 {
            color: #5c677d;
            font-weight: 400;
        }

        /* Analyse Photo IA */
        #photoAISection {
            display: none;
        }

        #photoAISection.active {
            display: block !important;
            background: #fef5f5;
            min-height: 100vh;
            padding: 20px;
        }
        /* Sections plein √©cran */
        #moodTrackerSection.fullscreen,
        #ingredientAnalyzerSection.fullscreen,
        #cycleTrackerSection.fullscreen,
        #photoAISection.fullscreen {  /* ‚Üê AJOUTEZ CETTE LIGNE */
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            max-width: none !important;
            padding: 20px !important;
            margin: 0 !important;
            overflow-y: auto !important;
            z-index: 10000 !important;
            background: linear-gradient(135deg, #ffeef8 0%, #e6f2ff 100%) !important;
        }
    </style>
    
<!-- Paddle.js -->
<script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>
<script>
    Paddle.Initialize({ 
        seller: 276616,
        environment: 'production'
    });
</script>

</head>
<body>
    <div class="container">
        <h1>üå∏ DailyGlow</h1>
        <p class="subtitle">Ton coach beaut√© bienveillant et personnalis√©</p>

        <div class="progress-bar" id="progressBar">
            <div class="progress-step active">1</div>
            <div class="progress-step">2</div>
            <div class="progress-step">3</div>
            <div class="progress-step">4</div>
        </div>

        <!-- √âtape 1: Inscription / Connexion -->
        <div class="section active" id="step1">
            <h2 id="authTitle">üëã Bienvenue ! Commen√ßons par faire connaissance</h2>
    
            <!-- Boutons pour basculer -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button id="btnInscription" onclick="showInscription()" 
                        style="flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                    üìù Inscription
                </button>
                <button id="btnConnexion" onclick="showConnexion()" 
                        style="flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: #e2e8f0; color: #4a5568;">
                    üîê Connexion
                </button>
            </div>
    
            <!-- Champs pour inscription seulement -->
            <div id="inscriptionFields">
                <div class="form-group">
                    <label for="name">Pr√©nom :</label>
                    <input type="text" id="name" placeholder="Sarah" required>
                </div>
            </div>
    
            <div class="form-group">
                <label for="email">Email :</label>
                <input type="email" id="email" placeholder="sarah@example.com" required>
            </div>
            <div class="form-group">
                <label for="password">Mot de passe :</label>
                <input type="password" id="password" placeholder="Minimum 6 caract√®res" required>
            
            </div>
    
            <!-- Champs pour inscription seulement -->
            <div id="inscriptionFields2">
                <div class="form-group">
                    <label for="age">√Çge :</label>
                    <input type="number" id="age" placeholder="25" min="13" max="100" required>
                </div>
            </div>
    
            <button id="authButton" onclick="handleAuth()">Cr√©er mon compte ‚Üí</button>
    
            <p id="authSwitch" style="text-align: center; margin-top: 15px; color: #718096; font-size: 0.9em;">
                D√©j√† un compte ? <a href="#" onclick="showConnexion()" style="color: #667eea; font-weight: bold;">Se connecter</a>
            </p>
        </div>

        <!-- √âtape 2: Type de peau -->
        <div class="section" id="step2">
            <h2>üîç Quel est ton type de peau ?</h2>
            <div class="skin-type-grid">
                <div class="skin-type-option" onclick="selectSkinType('normale')">
                    <span>‚ú®</span>
                    <strong>Normale</strong>
                    √âquilibr√©e, douce et confortable
                </div>
                <div class="skin-type-option" onclick="selectSkinType('s√®che')">
                    <span>üèúÔ∏è</span>
                    <strong>S√®che</strong>
                    Tiraillements, zones rugueuses
                </div>
                <div class="skin-type-option" onclick="selectSkinType('grasse')">
                    <span>üíß</span>
                    <strong>Grasse</strong>
                    Brillance, texture irr√©guli√®re
                </div>
                <div class="skin-type-option" onclick="selectSkinType('mixte')">
                    <span>üé≠</span>
                    <strong>Mixte</strong>
                    Zone T grasse, joues s√®ches
                </div>
                <div class="skin-type-option" onclick="selectSkinType('sensible')">
                    <span>üå∏</span>
                    <strong>Sensible</strong>
                    R√©active, rougeurs fr√©quentes
                </div>
            </div>
            <button onclick="nextStep(2)" id="skinTypeNext" style="margin-top: 20px;" disabled>Suivant ‚Üí</button>
        </div>

        <!-- √âtape 3: Pr√©occupations -->
        <div class="section" id="step3">
            <h2>üéØ Quelles sont tes pr√©occupations ? (plusieurs choix possibles)</h2>
            <div class="concerns-grid">
                <div class="concern-option" data-concern="acne" onclick="toggleConcernFixed(this)">
                    <span>üî¥</span>
                    <strong>Acn√©</strong>
                    Boutons & imperfections
                </div>
                <div class="concern-option" data-concern="points noirs" onclick="toggleConcernFixed(this)">
                    <span>‚ö´</span>
                    <strong>Points noirs</strong>
                    Com√©dons visibles
                </div>
                <div class="concern-option" data-concern="pores dilates" onclick="toggleConcernFixed(this)">
                    <span>üîç</span>
                    <strong>Pores dilat√©s</strong>
                    Texture irr√©guli√®re
                </div>
                <div class="concern-option" data-concern="taches pigmentaires" onclick="toggleConcernFixed(this)">
                    <span>üé®</span>
                    <strong>Taches</strong>
                    Hyperpigmentation
                </div>
                <div class="concern-option" data-concern="rides" onclick="toggleConcernFixed(this)">
                    <span>‚è∞</span>
                    <strong>Rides</strong>
                    Signes de l'√¢ge
                </div>
                <div class="concern-option" data-concern="secheresse" onclick="toggleConcernFixed(this)">
                    <span>üåµ</span>
                    <strong>S√©cheresse</strong>
                    D√©shydratation
                </div>
                <div class="concern-option" data-concern="sensibilite" onclick="toggleConcernFixed(this)">
                    <span>üå°Ô∏è</span>
                    <strong>Sensibilit√©</strong>
                    Irritations & rougeurs
                </div>
                <div class="concern-option" data-concern="brillance" onclick="toggleConcernFixed(this)">
                    <span>‚ú®</span>
                    <strong>Brillance</strong>
                    Exc√®s de s√©bum
                </div>
                <div class="concern-option" data-concern="cernes" onclick="toggleConcernFixed(this)">
                    <span>üëÅÔ∏è</span>
                    <strong>Cernes</strong>
                    Poches & fatigue
                </div>
                <div class="concern-option" data-concern="teint terne" onclick="toggleConcernFixed(this)">
                    <span>‚òÅÔ∏è</span>
                    <strong>Teint terne</strong>
                    Manque d'√©clat
                </div>
                <div class="concern-option" data-concern="cicatrices" onclick="toggleConcernFixed(this)">
                    <span>ü©π</span>
                    <strong>Cicatrices</strong>
                    Marques r√©siduelles
                </div>
                <div class="concern-option" data-concern="relachement" onclick="toggleConcernFixed(this)">
                    <span>üìâ</span>
                    <strong>Rel√¢chement</strong>
                    Perte de fermet√©
                </div>
            </div>
            <button onclick="nextStep(3)" style="margin-top: 20px;">Suivant ‚Üí</button>
        </div>

        <!-- √âtape 4: Stress -->
        <div class="section" id="step4">
            <h2>üòå Quel est ton niveau de stress actuellement ?</h2>
            <div class="form-group">
                <label for="stressLevel">Niveau de stress (1 = tr√®s d√©tendue, 10 = tr√®s stress√©e) :</label>
                <input type="range" id="stressLevel" min="1" max="10" value="5" oninput="updateStressDisplay()">
                <div style="text-align: center; margin-top: 10px;">
                    <span id="stressDisplay">5 / 10</span>
                </div>
            </div>
            <button onclick="createProfile()" style="margin-top: 20px;">Cr√©er ma routine ! ‚ú®</button>
        </div>

        <!-- R√©sultat -->
        <div class="section" id="result">
            <!-- Banni√®re de rappel -->
            <div id="reminderBanner" style="display: none; background: linear-gradient(135deg, #f093fb, #f5576c); color: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; cursor: pointer;" onclick="showCheckIn()">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <div style="font-weight: bold; font-size: 1.1em;">üìù Check-in quotidien</div>
                        <div style="font-size: 0.9em; opacity: 0.9;" id="reminderMessage">N'oublie pas ton check-in !</div>
                    </div>
                    <div style="font-size: 1.5em;">‚Üí</div>
                </div>
            </div>
            <!-- Bouton Premium -->
            <div style="margin: 15px 0; text-align: center;">
                <button onclick="showPaymentSection()" 
                        style="padding: 12px 25px; 
                               background: linear-gradient(135deg, #667eea, #764ba2);
                               color: white; 
                               border: none; 
                               border-radius: 25px; 
                               font-weight: bold;
                               cursor: pointer;
                               box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                    ‚≠ê Passer √† Premium
                </button>
            </div>
            <div class="result">
                <h2>üéâ Ta routine personnalis√©e est pr√™te !</h2>
                <div id="routineContent"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="showPhotos()" style="flex: 1;">
                        <i class="fas fa-camera"></i> Mes Photos
                    </button>
                    <button onclick="showCheckIn()" style="flex: 1;">
                        <i class="fas fa-check-circle"></i> Check-in
                    </button>
                </div>
                <button onclick="showCycleTracker()" style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #ec407a 0%, #ad1457 100%);">
                    üåô Cycle Tracker
                </button>
                <button onclick="showMoodTracker()" style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);">
                    üß† Mood & Psycho-derma
                </button>
                <button onclick="showIngredientAnalyzer()" style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);">
                    üî¨ Analyseur d'ingr√©dients INCI
                </button>
            </div>
        </div>

        <!-- Section Photos -->
        <div class="section" id="photos">
            <div class="form-card">
                <h2 class="section-title">
                    <i class="fas fa-camera"></i>
                    Mes Photos de Progression
                </h2>
                <div class="photo-upload-zone" onclick="document.getElementById('photoInput').click()">
                    <div class="upload-content">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>Ajouter une photo</h3>
                        <p>Clique ici ou glisse une image</p>
                        <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="uploadPhoto(event)">
                    </div>
                </div>
                <div class="photo-types">
                    <button class="photo-type-btn active" onclick="selectPhotoType('progress')" data-type="progress">
                        <i class="fas fa-chart-line"></i> Progression
                    </button>
                    <button class="photo-type-btn" onclick="selectPhotoType('before')" data-type="before">
                        <i class="fas fa-arrow-left"></i> Avant
                    </button>
                    <button class="photo-type-btn" onclick="selectPhotoType('after')" data-type="after">
                        <i class="fas fa-arrow-right"></i> Apr√®s
                    </button>
                </div>
                <!-- NOUVEAU : Bouton Analyse IA -->
                <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #fff5e6, #ffe0cc); border-radius: 15px;">
                    <h3 style="color: #d35400; margin-bottom: 10px;">ü§ñ Analyse IA Avanc√©e</h3>
                    <p style="color: #a04000; margin-bottom: 15px; font-size: 0.9em;">
                        Utilisez l'intelligence artificielle pour d√©tecter automatiquement vos probl√®mes de peau
                    </p>
                    <button onclick="showPhotoAI()" 
                            style="width: 100%; padding: 15px; 
                                   background: linear-gradient(135deg, #f39c12, #e74c3c);
                                   color: white; border: none; border-radius: 10px; 
                                   font-size: 1.1em; font-weight: bold; cursor: pointer;
                                   box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);">
                        üì∏ Lancer l'Analyse Photo IA
                        <span style="background: #e74c3c; padding: 2px 8px; border-radius: 5px; margin-left: 10px; font-size: 0.8em;">PRO</span>
                    </button>
                </div>
                <div class="photo-gallery" id="photoGallery">
                    <div class="gallery-empty">
                        <i class="fas fa-images"></i>
                        <p>Aucune photo pour le moment</p>
                        <small>Ajoute ta premi√®re photo pour commencer ton suivi !</small>
                    </div>
                </div>
                <!-- Comparaison Avant/Apr√®s -->
                <div id="beforeAfterCard" style="background: white; border-radius: 15px; padding: 20px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 style="color: #2d3748; margin-bottom: 15px;">üì∏ Comparaison Avant/Apr√®s</h3>
    
                    <div id="beforeAfterContent">
                        <p style="color: #718096; text-align: center;">Chargement...</p>
                    </div>
    
                    <button onclick="loadBeforeAfter()" style="width: 100%; margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">
                        üîÑ Voir ma progression
                    </button>
                </div>
                <button class="btn" onclick="showAnalytics()">
                    <span>Voir mes analytics</span>
                    <i class="fas fa-chart-bar"></i>
                </button>
                <!-- CORRECTION 2: Ajout du bouton retour au dashboard -->
                <button onclick="returnToDashboard()" style="margin-top: 10px;">
                    ‚Üê Retour au dashboard
                </button>
            </div>
        </div>

        <!-- Analytics -->
        <div class="section" id="analytics">
            <div class="form-card">
                <h2 class="section-title">
                    <i class="fas fa-chart-bar"></i>
                    Tes Analytics D√©taill√©es
                </h2>
        
                <!-- Statistiques principales -->
                <div id="statsOverview" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold;" id="statTotalAnalyses">0</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">Analyses effectu√©es</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold;" id="statAverageScore">--</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">Score moyen</div>
                    </div>
                   <div style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                       <div style="font-size: 2.5em; font-weight: bold;" id="statLatestScore">--</div>
                       <div style="font-size: 0.9em; opacity: 0.9;">Dernier score</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #43e97b, #38f9d7); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold;" id="statProgression">--</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">Progression</div>
                    </div>
                </div>
        
                <!-- Graphique de progression -->
                <div style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 style="color: #2d3748; margin-bottom: 15px;">üìà √âvolution de ton score</h3>
                    <div id="progressionChart" style="height: 200px; display: flex; align-items: flex-end; justify-content: space-around; gap: 10px; padding: 10px 0;">
                        <p style="color: #a0aec0; text-align: center; width: 100%;">Effectue des analyses pour voir ta progression !</p>
                    </div>
                    <div id="chartLabels" style="display: flex; justify-content: space-around; margin-top: 10px; font-size: 0.8em; color: #718096;"></div>
                </div>
        
                <!-- Tendance -->
                <div id="trendSection" style="background: #f7fafc; border-radius: 15px; padding: 20px; margin-bottom: 20px; display: none;">
                    <h3 style="color: #2d3748; margin-bottom: 10px;">üéØ Tendance</h3>
                    <p id="trendMessage" style="color: #4a5568; font-size: 1.1em;"></p>
                </div>
        
                <!-- Historique des analyses -->
                <div style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 style="color: #2d3748; margin-bottom: 15px;">üìã Historique des analyses</h3>
                    <div id="analysisHistory" style="max-height: 300px; overflow-y: auto;">
                        <p style="color: #a0aec0; text-align: center;">Aucune analyse pour le moment</p>
                    </div>
                </div>
        
                <!-- Boutons d'action -->
                <button class="btn" onclick="showPhotoAI()" style="width: 100%; margin-bottom: 10px;">
                    <span>üì∏ Nouvelle Analyse IA</span>
                </button>
                <button class="btn" onclick="showCheckIn()" style="width: 100%; background: linear-gradient(135deg, #667eea, #764ba2);">
                    <span>Nouveau check-in</span>
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>

        <!-- Assistant IA -->
        <div class="section" id="ai-assistant">
            <div class="form-card">
                <h2 class="section-title">
                    <i class="fas fa-robot"></i>
                    Ton Assistant Personnel
                </h2>
                <div class="ai-welcome">
                    <div class="ai-avatar">‚ú®</div>
                    <h3>Salut ! Je suis ton coach beaut√© !</h3>
                    <p>J'analyse tes donn√©es pour te donner des conseils personnalis√©s et bienveillants.</p>
                </div>
                <div class="ai-sections">
                    <div class="ai-section" onclick="generateRecommendations()">
                        <div class="ai-section-icon">üéØ</div>
                        <h4>Recommandations Smart</h4>
                        <p>Produits parfaits pour TON type de peau</p>
                    </div>
                    <div class="ai-section" onclick="generatePredictions()">
                        <div class="ai-section-icon">üîÆ</div>
                        <h4>Pr√©dictions Futures</h4>
                        <p>Comment va √©voluer ta peau</p>
                    </div>
                    <div class="ai-section" onclick="generateInsights()">
                        <div class="ai-section-icon">üí°</div>
                        <h4>Insights Personnalis√©s</h4>
                        <p>Patterns cach√©s dans tes donn√©es</p>
                    </div>
                    <div class="ai-section" onclick="generateTips()">
                        <div class="ai-section-icon">‚ú®</div>
                        <h4>Conseils Adaptatifs</h4>
                        <p>Tips bas√©s sur tes habitudes</p>
                    </div>
                </div>
                <div class="ai-output" id="aiOutput">
                    <div class="ai-placeholder">
                        <i class="fas fa-magic"></i>
                        <p>S√©lectionne une option ci-dessus pour d√©couvrir mes analyses !</p>
                    </div>
                </div>
                <button class="btn" onclick="showPhotos()">
                    <span>Retour aux photos</span>
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>

        <!-- Check-in -->
<div class="section" id="checkin">
    <h2>üìù Check-in quotidien</h2>
    
    <!-- Carte Score Pr√©dit (toujours visible) -->
    <div id="predictedScoreCard" style="background: linear-gradient(135deg, #667eea22, #764ba222); border: 2px solid #667eea44; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: #4a5568;">üîÆ Score Pr√©dit</h3>
            <div id="predictedScoreValue" style="font-size: 2em; font-weight: bold; color: #667eea;">--</div>
        </div>
        <div id="predictedScoreMessage" style="text-align: center; padding: 10px; background: #667eea22; border-radius: 10px; margin-bottom: 15px; color: #4a5568;">
            Fais un check-in pour voir ton score pr√©dit !
        </div>
        <div id="predictedScoreFactors">
            <!-- Les facteurs s'afficheront ici -->
        </div>
    </div>
    
    <!-- Formulaire Check-in -->
    <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div class="form-group">
            <label for="checkinSkinCondition">√âtat de ta peau aujourd'hui (1-10) :</label>
            <input type="range" id="checkinSkinCondition" min="1" max="10" value="5" oninput="updateCheckinSkinDisplay()">
            <div style="text-align: center; margin-top: 10px;">
                <span id="checkinSkinDisplay">5 / 10</span>
            </div>
        </div>
        
        <div class="form-group">
            <label for="sleepHours">Heures de sommeil :</label>
            <input type="number" id="sleepHours" min="1" max="12" value="7" placeholder="7">
        </div>
        
        <div class="form-group">
            <label for="checkinStressLevel">Niveau de stress (1-10) :</label>
            <input type="range" id="checkinStressLevel" min="1" max="10" value="5" oninput="updateCheckinStressDisplay()">
            <div style="text-align: center; margin-top: 10px;">
                <span id="checkinStressDisplay">5 / 10</span>
            </div>
        </div>
        
        <button onclick="submitCheckIn()" style="width: 100%; margin-top: 15px;">Enregistrer mon check-in ‚úÖ</button>
    </div>
    
    <button onclick="returnToDashboard()" style="margin-top: 15px; width: 100%;">
        ‚Üê Retour au dashboard
    </button>
</div>

        <!-- CORRECTION 1: Section Cycle Tracker s√©par√©e et correctement structur√©e -->
        <div class="section" id="cycleTrackerSection">
            <div style="background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%); border-radius: 20px; padding: 30px; margin-bottom: 30px;">
                <h2 style="color: #880e4f; margin-bottom: 20px;">
                    üåô Cycle & Peau Tracker
                </h2>
                <p style="color: #ad1457; margin-bottom: 30px;">
                    Synchronise ta routine avec ton cycle hormonal
                </p>
                
                <!-- Configuration initiale -->
                <div id="cycleSetup" style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                    <h3 style="color: #2d3748; margin-bottom: 20px;">‚öôÔ∏è Configure ton cycle</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: #4a5568; margin-bottom: 8px;">
                            üìÖ Date de tes derni√®res r√®gles
                        </label>
                        <input type="date" id="lastPeriodDate" style="width: 100%; padding: 12px; border: 2px solid #fce4ec; border-radius: 10px;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; color: #4a5568; margin-bottom: 8px;">
                                üîÑ Dur√©e du cycle (jours)
                            </label>
                            <input type="number" id="cycleLength" value="28" min="21" max="35" 
                                   style="width: 100%; padding: 12px; border: 2px solid #fce4ec; border-radius: 10px;">
                        </div>
                        
                        <div>
                            <label style="display: block; color: #4a5568; margin-bottom: 8px;">
                                ü©∏ Dur√©e des r√®gles (jours)
                            </label>
                            <input type="number" id="periodDuration" value="5" min="2" max="8"
                                   style="width: 100%; padding: 12px; border: 2px solid #fce4ec; border-radius: 10px;">
                        </div>
                    </div>
                    
                    <button onclick="setupCycle()" 
                            style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ec407a 0%, #ad1457 100%); 
                                   color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer;">
                        Configurer mon cycle üåô
                    </button>
                </div>
                
                <!-- R√©sultats de l'analyse -->
                <div id="cycleAnalysis" style="display: none;">
                    <!-- Phase actuelle -->
                    <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                        <div id="currentPhaseDisplay"></div>
                    </div>
                    
                    <!-- Conseils peau -->
                    <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                        <h4 style="color: #2d3748; margin-bottom: 15px;">üí° Conseils pour ta peau</h4>
                        <div id="skinTipsDisplay"></div>
                    </div>
                    
                    <!-- Produits recommand√©s -->
                    <div style="background: white; border-radius: 15px; padding: 25px;">
                        <h4 style="color: #2d3748; margin-bottom: 15px;">üß¥ Routine adapt√©e</h4>
                        <div id="productRecommendationsDisplay"></div>
                    </div>
                </div>
            </div>
            
            <!-- Bouton retour au dashboard -->
            <button onclick="returnToDashboard()">
                ‚Üê Retour au dashboard
            </button>
        </div>

    </div>
        <!-- Section Mood Tracker & Psycho-dermatologie -->
<div class="section" id="moodTrackerSection">
    <div style="background: linear-gradient(135deg, #f5f3ff 0%, #e8e5ff 100%); border-radius: 20px; padding: 30px; margin-bottom: 30px;">
        <h2 style="color: #6c5ce7; margin-bottom: 20px;">
            üß† Mood & Psycho-dermatologie
        </h2>
        <p style="color: #5f3dc4; margin-bottom: 30px;">
            D√©couvre comment tes √©motions influencent ta peau
        </p>
        
        <!-- Mood Check-in du jour -->
        <div id="moodCheckIn" style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px;">
            <h3 style="color: #2d3748; margin-bottom: 20px;">üí≠ Comment te sens-tu aujourd'hui ?</h3>
            
            <!-- S√©lection d'humeur -->
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 25px;">
                <div class="mood-option" onclick="selectMood('tr√®s mal', 'üò¢', this)" style="text-align: center; padding: 15px; border: 2px solid #f0f0f0; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                    <div style="font-size: 2.5em;">üò¢</div>
                    <div style="font-size: 0.85em; color: #718096; margin-top: 5px;">Tr√®s mal</div>
                </div>
                <div class="mood-option" onclick="selectMood('mal', 'üòî', this)" style="text-align: center; padding: 15px; border: 2px solid #f0f0f0; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                    <div style="font-size: 2.5em;">üòî</div>
                    <div style="font-size: 0.85em; color: #718096; margin-top: 5px;">Mal</div>
                </div>
                <div class="mood-option" onclick="selectMood('neutre', 'üòê', this)" style="text-align: center; padding: 15px; border: 2px solid #f0f0f0; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                    <div style="font-size: 2.5em;">üòê</div>
                    <div style="font-size: 0.85em; color: #718096; margin-top: 5px;">Neutre</div>
                </div>
                <div class="mood-option" onclick="selectMood('bien', 'üòä', this)" style="text-align: center; padding: 15px; border: 2px solid #f0f0f0; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                    <div style="font-size: 2.5em;">üòä</div>
                    <div style="font-size: 0.85em; color: #718096; margin-top: 5px;">Bien</div>
                </div>
                <div class="mood-option" onclick="selectMood('tr√®s bien', 'üòÑ', this)" style="text-align: center; padding: 15px; border: 2px solid #f0f0f0; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                    <div style="font-size: 2.5em;">üòÑ</div>
                    <div style="font-size: 0.85em; color: #718096; margin-top: 5px;">Tr√®s bien</div>
                </div>
            </div>
            
            <!-- Facteurs √©motionnels -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #4a5568; margin-bottom: 10px; font-weight: 500;">
                    üí§ Qualit√© du sommeil (1-10)
                </label>
                <input type="range" id="sleepQuality" min="1" max="10" value="5" 
                       style="width: 100%; margin-bottom: 5px;"
                       oninput="document.getElementById('sleepQualityDisplay').textContent = this.value + '/10'">
                <div style="text-align: center; color: #718096;">
                    <span id="sleepQualityDisplay">5/10</span>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #4a5568; margin-bottom: 10px; font-weight: 500;">
                    üò∞ Niveau d'anxi√©t√© (1-10)
                </label>
                <input type="range" id="anxietyLevel" min="1" max="10" value="5"
                       style="width: 100%; margin-bottom: 5px;"
                       oninput="document.getElementById('anxietyDisplay').textContent = this.value + '/10'">
                <div style="text-align: center; color: #718096;">
                    <span id="anxietyDisplay">5/10</span>
                </div>
            </div>
            
            <!-- √âv√©nements d√©clencheurs -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #4a5568; margin-bottom: 10px; font-weight: 500;">
                       üìù √âv√©nements marquants aujourd'hui
                </label>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                <button class="trigger-btn" onclick="toggleTrigger('travail stressant', this)" 
                        style="padding: 10px 15px; border: 2px solid #e2e8f0; background: white; 
                               border-radius: 10px; cursor: pointer; transition: all 0.3s; text-align: center;
                               color: #4a5568; font-size: 0.95em;">Travail stressant</button>
                <button class="trigger-btn" onclick="toggleTrigger('conflit relationnel', this)"
                        style="padding: 10px 15px; border: 2px solid #e2e8f0; background: white; 
                               border-radius: 10px; cursor: pointer; transition: all 0.3s; text-align: center;
                               color: #4a5568; font-size: 0.95em;">Conflit relationnel</button>
                <button class="trigger-btn" onclick="toggleTrigger('fatigue intense', this)"
                        style="padding: 10px 15px; border: 2px solid #e2e8f0; background: white; 
                               border-radius: 10px; cursor: pointer; transition: all 0.3s; text-align: center;
                               color: #4a5568; font-size: 0.95em;">Fatigue intense</button>
                <button class="trigger-btn" onclick="toggleTrigger('p√©riode menstruelle', this)"
                        style="padding: 10px 15px; border: 2px solid #e2e8f0; background: white; 
                               border-radius: 10px; cursor: pointer; transition: all 0.3s; text-align: center;
                               color: #4a5568; font-size: 0.95em;">P√©riode menstruelle</button>
                <button class="trigger-btn" onclick="toggleTrigger('activit√© sportive', this)"
                        style="padding: 10px 15px; border: 2px solid #e2e8f0; background: white; 
                               border-radius: 10px; cursor: pointer; transition: all 0.3s; text-align: center;
                               color: #4a5568; font-size: 0.95em;">Activit√© sportive</button>
                <button class="trigger-btn" onclick="toggleTrigger('moment de joie', this)"
                        style="padding: 10px 15px; border: 2px solid #e2e8f0; background: white; 
                               border-radius: 10px; cursor: pointer; transition: all 0.3s; text-align: center;
                               color: #4a5568; font-size: 0.95em;">Moment de joie</button>
                <button class="trigger-btn" onclick="toggleTrigger('stress examens', this)"
                        style="padding: 10px 15px; border: 2px solid #e2e8f0; background: white; 
                               border-radius: 10px; cursor: pointer; transition: all 0.3s; text-align: center;
                               color: #4a5568; font-size: 0.95em;">Stress examens</button>
                <button class="trigger-btn" onclick="toggleTrigger('sortie sociale', this)"
                        style="padding: 10px 15px; border: 2px solid #e2e8f0; background: white; 
                               border-radius: 10px; cursor: pointer; transition: all 0.3s; text-align: center;
                               color: #4a5568; font-size: 0.95em;">Sortie sociale</button>
                </div>
            </div>
            
            <button onclick="saveMoodCheckIn()" 
                    style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                           color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer;">
                Enregistrer mon mood check-in üíú
            </button>
        </div>
        
        <!-- Analyse de corr√©lation -->
        <div id="moodAnalysis" style="display: none;">
            <!-- Graphique de corr√©lation -->
            <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                <h4 style="color: #2d3748; margin-bottom: 15px;">üìä Corr√©lation Humeur-Peau (7 derniers jours)</h4>
                <div id="correlationChart" style="min-height: 200px;">
                    <!-- Graphique simplifi√© -->
                </div>
            </div>
            
            <!-- Insights psycho-dermatologiques -->
            <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                <h4 style="color: #2d3748; margin-bottom: 15px;">üî¨ Tes patterns psycho-dermatologiques</h4>
                <div id="psychoDermaInsights"></div>
            </div>
            
            <!-- Recommandations holistiques -->
            <div style="background: white; border-radius: 15px; padding: 25px;">
                <h4 style="color: #2d3748; margin-bottom: 15px;">‚ú® Routine mind-skin adapt√©e</h4>
                <div id="holisticRecommendations"></div>
            </div>
        </div>
    </div>
    
    <!-- Bouton retour au dashboard -->
    <button onclick="returnToDashboard()">
        ‚Üê Retour au dashboard
    </button>
</div>
<!-- Section Analyseur INCI -->
<div class="section" id="ingredientAnalyzerSection">
    <div style="background: linear-gradient(135deg, #e8f5f0 0%, #d4edda 100%); border-radius: 20px; padding: 30px; margin-bottom: 30px;">
        <h2 style="color: #00695c; margin-bottom: 20px;">
            üî¨ Analyseur d'ingr√©dients INCI
        </h2>
        <p style="color: #004d40; margin-bottom: 30px;">
            Analyse scientifique de tes produits cosm√©tiques
        </p>
        
        <!-- Zone d'analyse -->
        <div id="ingredientInput" style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px;">
            <h3 style="color: #2d3748; margin-bottom: 20px;">üìù Entre la liste INCI de ton produit</h3>
            
            <textarea id="inciListInput" 
                     placeholder="Exemple: Aqua, Glycerin, Niacinamide, Sodium Hyaluronate, Retinol..."
                     style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #e0f2f1; 
                            border-radius: 10px; font-size: 14px; resize: vertical;">
            </textarea>
            
            <button onclick="analyzeProductIngredients()" 
                    style="width: 100%; margin-top: 15px; padding: 15px; 
                           background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); 
                           color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer;">
                Analyser les ingr√©dients üîç
            </button>
        </div>

        
        <!-- R√©sultats de l'analyse -->
        <div id="analysisResults" style="display: none;">
            <!-- Les r√©sultats appara√Ætront ici -->
        </div>
    </div>
    
    <!-- Bouton retour -->
    <button onclick="returnToDashboard()">
        ‚Üê Retour au dashboard
    </button>
</div>
<!-- Section Analyse Photo IA v2 -->
<div class="section" id="photoAISection">
    <!-- Header avec bouton retour -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; gap: 20px;">
        <h2 style="color: #d35400; margin: 0; flex-shrink: 0;">
            üì∏ Analyse Photo IA v2
        </h2>
        <button onclick="returnToPhotos()" style="position: absolute; top: 22px; right: 20px; padding: 8px 15px; background: linear-gradient(135deg, #FF6B9D, #C44569); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; width: auto;">
            ‚Üê Return to Photos
        </button>
    </div>

    <!-- Guide de prise de photo -->
    <div id="photoGuide" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 15px; padding: 25px; margin-bottom: 20px; border: 2px solid #81c784;">
        <h3 style="color: #2e7d32; margin-bottom: 20px; text-align: center;">üì∏ Comment prendre une photo id√©ale ?</h3>
    
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <!-- Conseil 1 -->
            <div style="background: white; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="font-size: 2em; margin-bottom: 8px;">üí°</div>
                <div style="font-weight: bold; color: #2e7d32; margin-bottom: 5px;">Lumi√®re naturelle</div>
                <div style="font-size: 0.8em; color: #666;">Pr√®s d'une fen√™tre, pas de flash</div>
            </div>
        
            <!-- Conseil 2 -->
            <div style="background: white; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="font-size: 2em; margin-bottom: 8px;">üë§</div>
                <div style="font-weight: bold; color: #2e7d32; margin-bottom: 5px;">Visage de face</div>
                <div style="font-size: 0.8em; color: #666;">Bien centr√©, regard vers la cam√©ra</div>
            </div>
        
            <!-- Conseil 3 -->
            <div style="background: white; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="font-size: 2em; margin-bottom: 8px;">üìè</div>
                <div style="font-weight: bold; color: #2e7d32; margin-bottom: 5px;">Distance 30cm</div>
                <div style="font-size: 0.8em; color: #666;">Ni trop pr√®s, ni trop loin</div>
            </div>
        
            <!-- Conseil 4 -->
            <div style="background: white; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="font-size: 2em; margin-bottom: 8px;">üß¥</div>
                <div style="font-weight: bold; color: #2e7d32; margin-bottom: 5px;">Sans maquillage</div>
                <div style="font-size: 0.8em; color: #666;">Visage propre et sec</div>
            </div>
        </div>
    
        <!-- Ce qu'il faut √©viter -->
        <div style="background: #ffebee; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
            <div style="font-weight: bold; color: #c62828; margin-bottom: 10px;">‚ùå √Ä √©viter :</div>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; font-size: 0.85em; color: #b71c1c;">
                <span style="background: white; padding: 5px 10px; border-radius: 5px;">Lumi√®re jaune/orange</span>
                <span style="background: white; padding: 5px 10px; border-radius: 5px;">Filtres Instagram</span>
                <span style="background: white; padding: 5px 10px; border-radius: 5px;">Photo floue</span>
                <span style="background: white; padding: 5px 10px; border-radius: 5px;">Ombres sur le visage</span>
            </div>
        </div>
    
        <p style="text-align: center; color: #2e7d32; font-size: 0.9em; margin: 0;">
            ‚úÖ Une bonne photo = une analyse pr√©cise = une progression r√©aliste !
        </p>
    </div>

    <!-- Zone d'upload -->
    <div id="uploadZone" style="background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px; text-align: center;">
        <h3 style="color: #2d3748; margin-bottom: 20px;">üì∑ Uploader une photo de votre visage</h3>
        <p style="color: #718096; margin-bottom: 20px;">L'IA analysera votre peau en d√©tail et vous donnera des recommandations personnalis√©es</p>
    
        <input type="file" id="photoInputV2" accept="image/*" style="display: none;" onchange="handlePhotoUploadV2(event)">
    
        <button onclick="document.getElementById('photoInputV2').click()" 
                style="padding: 15px 30px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px;">
            üìÅ Choisir une photo
        </button>
    
        <p style="color: #a0aec0; font-size: 0.9em; margin-top: 15px;">Formats accept√©s : JPG, PNG, WebP ‚Ä¢ Max 10 MB</p>
    </div>

    <!-- Zone d'erreur de validation (cach√©e par d√©faut) -->
    <div id="validationErrorZone" style="display: none; background: #ffebee; border: 2px solid #ef5350; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
        <h3 style="color: #c62828; margin-bottom: 15px;">‚ùå Photo non conforme</h3>
        <p style="color: #b71c1c; margin-bottom: 15px;">Votre photo ne peut pas √™tre analys√©e pour les raisons suivantes :</p>
        <ul id="validationErrorList" style="color: #c62828; margin-bottom: 20px; padding-left: 20px;"></ul>
        <button onclick="retryPhoto()" 
                style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 14px;">
            üì∏ Reprendre une photo
        </button>
    </div>

    <!-- Zone d'avertissements (cach√©e par d√©faut) -->
    <div id="validationWarningZone" style="display: none; background: #fff8e1; border: 2px solid #ffb300; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
        <h3 style="color: #ff8f00; margin-bottom: 10px;">‚ö†Ô∏è Avertissement</h3>
        <ul id="validationWarningList" style="color: #f57c00; margin-bottom: 15px; padding-left: 20px;"></ul>
        <p style="color: #ff8f00; font-size: 0.9em; margin: 0;">L'analyse va continuer, mais les r√©sultats pourraient √™tre moins pr√©cis.</p>
    </div>

    <!-- Zone de pr√©visualisation -->
    <div id="previewZoneV2" style="display: none; background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
        <h3 style="color: #2d3748; margin-bottom: 15px;">Aper√ßu de votre photo</h3>
        <div style="text-align: center; margin-bottom: 15px;">
            <img id="previewImageV2" style="max-width: 100%; max-height: 400px; border-radius: 10px; border: 2px solid #e2e8f0;">
        </div>
        <button onclick="analyzePhotoV2()" 
                style="width: 100%; padding: 15px; background: linear-gradient(135deg, #f39c12, #e74c3c); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold;">
            üîç Lancer l'analyse IA
        </button>
    </div>

    <!-- Loading -->
    <div id="analysisLoadingV2" style="display: none; background: white; border-radius: 15px; padding: 40px; text-align: center;">
        <div style="font-size: 3em; margin-bottom: 20px;">üîÑ</div>
        <h3 style="color: #2d3748; margin-bottom: 10px;">Analyse en cours...</h3>
        <p style="color: #718096;">L'IA analyse votre peau en profondeur (5-10 secondes)</p>
        <div style="width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; margin-top: 20px; overflow: hidden;">
            <div style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 3px; animation: loading 2s infinite;"></div>
        </div>
    </div>

    <!-- R√©sultats de l'analyse -->
    <div id="analysisResultsV2" style="display: none;">
        <!-- Score global -->
        <div style="background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 15px; padding: 30px; margin-bottom: 20px; text-align: center; color: white;">
            <div style="font-size: 4em; font-weight: bold; margin-bottom: 10px;" id="globalScoreDisplay">--</div>
            <div style="font-size: 1.2em; margin-bottom: 5px;">Score Global de Sant√©</div>
            <div style="font-size: 0.9em; opacity: 0.9;" id="healthStatusDisplay">--</div>
        </div>

        <!-- Heatmap -->
        <div style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
            <h3 style="color: #2d3748; margin-bottom: 15px;">üó∫Ô∏è Carte des Zones Analys√©es</h3>
            <div style="text-align: center;">
                <img id="heatmapImage" style="max-width: 100%; border-radius: 10px; border: 2px solid #e2e8f0;">
            </div>
            <p style="color: #718096; font-size: 0.9em; margin-top: 10px; text-align: center;">
                Les zones color√©es indiquent l'√©tat de sant√© : üü¢ Excellent ‚Ä¢ üü° Bon ‚Ä¢ üü† Moyen ‚Ä¢ üî¥ Attention
            </p>
        </div>

        <!-- Diagnostic g√©n√©ral -->
        <div id="diagnosisSection" style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
            <h3 style="color: #2d3748; margin-bottom: 15px;" id="diagnosisTitle">--</h3>
            <p style="color: #4a5568; line-height: 1.6;" id="diagnosisMessage">--</p>
        </div>

        <!-- Analyse par zone (Accord√©on) -->
        <div style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
            <h3 style="color: #2d3748; margin-bottom: 15px;">üìã Analyse D√©taill√©e par Zone</h3>
            <div id="zonesAccordion"></div>
        </div>

        <!-- Routine personnalis√©e -->
        <div style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
            <h3 style="color: #2d3748; margin-bottom: 20px;">üíÜ‚Äç‚ôÄÔ∏è Routine Personnalis√©e</h3>
            
            <!-- Routine matin -->
            <div style="margin-bottom: 30px;">
                <h4 style="color: #f39c12; margin-bottom: 15px;">‚òÄÔ∏è Routine Matinale</h4>
                <div id="morningRoutine"></div>
            </div>
            
            <!-- Routine soir -->
            <div>
                <h4 style="color: #764ba2; margin-bottom: 15px;">üåô Routine du Soir</h4>
                <div id="eveningRoutine"></div>
            </div>
        </div>

        <!-- Conseils g√©n√©raux -->
        <div style="background: linear-gradient(135deg, #fff5e6, #ffe0cc); border-radius: 15px; padding: 20px;">
            <h3 style="color: #d35400; margin-bottom: 15px;">üí° Conseils pour une Peau Saine</h3>
            <div id="generalTips"></div>
        </div>
    </div>

    <!-- Avertissement m√©dical -->
    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 15px; margin-top: 20px;">
        <p style="color: #856404; font-size: 0.85em; margin: 0;">
            <strong>‚ö†Ô∏è Avertissement :</strong> Cette analyse IA est fournie √† titre informatif uniquement et ne remplace pas un diagnostic m√©dical professionnel. En cas de probl√®mes de peau persistants ou graves, consultez un dermatologue.
        </p>
    </div>
</div>

<style>
@keyframes loading {
    0% { width: 0%; }
    50% { width: 70%; }
    100% { width: 100%; }
}

.zone-accordion-item {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin-bottom: 10px;
    overflow: hidden;
}

.zone-accordion-header {
    padding: 15px;
    background: #f7fafc;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.3s;
}

.zone-accordion-header:hover {
    background: #edf2f7;
}

.zone-accordion-content {
    padding: 15px;
    display: none;
    background: white;
}

.zone-accordion-content.active {
    display: block;
}

.routine-step {
    display: flex;
    gap: 15px;
    padding: 15px;
    background: #f7fafc;
    border-radius: 8px;
    margin-bottom: 10px;
}

.routine-step-number {
    width: 30px;
    height: 30px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
}

.routine-step-content {
    flex: 1;
}

.tip-item {
    padding: 10px 15px;
    background: white;
    border-radius: 8px;
    margin-bottom: 8px;
    border-left: 3px solid #d35400;
}
</style>

<script>
let currentPhotoFileV2 = null;

function handlePhotoUploadV2(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    currentPhotoFileV2 = file;
    
    // Afficher la pr√©visualisation
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('previewImageV2').src = e.target.result;
        document.getElementById('previewZoneV2').style.display = 'block';
        document.getElementById('analysisResultsV2').style.display = 'none';
    };
    reader.readAsDataURL(file);
}

async function analyzePhotoV2() {
    if (!currentPhotoFileV2) {
        alert('Veuillez s√©lectionner une photo');
        return;
    }
    
    // Masquer toutes les zones
    document.getElementById('previewZoneV2').style.display = 'none';
    document.getElementById('analysisResultsV2').style.display = 'none';
    document.getElementById('validationErrorZone').style.display = 'none';
    document.getElementById('validationWarningZone').style.display = 'none';
    
    // Afficher loading
    document.getElementById('analysisLoadingV2').style.display = 'block';
    
    try {
        // Pr√©parer les donn√©es
        const formData = new FormData();
        formData.append('photo', currentPhotoFileV2);

        // Ajouter le user_id si l'utilisateur est connect√©
        const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
        if (currentUser.id) {
            formData.append('user_id', currentUser.id);
        }
        
        // Appeler l'API v2
        const response = await fetch('http://127.0.0.1:8000/api/v2/analyze-skin', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        console.log('üì• R√©ponse API:', data);
        
        // Masquer loading
        document.getElementById('analysisLoadingV2').style.display = 'none';
        
        // V√©rifier si la validation a √©chou√©
        if (data.success === false && data.errors && data.errors.length > 0) {
            console.log('‚ùå Validation √©chou√©e:', data.errors);
            displayValidationErrors(data.errors);
            return;
        }
        
        // V√©rifier s'il y a des avertissements
        if (data.validation && data.validation.warnings && data.validation.warnings.length > 0) {
            console.log('‚ö†Ô∏è Avertissements:', data.validation.warnings);
            displayValidationWarnings(data.validation.warnings);
        }
        
        // V√©rifier si l'analyse a r√©ussi
        if (!response.ok) {
            throw new Error(`Erreur ${response.status}: ${JSON.stringify(data)}`);
        }
        
        console.log('‚úÖ Analyse r√©ussie:', data);
        
        // Afficher les r√©sultats
        displayAnalysisResultsV2(data);
        
    } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('analysisLoadingV2').style.display = 'none';
        
        // Afficher l'erreur de mani√®re conviviale
        const errorZone = document.getElementById('validationErrorZone');
        const errorList = document.getElementById('validationErrorList');
        errorList.innerHTML = `<li>Une erreur technique s'est produite. Veuillez r√©essayer.</li>`;
        errorZone.style.display = 'block';
    }
}

// Fonction pour afficher les erreurs de validation
function displayValidationErrors(errors) {
    const errorZone = document.getElementById('validationErrorZone');
    const errorList = document.getElementById('validationErrorList');
    
    // Vider la liste
    errorList.innerHTML = '';
    
    // Ajouter chaque erreur
    errors.forEach(error => {
        const li = document.createElement('li');
        li.textContent = error;
        li.style.marginBottom = '8px';
        errorList.appendChild(li);
    });
    
    // Afficher la zone d'erreur
    errorZone.style.display = 'block';
    
    // Afficher aussi la zone d'upload pour reprendre une photo
    document.getElementById('uploadZone').style.display = 'block';
}

// Fonction pour afficher les avertissements
function displayValidationWarnings(warnings) {
    const warningZone = document.getElementById('validationWarningZone');
    const warningList = document.getElementById('validationWarningList');
    
    // Vider la liste
    warningList.innerHTML = '';
    
    // Ajouter chaque avertissement
    warnings.forEach(warning => {
        const li = document.createElement('li');
        li.textContent = warning;
        li.style.marginBottom = '8px';
        warningList.appendChild(li);
    });
    
    // Afficher la zone d'avertissement
    warningZone.style.display = 'block';
}

// Fonction pour reprendre une photo
function retryPhoto() {
    // Masquer les zones d'erreur
    document.getElementById('validationErrorZone').style.display = 'none';
    document.getElementById('validationWarningZone').style.display = 'none';
    
    // R√©initialiser le fichier
    currentPhotoFileV2 = null;
    document.getElementById('photoInputV2').value = '';
    
    // Afficher la zone d'upload
    document.getElementById('uploadZone').style.display = 'block';
    document.getElementById('previewZoneV2').style.display = 'none';
    
    // Scroll vers le haut
    window.scrollTo(0, 0);
}

function displayAnalysisResultsV2(data) {
    // üîç LOG DE DEBUG - Voir les donn√©es ML
    console.log('=== DONN√âES RE√áUES ===');
    console.log('ml_enhanced:', data.ml_enhanced);
    console.log('ml_confidence:', data.ml_confidence);
    console.log('ml_detected_issues:', data.ml_detected_issues);
    console.log('data complet:', data);
    console.log('====================');
    // Afficher la section r√©sultats
    document.getElementById('analysisResultsV2').style.display = 'block';
    
    // Score global
    document.getElementById('globalScoreDisplay').textContent = data.global_score + '/100';
    document.getElementById('healthStatusDisplay').textContent = getHealthStatusText(data.overall_health);
    
    // Heatmap
    document.getElementById('heatmapImage').src = 'data:image/jpeg;base64,' + data.heatmap.image_base64;
    
    // ‚ú® NOUVEAU : Afficher le badge ML si l'analyse utilise l'IA
    const diagnosisContainer = document.getElementById('diagnosisContainer') || 
                               document.getElementById('diagnosisTitle').parentElement;
    
    if (data.ml_enhanced) {
        // Badge ML
        const mlBadge = document.createElement('div');
        mlBadge.innerHTML = `
            <div style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                        color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; 
                        margin-bottom: 20px; font-weight: 600; box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);">
                ü§ñ Analyse par Intelligence Artificielle
                <span style="opacity: 0.95; font-size: 13px; margin-left: 10px; 
                           background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px;">
                    ‚úÖ Confiance ML : ${(data.ml_confidence * 100).toFixed(0)}%
                </span>
            </div>
        `;
        diagnosisContainer.insertBefore(mlBadge, diagnosisContainer.firstChild);
        
        // ‚ú® NOUVEAU : Afficher les probl√®mes d√©tect√©s par ML
        if (data.ml_detected_issues && data.ml_detected_issues.length > 0) {
            const mlIssuesSection = document.createElement('div');
            mlIssuesSection.style.cssText = 'background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;';
            
            let issuesHTML = '<h3 style="color: #2d3748; margin-bottom: 15px; font-size: 18px;">üéØ Probl√®mes d√©tect√©s par IA</h3>';
            
            data.ml_detected_issues.forEach(issue => {
                // Emoji selon le type
                const emoji = {
                    'Acn√©': 'üî¥',
                    'Rougeurs': 'üü†',
                    'Hyperpigmentation': 'üü§',
                    'Rides fines': 'üü°',
                    'Pores dilat√©s': '‚ö™'
                }[issue.type] || 'üîµ';
                
                // √âtoiles selon la confiance
                const stars = '‚≠ê'.repeat(Math.ceil(issue.confidence * 4));
                
                // Couleur selon la s√©v√©rit√©
                const severityColor = {
                    'L√©g√®re': '#48bb78',
                    'Mod√©r√©e': '#ed8936',
                    'S√©v√®re': '#f56565'
                }[issue.severity] || '#718096';
                
                issuesHTML += `
                    <div style="background: white; border-left: 4px solid ${severityColor}; 
                                padding: 16px; border-radius: 10px; margin-bottom: 12px; 
                                box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.2s;"
                         onmouseover="this.style.transform='translateX(4px)'" 
                         onmouseout="this.style.transform='translateX(0)'">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <span style="font-size: 22px; margin-right: 10px;">${emoji}</span>
                                <strong style="color: #2d3748; font-size: 17px;">${issue.type}</strong>
                                <span style="background: ${severityColor}; color: white; padding: 3px 10px; 
                                             border-radius: 14px; font-size: 12px; margin-left: 10px; font-weight: 600;">
                                    ${issue.severity}
                                </span>
                            </div>
                            <div style="text-align: right; min-width: 80px;">
                                <div style="font-size: 11px; color: #718096; text-transform: uppercase; letter-spacing: 0.5px;">Confiance</div>
                                <div style="font-weight: 700; color: #2d3748; font-size: 18px;">${(issue.confidence * 100).toFixed(0)}%</div>
                                <div style="font-size: 14px; margin-top: 2px;">${stars}</div>
                            </div>
                        </div>
                        <div style="color: #4a5568; font-size: 14px; display: flex; align-items: center;">
                            <span style="margin-right: 6px;">üìç</span>
                            <span style="font-weight: 500;">Zones :</span>
                            <span style="margin-left: 6px;">${issue.zones.join(', ')}</span>
                        </div>
                    </div>
                `;
            });
            
            mlIssuesSection.innerHTML = issuesHTML;
            diagnosisContainer.insertBefore(mlIssuesSection, diagnosisContainer.firstChild);
        }
    }
    
    // Diagnostic (original)
    document.getElementById('diagnosisTitle').textContent = data.diagnosis.title;
    document.getElementById('diagnosisMessage').textContent = data.diagnosis.message;
    
    // Zones (accord√©on)
    displayZonesAccordion(data.zones_analysis);
    
    // Routine
    displayRoutine(data.routine);
    
    // Conseils
    displayTips(data.tips);
    
    // Scroll vers les r√©sultats
    document.getElementById('analysisResultsV2').scrollIntoView({ behavior: 'smooth' });
}

function getHealthStatusText(status) {
    const statusMap = {
        'excellent': '‚ú® Excellente sant√© !',
        'good': 'üòä Bonne sant√©',
        'needs_improvement': '‚ö†Ô∏è Am√©lioration n√©cessaire',
        'needs_attention': 'üö® Attention requise'
    };
    return statusMap[status] || status;
}

function displayZonesAccordion(zones) {
    const accordion = document.getElementById('zonesAccordion');
    accordion.innerHTML = '';
    
    zones.forEach((zone, index) => {
        const item = document.createElement('div');
        item.className = 'zone-accordion-item';
        
        const scoreColor = zone.score >= 85 ? '#48bb78' : zone.score >= 70 ? '#ecc94b' : zone.score >= 55 ? '#ed8936' : '#f56565';
        
        item.innerHTML = `
            <div class="zone-accordion-header" onclick="toggleAccordion(${index})">
                <div>
                    <strong>${zone.zone}</strong>
                    <span style="color: ${scoreColor}; font-weight: bold; margin-left: 10px;">${zone.score}/100</span>
                </div>
                <span id="accordion-icon-${index}">‚ñº</span>
            </div>
            <div class="zone-accordion-content" id="accordion-content-${index}">
                <div style="margin-bottom: 15px;">
                    <strong style="color: #2d3748;">Probl√®mes d√©tect√©s :</strong>
                    ${zone.problems.length > 0 ? 
                        '<ul style="margin: 10px 0; padding-left: 20px;">' + 
                        zone.problems.map(p => `<li style="color: #4a5568; margin: 5px 0;">${p}</li>`).join('') + 
                        '</ul>' 
                        : '<p style="color: #48bb78; margin: 10px 0;">‚úì Aucun probl√®me d√©tect√©</p>'}
                </div>
                ${zone.recommendations.length > 0 ? `
                    <div>
                        <strong style="color: #2d3748;">Recommandations :</strong>
                        ${zone.recommendations.map(rec => `
                            <div style="background: #f7fafc; padding: 10px; border-radius: 8px; margin: 10px 0;">
                                <strong style="color: #667eea;">${rec.title}</strong>
                                <ul style="margin: 5px 0; padding-left: 20px;">
                                    ${rec.actions.map(action => `<li style="color: #4a5568; margin: 3px 0;">${action}</li>`).join('')}
                                </ul>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `;
        
        accordion.appendChild(item);
    });
}

function toggleAccordion(index) {
    const content = document.getElementById(`accordion-content-${index}`);
    const icon = document.getElementById(`accordion-icon-${index}`);
    
    content.classList.toggle('active');
    icon.textContent = content.classList.contains('active') ? '‚ñ≤' : '‚ñº';
}

function displayRoutine(routine) {
    // Routine matin
    const morningDiv = document.getElementById('morningRoutine');
    morningDiv.innerHTML = routine.morning.map(step => `
        <div class="routine-step">
            <div class="routine-step-number">${step.step}</div>
            <div class="routine-step-content">
                <strong style="color: #2d3748;">${step.name}</strong>
                <p style="color: #718096; margin: 5px 0 0 0;">${step.description}</p>
                <small style="color: #a0aec0;">‚è±Ô∏è ${step.duration}</small>
            </div>
        </div>
    `).join('');
    
    // Routine soir
    const eveningDiv = document.getElementById('eveningRoutine');
    eveningDiv.innerHTML = routine.evening.map(step => `
        <div class="routine-step">
            <div class="routine-step-number">${step.step}</div>
            <div class="routine-step-content">
                <strong style="color: #2d3748;">${step.name}</strong>
                <p style="color: #718096; margin: 5px 0 0 0;">${step.description}</p>
                <small style="color: #a0aec0;">‚è±Ô∏è ${step.duration}</small>
            </div>
        </div>
    `).join('');
}

function displayTips(tips) {
    const tipsDiv = document.getElementById('generalTips');
    tipsDiv.innerHTML = tips.map(tip => `
        <div class="tip-item">
            <span style="color: #4a5568;">${tip}</span>
        </div>
    `).join('');
}
</script>
<!-- Modal Premium -->
<div id="premiumModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                               background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; margin: 20px;">
        <h3 style="color: #6c5ce7; margin-bottom: 20px;">üåü Passez √† Premium</h3>
        <p style="color: #4a5568; margin-bottom: 20px;">
            Vous avez utilis√© vos 3 analyses gratuites ce mois.
        </p>
        <div style="background: linear-gradient(135deg, #f5f3ff, #e8e5ff); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
            <h4 style="color: #5f3dc4; margin-bottom: 15px;">Premium inclut :</h4>
            <ul style="color: #6c5ce7; font-size: 0.95em;">
                <li>‚úÖ Analyses INCI illimit√©es</li>
                <li>‚úÖ Base de donn√©es compl√®te (500+ ingr√©dients)</li>
                <li>‚úÖ Rapports PDF mensuels</li>
                <li>‚úÖ Recommandations personnalis√©es avanc√©es</li>
                <li>‚úÖ Analyse photo IA</li>
            </ul>
        </div>
        <button onclick="subscribePremium()" 
                style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea, #764ba2);
                       color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer;">
            Commencer l'essai gratuit 7 jours
        </button>
        <button onclick="closePremiumModal()" 
                style="width: 100%; margin-top: 10px; padding: 12px; background: transparent;
                       color: #718096; border: 1px solid #e2e8f0; border-radius: 10px; cursor: pointer;">
            Plus tard
        </button>
    </div>
</div>
<!-- Section Paiement -->
<div id="paymentSection" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                                background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;">
    <div style="background: white; border-radius: 20px; padding: 20px; max-width: 600px; margin: 20px auto; position: relative;">
        <h2 style="color: #6c5ce7; margin-bottom: 15px; text-align: center; font-size: 1.5em;">‚ú® Passe √† DailyGlow Premium</h2>
        
        <p style="text-align: center; color: #718096; margin-bottom: 20px;">D√©bloquez toutes les fonctionnalit√©s pour r√©v√©ler votre √©clat !</p>
        
        <!-- Plans -->
        <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
            <!-- Plan Mensuel -->
            <div style="flex: 1; min-width: 250px; max-width: 280px; border: 2px solid #e0e7ff; border-radius: 15px; padding: 15px;">
                <h3 style="color: #2d3748; margin: 10px 0; font-size: 1em;">Mensuel</h3>
                <div style="font-size: 2em; color: #667eea; margin: 10px 0;">
                    4.99‚Ç¨<span style="font-size: 0.4em; color: #718096;">/mois</span>
                </div>
                <ul style="list-style: none; padding: 0; margin: 10px 0; font-size: 0.8em; color: #4a5568;">
                    <li style="margin: 8px 0;">‚úÖ Analyses photo IA illimit√©es</li>
                    <li style="margin: 8px 0;">‚úÖ Check-ins illimit√©s</li>
                    <li style="margin: 8px 0;">‚úÖ Score pr√©dit avanc√©</li>
                    <li style="margin: 8px 0;">‚úÖ Comparaison avant/apr√®s</li>
                    <li style="margin: 8px 0;">‚úÖ Historique complet</li>
                </ul>
                <button onclick="initiatePaddleCheckout('monthly')" 
                        style="width: 100%; padding: 12px; background: #667eea;
                               color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    Choisir Mensuel
                </button>
            </div>
            
            <!-- Plan Annuel -->
            <div style="flex: 1; min-width: 250px; max-width: 280px; border: 2px solid #667eea; border-radius: 15px; padding: 15px; position: relative;">
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; text-align: center; padding: 5px 10px; border-radius: 20px; position: absolute; top: -12px; left: 50%; transform: translateX(-50%);">
                    <span style="font-weight: bold; font-size: 0.75em;">üéâ -50% √âCONOMIE</span>
                </div>
                <h3 style="color: #2d3748; margin: 15px 0 10px; font-size: 1em;">Annuel</h3>
                <div style="font-size: 2em; color: #764ba2; margin: 10px 0;">
                    29.99‚Ç¨<span style="font-size: 0.4em; color: #718096;">/an</span>
                </div>
                <p style="color: #38a169; font-size: 0.8em; margin: 5px 0;">‚âà 2.50‚Ç¨/mois</p>
                <ul style="list-style: none; padding: 0; margin: 10px 0; font-size: 0.8em; color: #4a5568;">
                    <li style="margin: 8px 0;">‚úÖ Tout le plan mensuel +</li>
                    <li style="margin: 8px 0;">‚úÖ 2 mois GRATUITS</li>
                    <li style="margin: 8px 0;">‚úÖ Support prioritaire</li>
                    <li style="margin: 8px 0;">‚úÖ Nouvelles fonctionnalit√©s en avant-premi√®re</li>
                </ul>
                <button onclick="initiatePaddleCheckout('yearly')" 
                        style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2);
                               color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    Choisir Annuel ‚≠ê
                </button>
                
            </div>
        </div>
        
        <!-- Garantie -->
        <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f0fdf4; border-radius: 10px;">
            <p style="color: #38a169; font-size: 0.85em; margin: 0;">
                üîí Paiement s√©curis√© ‚Ä¢ Annulation √† tout moment ‚Ä¢ Garantie 7 jours satisfait ou rembours√©
            </p>
        </div>
        
        <!-- M√©thodes de paiement -->
        <div style="text-align: center; margin-top: 15px;">
            <p style="color: #718096; font-size: 0.75em; margin-bottom: 8px;">Paiements s√©curis√©s via</p>
            <div style="display: flex; justify-content: center; gap: 15px; align-items: center; font-size: 0.85em;">
                <span>üí≥ Carte</span>
                <span>üÖøÔ∏è PayPal</span>
                <span>üì± Apple Pay</span>
            </div>
        </div>
        
        <button onclick="closePaymentSection()" 
                style="width: 100%; margin-top: 15px; padding: 10px; background: #e2e8f0;
                       color: #4a5568; border: none; border-radius: 8px; cursor: pointer;">
            Peut-√™tre plus tard
        </button>
    </div>
</div>

    <div class="notification" id="notification"></div>

    <script>
        let currentStep = 1;
        let skinType = '';
        let concerns = [];
        let checkinsHistory = [];
        // === SYST√àME DE CR√âDITS ===
let analyzerCredits = {
    free: 3,
    used: 0,
    isPremium: false,
    resetDate: new Date().toISOString()
};

// Charger les cr√©dits sauvegard√©s
function loadCredits() {
    const saved = localStorage.getItem('analyzerCredits');
    if (saved) {
        analyzerCredits = JSON.parse(saved);
        // R√©initialiser mensuellement pour les gratuits
        const lastReset = new Date(analyzerCredits.resetDate);
        const now = new Date();
        if (now.getMonth() !== lastReset.getMonth() && !analyzerCredits.isPremium) {
            analyzerCredits.used = 0;
            analyzerCredits.resetDate = now.toISOString();
            saveCredits();
        }
    }
}

function saveCredits() {
    localStorage.setItem('analyzerCredits', JSON.stringify(analyzerCredits));
}

function checkCredits() {
    if (analyzerCredits.isPremium) return true;
    return analyzerCredits.used < analyzerCredits.free;
}

function useCredit() {
    if (!analyzerCredits.isPremium) {
        analyzerCredits.used++;
        saveCredits();
    }
}
// === SYST√àME DE SUBSCRIPTION GLOBAL ===
let userSubscription = {
    plan: 'free', // 'free', 'premium', 'pro'
    startDate: null,
    endDate: null,
    features: {
        checkInsPerMonth: 3,
        inciAnalysisPerMonth: 3,
        photosPerMonth: 1,
        moodTracker: false,
        cycleTracker: false,
        aiRecommendations: false,
        photoAI: false,
        monthlyReport: false
    },
    usage: {
        checkIns: 0,
        photos: 0,
        resetDate: new Date().toISOString()
    }
};

// Charger la subscription
function loadSubscription() {
    const saved = localStorage.getItem('userSubscription');
    if (saved) {
        userSubscription = JSON.parse(saved);
        // Reset mensuel des quotas
        const lastReset = new Date(userSubscription.usage.resetDate);
        const now = new Date();
        if (now.getMonth() !== lastReset.getMonth()) {
            userSubscription.usage = {
                checkIns: 0,
                photos: 0,
                resetDate: now.toISOString()
            };
            saveSubscription();
        }
    }
}

function saveSubscription() {
    localStorage.setItem('userSubscription', JSON.stringify(userSubscription));
}

function canUseFeature(feature) {
    loadSubscription();
    
    switch(feature) {
        case 'checkIn':
            return userSubscription.plan !== 'free' || 
                   userSubscription.usage.checkIns < userSubscription.features.checkInsPerMonth;
        case 'photo':
            return userSubscription.plan !== 'free' || 
                   userSubscription.usage.photos < userSubscription.features.photosPerMonth;
        case 'moodTracker':
            return userSubscription.plan !== 'free';
        case 'cycleTrackerFull':
            return userSubscription.plan !== 'free';
        case 'aiRecommendations':
            return userSubscription.plan !== 'free';
        case 'photoAI':
            return userSubscription.plan === 'pro';
        default:
            return true;
    }
}

function useFeature(feature) {
    if (userSubscription.plan === 'free') {
        switch(feature) {
            case 'checkIn':
                userSubscription.usage.checkIns++;
                break;
            case 'photo':
                userSubscription.usage.photos++;
                break;
        }
        saveSubscription();
    }
}
// === CONFIGURATION API ===
const API_URL = (window.location.hostname === 'localhost' || 
                 window.location.hostname === '127.0.0.1' || 
                 window.location.hostname === '' ||
                 window.location.protocol === 'file:')
    ? 'http://127.0.0.1:8000' 
    : 'https://dailyglow-api.onrender.com';
// === BASE DE DONN√âES INCI ===
const ingredientsDatabase = {
    "niacinamide": {
        "inci": "Niacinamide",
        "alternateNames": ["Vitamin B3", "Nicotinamide"],
        "category": "active",
        "functions": ["anti-acne", "brightening", "anti-inflammatory", "sebum-control"],
        "concentrationRange": {
            "min": 2,
            "max": 10,
            "optimal": 5,
            "unit": "%"
        },
        "ph": { "optimal": "5.0-7.0" },
        "benefits": [
            "R√©duit l'apparence des pores dilat√©s",
            "R√©gule la production de s√©bum",
            "Am√©liore la texture de la peau",
            "R√©duit les taches pigmentaires"
        ],
        "risks": {
            "irritation": "low",
            "allergen": "very-low",
            "photosensitivity": "none",
            "pregnancy": "safe"
        },
        "incompatibilities": ["Vitamin C (pH < 3.5)", "AHA/BHA at high concentration"],
        "scientificReferences": [
            {
                "title": "Niacinamide: A B vitamin that improves aging facial skin appearance",
                "journal": "Dermatologic Surgery",
                "year": 2005,
                "doi": "10.1111/j.1524-4725.2005.31732"
            }
        ],
        "comedogenicity": 0,
        "skinTypes": ["all", "oily", "acne-prone"],
        "timeToResults": "4-8 weeks"
    },
    "retinol": {
        "inci": "Retinol",
        "alternateNames": ["Vitamin A", "Retinyl"],
        "category": "active",
        "functions": ["anti-aging", "anti-acne", "cell-renewal"],
        "concentrationRange": {
            "min": 0.01,
            "max": 1.0,
            "beginners": 0.025,
            "optimal": 0.1,
            "unit": "%"
        },
        "benefits": [
            "Stimule le renouvellement cellulaire",
            "R√©duit rides et ridules",
            "Am√©liore la texture",
            "Traite l'acn√©"
        ],
        "risks": {
            "irritation": "high",
            "allergen": "medium",
            "photosensitivity": "very-high",
            "pregnancy": "contraindicated"
        },
        "incompatibilities": ["Benzoyl Peroxide", "Vitamin C", "AHA/BHA"],
        "scientificReferences": [
            {
                "title": "Retinoids in the treatment of skin aging",
                "journal": "Clinical Interventions in Aging",
                "year": 2006,
                "pmid": "18044138"
            }
        ],
        "comedogenicity": 0,
        "skinTypes": ["mature", "acne-prone"],
        "timeToResults": "12-24 weeks"
    },
    "hyaluronic-acid": {
        "inci": "Sodium Hyaluronate",
        "alternateNames": ["Hyaluronic Acid", "HA"],
        "category": "humectant",
        "functions": ["hydration", "plumping", "wound-healing"],
        "molecularWeight": {
            "low": "< 50 kDa (p√©n√®tre profond√©ment)",
            "medium": "50-1000 kDa",
            "high": "> 1000 kDa (hydrate surface)"
        },
        "benefits": [
            "Hydrate intens√©ment",
            "Repulpe la peau",
            "R√©duit l'apparence des ridules"
        ],
        "risks": {
            "irritation": "very-low",
            "allergen": "very-low",
            "photosensitivity": "none",
            "pregnancy": "safe"
        },
        "scientificReferences": [
            {
                "title": "Efficacy of cream-based novel formulations of hyaluronic acid",
                "journal": "Journal of Clinical and Aesthetic Dermatology",
                "year": 2011,
                "pmid": "21909456"
            }
        ],
        "comedogenicity": 0,
        "skinTypes": ["all"],
        "timeToResults": "immediate-2 weeks"
    },
    "salicylic-acid": {
        "inci": "Salicylic Acid",
        "alternateNames": ["BHA", "Beta Hydroxy Acid"],
        "category": "exfoliant",
        "functions": ["exfoliation", "anti-acne", "anti-inflammatory"],
        "concentrationRange": {
            "min": 0.5,
            "max": 2.0,
            "optimal": 2.0,
            "unit": "%"
        },
        "ph": { "optimal": "3.0-4.0" },
        "benefits": [
            "D√©bouche les pores",
            "Exfolie en douceur",
            "R√©duit l'inflammation"
        ],
        "risks": {
            "irritation": "medium",
            "allergen": "low",
            "photosensitivity": "low",
            "pregnancy": "caution"
        },
        "scientificReferences": [
            {
                "title": "Treatment of acne vulgaris with salicylic acid pads",
                "journal": "Clinical Therapeutics",
                "year": 1992,
                "pmid": "1535287"
            }
        ],
        "comedogenicity": 0,
        "skinTypes": ["oily", "acne-prone"],
        "timeToResults": "2-4 weeks"
    },

    // Ajoutez plus d'ingr√©dients ici...
    // Ajoutez ces ingr√©dients √† votre base existante
// üìç Emplacement : Dans ingredientsDatabase apr√®s "salicylic-acid"
"centella-asiatica": {
    "inci": "Centella Asiatica Extract",
    "alternateNames": ["Cica", "Gotu Kola", "Tiger Grass"],
    "category": "soothing",
    "functions": ["healing", "anti-inflammatory", "collagen-boost"],
    "concentrationRange": { "min": 0.1, "max": 10, "optimal": 1-5 },
    "benefits": ["Apaise les irritations", "Acc√©l√®re la cicatrisation", "Renforce la barri√®re"],
    "risks": { "irritation": "very-low", "allergen": "low", "photosensitivity": "none", "pregnancy": "safe" },
    "comedogenicity": 0,
    "skinTypes": ["all", "especially sensitive"],
    "timeToResults": "1-2 weeks"
},
"azelaic-acid": {
    "inci": "Azelaic Acid",
    "alternateNames": ["AzA"],
    "category": "active",
    "functions": ["anti-acne", "brightening", "anti-inflammatory"],
    "concentrationRange": { "min": 5, "max": 20, "optimal": 10-15 },
    "benefits": ["Traite l'acn√© et la rosac√©e", "√âclaircit les taches", "Antibact√©rien"],
    "risks": { "irritation": "low-medium", "allergen": "low", "photosensitivity": "low", "pregnancy": "safe" },
    "comedogenicity": 0,
    "skinTypes": ["acne-prone", "rosacea", "all"],
    "timeToResults": "6-12 weeks"
},
"lactic-acid": {
    "inci": "Lactic Acid",
    "alternateNames": ["AHA"],
    "category": "exfoliant",
    "functions": ["gentle-exfoliation", "hydration", "brightening"],
    "concentrationRange": { "min": 5, "max": 10, "optimal": 5-8 },
    "ph": { "optimal": "3.5-4.0" },
    "benefits": ["Exfolie en douceur", "Hydrate", "Am√©liore la texture"],
    "risks": { "irritation": "low-medium", "allergen": "low", "photosensitivity": "medium", "pregnancy": "safe" },
    "comedogenicity": 0,
    "skinTypes": ["dry", "sensitive", "mature"],
    "timeToResults": "2-4 weeks"
},
"squalane": {
    "inci": "Squalane",
    "alternateNames": ["Olive Squalane", "Sugarcane Squalane"],
    "category": "emollient",
    "functions": ["hydration", "barrier-repair", "antioxidant"],
    "concentrationRange": { "min": 0.5, "max": 100, "optimal": 1-10 },
    "benefits": ["Hydrate sans graisser", "Imite le s√©bum naturel", "Non-com√©dog√®ne"],
    "risks": { "irritation": "very-low", "allergen": "very-low", "photosensitivity": "none", "pregnancy": "safe" },
    "comedogenicity": 0,
    "skinTypes": ["all"],
    "timeToResults": "immediate"
},
"allantoin": {
    "inci": "Allantoin",
    "alternateNames": ["Aluminum Dihydroxy Allantoinate"],
    "category": "soothing",
    "functions": ["healing", "soothing", "keratolytic"],
    "concentrationRange": { "min": 0.1, "max": 2, "optimal": 0.5-1 },
    "benefits": ["Apaise les irritations", "Favorise la cicatrisation", "Adoucit"],
    "risks": { "irritation": "very-low", "allergen": "very-low", "photosensitivity": "none", "pregnancy": "safe" },
    "comedogenicity": 0,
    "skinTypes": ["all", "especially sensitive"],
    "timeToResults": "few days"
},
"panthenol": {
    "inci": "Panthenol",
    "alternateNames": ["Pro-Vitamin B5", "Dexpanthenol"],
    "category": "soothing",
    "functions": ["hydration", "healing", "anti-inflammatory"],
    "concentrationRange": { "min": 0.5, "max": 5, "optimal": 1-2 },
    "benefits": ["Hydrate intens√©ment", "Apaise", "Am√©liore l'√©lasticit√©"],
    "risks": { "irritation": "very-low", "allergen": "very-low", "photosensitivity": "none", "pregnancy": "safe" },
    "comedogenicity": 0,
    "skinTypes": ["all"],
    "timeToResults": "immediate-1 week"
},
"alpha-arbutin": {
    "inci": "Alpha-Arbutin",
    "alternateNames": ["Arbutin"],
    "category": "brightening",
    "functions": ["brightening", "tyrosinase-inhibitor"],
    "concentrationRange": { "min": 0.5, "max": 2, "optimal": 2 },
    "benefits": ["√âclaircit les taches", "Unifie le teint", "Plus doux que l'hydroquinone"],
    "risks": { "irritation": "very-low", "allergen": "low", "photosensitivity": "low", "pregnancy": "safe" },
    "comedogenicity": 0,
    "skinTypes": ["all"],
    "timeToResults": "8-12 weeks"
},
"caffeine": {
    "inci": "Caffeine",
    "alternateNames": ["1,3,7-Trimethylxanthine"],
    "category": "vasoconstrictor",
    "functions": ["anti-puffiness", "antioxidant", "circulation"],
    "concentrationRange": { "min": 0.5, "max": 3, "optimal": 1-2 },
    "benefits": ["R√©duit les poches", "Am√©liore la circulation", "Antioxydant"],
    "risks": { "irritation": "very-low", "allergen": "low", "photosensitivity": "none", "pregnancy": "safe" },
    "comedogenicity": 0,
    "skinTypes": ["all"],
    "timeToResults": "immediate-2 weeks"
},
"green-tea": {
    "inci": "Camellia Sinensis Leaf Extract",
    "alternateNames": ["Green Tea Extract", "EGCG"],
    "category": "antioxidant",
    "functions": ["antioxidant", "anti-inflammatory", "photoprotection"],
    "concentrationRange": { "min": 0.5, "max": 10, "optimal": 1-5 },
    "benefits": ["Puissant antioxydant", "Anti-√¢ge", "Apaise les rougeurs"],
    "risks": { "irritation": "very-low", "allergen": "low", "photosensitivity": "none", "pregnancy": "safe" },
    "comedogenicity": 0,
    "skinTypes": ["all", "especially oily"],
    "timeToResults": "4-8 weeks"
},
"aloe-vera": {
    "inci": "Aloe Barbadensis Leaf Juice",
    "alternateNames": ["Aloe Vera Gel", "Aloe"],
    "category": "soothing",
    "functions": ["hydration", "healing", "anti-inflammatory"],
    "concentrationRange": { "min": 0.5, "max": 99, "optimal": 10-50 },
    "benefits": ["Hydrate et apaise", "Aide √† la cicatrisation", "Anti-inflammatoire"],
    "risks": { "irritation": "very-low", "allergen": "low", "photosensitivity": "none", "pregnancy": "safe" },
    "comedogenicity": 0,
    "skinTypes": ["all", "especially sensitive"],
    "timeToResults": "immediate"
},
"glycerin": {
    "inci": "Glycerin",
    "alternateNames": ["Glycerol", "Glycerine"],
    "category": "humectant",
    "functions": ["hydration", "moisture-retention"],
    "concentrationRange": { "min": 1, "max": 20, "optimal": 5 },
    "benefits": ["Hydrate la peau", "Attire l'humidit√©", "Renforce la barri√®re cutan√©e"],
    "risks": { "irritation": "very-low", "allergen": "very-low", "photosensitivity": "none", "pregnancy": "safe" },
    "comedogenicity": 0,
    "skinTypes": ["all"],
    "timeToResults": "immediate"
},
"vitamin-c": {
    "inci": "Ascorbic Acid",
    "alternateNames": ["L-Ascorbic Acid", "Vitamin C"],
    "category": "active",
    "functions": ["brightening", "antioxidant", "collagen-boost"],
    "concentrationRange": { "min": 5, "max": 20, "optimal": 10-15 },
    "ph": { "optimal": "< 3.5" },
    "benefits": ["√âclaircit le teint", "Antioxydant puissant", "Stimule le collag√®ne"],
    "risks": { "irritation": "medium-high", "allergen": "low", "photosensitivity": "medium", "pregnancy": "safe" },
    "incompatibilities": ["Niacinamide", "Retinol", "Benzoyl Peroxide"],
    "comedogenicity": 0,
    "skinTypes": ["all except sensitive"],
    "timeToResults": "6-8 weeks"
},
"glycolic-acid": {
    "inci": "Glycolic Acid",
    "alternateNames": ["AHA", "Alpha Hydroxy Acid"],
    "category": "exfoliant",
    "functions": ["exfoliation", "brightening", "anti-aging"],
    "concentrationRange": { "min": 5, "max": 30, "optimal": 8-10 },
    "ph": { "optimal": "3.0-4.0" },
    "benefits": ["Exfolie en profondeur", "Am√©liore la texture", "R√©duit les taches"],
    "risks": { "irritation": "high", "allergen": "medium", "photosensitivity": "high", "pregnancy": "caution" },
    "comedogenicity": 0,
    "skinTypes": ["normal", "oily"],
    "timeToResults": "2-4 weeks"
},
"ceramides": {
    "inci": "Ceramide NP",
    "alternateNames": ["Ceramide 3", "Ceramides"],
    "category": "barrier-repair",
    "functions": ["barrier-repair", "hydration", "protection"],
    "concentrationRange": { "min": 0.1, "max": 2, "optimal": 1 },
    "benefits": ["R√©pare la barri√®re cutan√©e", "R√©duit la perte d'eau", "Apaise"],
    "risks": { "irritation": "very-low", "allergen": "very-low", "photosensitivity": "none", "pregnancy": "safe" },
    "comedogenicity": 0,
    "skinTypes": ["all", "especially dry and sensitive"],
    "timeToResults": "2-4 weeks"
},
"benzoyl-peroxide": {
    "inci": "Benzoyl Peroxide",
    "alternateNames": ["BPO"],
    "category": "anti-acne",
    "functions": ["antibacterial", "anti-acne", "keratolytic"],
    "concentrationRange": { "min": 2.5, "max": 10, "optimal": 2.5-5 },
    "benefits": ["Tue les bact√©ries de l'acn√©", "D√©bouche les pores", "R√©duit l'inflammation"],
    "risks": { "irritation": "high", "allergen": "medium", "photosensitivity": "medium", "pregnancy": "safe" },
    "incompatibilities": ["Retinol", "Vitamin C"],
    "comedogenicity": 0,
    "skinTypes": ["acne-prone"],
    "timeToResults": "1-2 weeks"
},
"peptides": {
    "inci": "Palmitoyl Pentapeptide-4",
    "alternateNames": ["Matrixyl", "Peptides"],
    "category": "anti-aging",
    "functions": ["anti-aging", "collagen-boost", "firming"],
    "concentrationRange": { "min": 1, "max": 10, "optimal": 3-5 },
    "benefits": ["Stimule le collag√®ne", "R√©duit les rides", "Raffermit"],
    "risks": { "irritation": "very-low", "allergen": "low", "photosensitivity": "none", "pregnancy": "safe" },
    "comedogenicity": 0,
    "skinTypes": ["mature", "all"],
    "timeToResults": "8-12 weeks"
},
"zinc-oxide": {
    "inci": "Zinc Oxide",
    "alternateNames": ["Mineral Sunscreen"],
    "category": "sunscreen",
    "functions": ["sun-protection", "anti-inflammatory", "healing"],
    "concentrationRange": { "min": 5, "max": 25, "optimal": 10-20 },
    "benefits": ["Protection UV", "Apaise", "Aide √† la cicatrisation"],
    "risks": { "irritation": "very-low", "allergen": "very-low", "photosensitivity": "none", "pregnancy": "safe" },
    "comedogenicity": 1,
    "skinTypes": ["all", "especially sensitive"],
    "timeToResults": "immediate"
}
};


// === FONCTION D'ANALYSE INCI ===
function analyzeIngredients(inciList) {
    const analysis = {
        ingredients: [],
        benefits: new Set(),
        risks: [],
        skinTypeCompatibility: {},
        pregnancySafe: true,
        references: []
    };
    
    // Parser la liste INCI (g√©n√©ralement s√©par√©e par des virgules)
    const ingredients = inciList.split(',').map(i => i.trim().toLowerCase());
    
    ingredients.forEach(ingredient => {
        // Chercher dans notre base
        let found = null;
        for (let key in ingredientsDatabase) {
            const data = ingredientsDatabase[key];
            if (data.inci.toLowerCase() === ingredient || 
                data.alternateNames.some(name => name.toLowerCase() === ingredient)) {
                found = { key, ...data };
                break;
            }
        }
        
        if (found) {
            analysis.ingredients.push({
                name: found.inci,
                functions: found.functions,
                concentration: found.concentrationRange,
                risks: found.risks
            });
            
            // Ajouter les b√©n√©fices
            found.benefits.forEach(b => analysis.benefits.add(b));
            
            // V√©rifier les risques
            if (found.risks.irritation === 'high') {
                analysis.risks.push(`${found.inci}: Risque d'irritation √©lev√©`);
            }
            if (found.risks.pregnancy === 'contraindicated') {
                analysis.pregnancySafe = false;
                analysis.risks.push(`${found.inci}: D√©conseill√© pendant la grossesse`);
            }
            
            // Ajouter les r√©f√©rences
            if (found.scientificReferences) {
                analysis.references.push(...found.scientificReferences);
            }
        } else {
            analysis.ingredients.push({
                name: ingredient,
                status: 'unknown',
                message: 'Ingr√©dient non trouv√© dans notre base'
            });
        }
    });
    
    return analysis;
}

// === FONCTION DE COMPATIBILIT√â ===
function checkIngredientCompatibility(ingredient1, ingredient2) {
    const ing1 = ingredientsDatabase[ingredient1];
    const ing2 = ingredientsDatabase[ingredient2];
    
    if (!ing1 || !ing2) return { compatible: 'unknown' };
    
    // V√©rifier les incompatibilit√©s
    if (ing1.incompatibilities && ing1.incompatibilities.includes(ing2.inci)) {
        return {
            compatible: false,
            reason: `${ing1.inci} ne doit pas √™tre m√©lang√© avec ${ing2.inci}`,
            recommendation: 'Utilisez-les √† des moments diff√©rents (matin/soir)'
        };
    }
    
    return { compatible: true };
}
// === FONCTIONS API ===
async function registerUser(userData) {
    try {
        console.log('üì§ Envoi des donn√©es:', userData);
        
        const response = await fetch(`${API_URL}/auth/register`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(userData)
        });
        
        console.log('üì• Statut r√©ponse:', response.status);
        const data = await response.json();
        console.log('üì• Donn√©es re√ßues:', data);
        
        if (response.ok) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            return data;
        }
        
        // Afficher l'erreur exacte du backend
        console.error('‚ùå Erreur backend:', data);
        throw new Error(data.detail || data.message || 'Erreur cr√©ation compte');
        
    } catch (error) {
        console.error('‚ùå Erreur compl√®te:', error);
        throw error;
    }
}

async function loginUser(email, password) {
    try {
        console.log('üîê Tentative de connexion:', email);
        
        const response = await fetch(`${API_URL}/auth/login`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email, password })
        });
        
        console.log('üì• Statut r√©ponse:', response.status);
        const data = await response.json();
        console.log('üì• Donn√©es re√ßues:', data);
        
        if (response.ok) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            console.log('‚úÖ Connexion r√©ussie !');
            return data;
        }
        
        console.error('‚ùå Erreur backend:', data);
        throw new Error(data.detail || data.message || 'Email ou mot de passe incorrect');
        
    } catch (error) {
        console.error('‚ùå Erreur connexion:', error);
        throw error;
    }
}

// Mode actuel : 'inscription' ou 'connexion'
let authMode = 'inscription';

function showInscription() {
    authMode = 'inscription';
    document.getElementById('authTitle').textContent = 'üëã Bienvenue ! Commen√ßons par faire connaissance';
    document.getElementById('inscriptionFields').style.display = 'block';
    document.getElementById('inscriptionFields2').style.display = 'block';
    document.getElementById('authButton').textContent = 'Cr√©er mon compte ‚Üí';
    document.getElementById('authSwitch').innerHTML = 'D√©j√† un compte ? <a href="#" onclick="showConnexion()" style="color: #667eea; font-weight: bold;">Se connecter</a>';
    document.getElementById('btnInscription').style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
    document.getElementById('btnInscription').style.color = 'white';
    document.getElementById('btnConnexion').style.background = '#e2e8f0';
    document.getElementById('btnConnexion').style.color = '#4a5568';
}

function showConnexion() {
    authMode = 'connexion';
    document.getElementById('authTitle').textContent = 'üîê Content de te revoir !';
    document.getElementById('inscriptionFields').style.display = 'none';
    document.getElementById('inscriptionFields2').style.display = 'none';
    document.getElementById('authButton').textContent = 'Se connecter ‚Üí';
    document.getElementById('authSwitch').innerHTML = 'Pas encore de compte ? <a href="#" onclick="showInscription()" style="color: #667eea; font-weight: bold;">S\'inscrire</a>';
    document.getElementById('btnConnexion').style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
    document.getElementById('btnConnexion').style.color = 'white';
    document.getElementById('btnInscription').style.background = '#e2e8f0';
    document.getElementById('btnInscription').style.color = '#4a5568';
}

async function handleAuth() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
        alert('Veuillez remplir tous les champs');
        return;
    }
    
    try {
        if (authMode === 'inscription') {
            const name = document.getElementById('name').value;
            const age = document.getElementById('age').value;
            
            if (!name || !age) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            await registerUser({
                email: email,
                password: password,
                first_name: name,
                age: parseInt(age)
            });
            
            showNotification('‚úÖ Compte cr√©√© avec succ√®s !');
            
        } else {
            await loginUser(email, password);
            showNotification('‚úÖ Connexion r√©ussie !');
        }
        
        nextStep(1);
        
    } catch (error) {
        alert('‚ùå ' + error.message);
    }
}

async function createSkinProfile(profileData) {
    try {
        const response = await fetch(`${API_URL}/profile/skin`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(profileData)
        });
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Erreur:', error);
        throw error;
    }
}

async function submitDailyCheckIn(checkinData) {
    try {
        const response = await fetch(`${API_URL}/checkin`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(checkinData)
        });
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Erreur:', error);
        throw error;
    }
}

async function getAIRecommendations() {
    // CORRECTION 4: V√©rifier si un profil existe dans localStorage
    const savedProfile = localStorage.getItem('skinProfile');
    
    // Si pas de profil sauvegard√©, utiliser le profil actuel
    if (!savedProfile && skinType) {
        const profile = {
            skinType: skinType,
            concerns: concerns
        };
        localStorage.setItem('skinProfile', JSON.stringify(profile));
    }
    
    try {
        const response = await fetch(`${API_URL}/ai/recommendations`);
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Erreur:', error);
        // Si l'API √©choue mais qu'on a un profil local, g√©n√©rer des recommandations locales
        if (skinType) {
            return generateLocalRecommendations();
        }
        return null;
    }
}

// Fonction pour g√©n√©rer des recommandations locales si l'API ne r√©pond pas
function generateLocalRecommendations() {
    const recommendations = [];
    
    if (!skinType) return { recommendations: [] };
    
    // Analyser le profil et recommander des ingr√©dients sp√©cifiques
    const recommendedIngredients = [];
    
    // Logique de recommandation bas√©e sur le type de peau et les pr√©occupations
    if (skinType === 'grasse' || concerns.includes('acne')) {
        recommendedIngredients.push('niacinamide', 'salicylic-acid', 'azelaic-acid');
    }
    if (skinType === 'seche' || concerns.includes('secheresse')) {
        recommendedIngredients.push('hyaluronic-acid', 'ceramides', 'squalane');
    }
    if (concerns.includes('rides') || concerns.includes('taches pigmentaires')) {
        recommendedIngredients.push('retinol', 'vitamin-c', 'peptides');
    }
    if (concerns.includes('sensibilite')) {
        recommendedIngredients.push('centella-asiatica', 'panthenol', 'allantoin');
    }
    
    // G√©n√©rer des recommandations avec justification scientifique
    recommendedIngredients.forEach(ingKey => {
        const ingredient = ingredientsDatabase[ingKey];
        if (ingredient) {
            recommendations.push({
                product: {
                    name: `S√©rum ${ingredient.inci} ${ingredient.concentrationRange.optimal}%`,
                    price: Math.floor(15 + Math.random() * 30),
                    rating: 4.5,
                    description: ingredient.benefits[0]
                },
                category: 'Traitement cibl√©',
                reasons: ingredient.benefits.slice(0, 2),
                urgency: ingredient.functions.includes('anti-acne') ? 'high' : 'medium',
                match_score: 85 + Math.floor(Math.random() * 15),
                scientificBacking: ingredient.scientificReferences ? 
                    `Efficacit√© prouv√©e (${ingredient.scientificReferences[0]?.journal || '√âtudes cliniques'})` : 
                    'Recommand√© par les dermatologues'
            });
        }
    });
    
    return { recommendations: recommendations };
}

async function getAnalytics() {
    try {
        const response = await fetch(`${API_URL}/analytics/progress`);
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Erreur:', error);
        return null;
    }
}
        let photoType = 'progress';

        async function nextStep(step) {
            if (step === 1) {
                // V√©rifier si l'utilisateur est connect√© (g√©r√© par handleAuth)
                const user = localStorage.getItem('user');
                if (!user) {
                    showNotification('‚ö†Ô∏è Veuillez vous connecter ou cr√©er un compte');
                    return;
                }
            }
            if (step === 2) {
            // R√©initialiser les pr√©occupations avant de commencer
                concerns = [];
                document.querySelectorAll('.concern-option').forEach(option => {
                    option.classList.remove('selected');
                });
            }

            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep++;
            document.getElementById(`step${currentStep}`).classList.add('active');
            updateProgress();
        }

        function updateProgress() {
            const steps = document.querySelectorAll('.progress-step');
            steps.forEach((step, index) => {
                if (index < currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
        }

        function selectSkinType(type) {
            skinType = type;
            console.log('Type de peau s√©lectionn√©:', skinType);
    
            // Retirer toutes les s√©lections
            document.querySelectorAll('.skin-type-option').forEach(option => {
                option.classList.remove('selected');
            });
    
        // Ajouter la s√©lection sur le bon √©l√©ment
        // On utilise l'√©v√©nement pour trouver l'√©l√©ment cliqu√©
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('selected');
            }
    
            document.getElementById('skinTypeNext').disabled = false;
        }

        function toggleConcernFixed(element) {
            const concern = element.getAttribute('data-concern');
            console.log('Concern from data:', concern);
    
            if (!Array.isArray(concerns)) {
                concerns = [];
            }
    
            const index = concerns.indexOf(concern);
    
            if (index > -1) {
                concerns.splice(index, 1);
                element.classList.remove('selected');
            } else {
                concerns.push(concern);
                element.classList.add('selected');
            }
    
            console.log('Pr√©occupations:', concerns);
        }

        function updateStressDisplay() {
            const value = document.getElementById('stressLevel').value;
            document.getElementById('stressDisplay').textContent = `${value} / 10`;
        }

        async function createProfile() {
            const name = document.getElementById('name').value;
            const stressLevel = document.getElementById('stressLevel').value;
            const age = document.getElementById('age').value;
    
            // IMPORTANT : V√©rifier que skinType et concerns ont bien √©t√© d√©finis
            if (!skinType) {
                showNotification('‚ö†Ô∏è S√©lectionne ton type de peau !');
                return;
            }
    
            // CORRECTION : Sauvegarder le profil AVANT l'appel API
            const profile = {
                skinType: skinType,
                concerns: concerns,
                stressLevel: parseInt(stressLevel),
                name: name,
                age: age,
                createdAt: new Date().toISOString()
            };

            // Nettoyer les anciennes donn√©es si c'est un nouveau compte
            const oldProfile = localStorage.getItem('skinProfile');
            if (oldProfile) {
                const oldData = JSON.parse(oldProfile);
                const oldUserId = oldData.email || oldData.name || 'default';
                // Si c'est un utilisateur diff√©rent, ne pas toucher √† ses donn√©es
                if (oldUserId !== email && oldUserId !== name) {
                    // On ne supprime rien, on garde les donn√©es de l'ancien utilisateur
                    console.log('Nouveau utilisateur d√©tect√©, donn√©es s√©par√©es');
                }
            }
    
            // Sauvegarder imm√©diatement dans localStorage
            localStorage.setItem('skinProfile', JSON.stringify(profile));
            console.log('Profil sauvegard√©:', profile); // Pour debug
    
            // Nettoyer les anciennes donn√©es du cycle tracker d'un autre utilisateur
            localStorage.removeItem('cycleData');
            localStorage.removeItem('checkinsHistory');
    
            try {
                showNotification('üîÑ Cr√©ation du profil...');
                await createSkinProfile({
                    skin_type: skinType,
                    main_concerns: concerns,
                    stress_level: parseInt(stressLevel)
                });
                showNotification('‚úÖ Profil cr√©√© !');
            } catch (error) {
                console.error('Erreur profil:', error);
                // M√™me si l'API √©choue, le profil est sauvegard√© localement
                showNotification('‚úÖ Profil cr√©√© localement !');
            }
        function clearAllUserData() {
            localStorage.removeItem('skinProfile');
            localStorage.removeItem('cycleData');
            localStorage.removeItem('checkinsHistory');
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            skinType = '';
            concerns = [];
            checkinsHistory = [];
            console.log('Toutes les donn√©es utilisateur ont √©t√© effac√©es');
        }
    
    // Suite du code pour g√©n√©rer la routine...
            // D√©terminer le moment de la journ√©e
            const hour = new Date().getHours();
            const timeGreeting = hour < 12 ? 'Bonjour' : hour < 18 ? 'Bon apr√®s-midi' : 'Bonsoir';

            let routine = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: #ff6b6b; font-size: 1.8em; margin-bottom: 10px;">
                        ${timeGreeting} ${name} ! üå∫
                    </h2>
                    <p style="color: #8e9aaf; font-size: 1.1em;">
                        Ta routine sur-mesure est pr√™te √† transformer ta peau
                    </p>
                </div>

                <div class="routine-summary" style="background: linear-gradient(135deg, #fff0f5, #ffeef3); padding: 20px; border-radius: 15px; margin-bottom: 25px; text-align: center;">
                    <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <span style="font-size: 2em;">üéØ</span>
                            <p style="color: #5c677d; margin: 5px 0;"><strong>Type de peau</strong></p>
                            <p style="color: #ff6b6b; font-size: 1.1em;">${skinType.charAt(0).toUpperCase() + skinType.slice(1)}</p>
                        </div>
                        <div>
                            <span style="font-size: 2em;">üìä</span>
                            <p style="color: #5c677d; margin: 5px 0;"><strong>Priorit√©s</strong></p>
                            <p style="color: #ff6b6b; font-size: 1.1em;">${concerns.length || 0} zones</p>
                        </div>
                        <div>
                            <span style="font-size: 2em;">‚è±Ô∏è</span>
                            <p style="color: #5c677d; margin: 5px 0;"><strong>Temps estim√©</strong></p>
                            <p style="color: #ff6b6b; font-size: 1.1em;">5-7 min</p>
                        </div>
                    </div>
                </div>
            `;

            const routines = {
                'normale': {
                    matin: [
                        { step: 'Nettoyage doux', desc: 'Gel nettoyant pH neutre', time: '30 sec', icon: 'üßº' },
                        { step: 'Tonique √©quilibrant', desc: 'Eau florale de rose', time: '15 sec', icon: 'üíß' },
                        { step: 'S√©rum vitamine C', desc: '10-15% pour l\'√©clat', time: '30 sec', icon: '‚ú®' },
                        { step: 'Hydratation l√©g√®re', desc: 'Cr√®me gel matifiante', time: '30 sec', icon: 'üí¶' },
                        { step: 'Protection solaire', desc: 'SPF 30+ obligatoire !', time: '30 sec', icon: '‚òÄÔ∏è' }
                    ],
                    soir: [
                        { step: 'Double nettoyage', desc: 'Huile + gel nettoyant', time: '1 min', icon: 'üåô' },
                        { step: 'Tonique apaisant', desc: 'Sans alcool', time: '15 sec', icon: 'üíß' },
                        { step: 'S√©rum r√©parateur', desc: 'Niacinamide 5%', time: '30 sec', icon: 'üî¨' },
                        { step: 'Cr√®me de nuit', desc: 'R√©g√©n√©ration cellulaire', time: '30 sec', icon: 'üåú' },
                        { step: 'Soin contour yeux', desc: 'Anti-cernes et poches', time: '15 sec', icon: 'üëÅÔ∏è' }
                    ]
                },
                's√®che': {
                    matin: [
                        { step: 'Nettoyage cr√©meux', desc: 'Lait nettoyant ultra-doux', time: '30 sec', icon: 'ü•õ' },
                        { step: 'Brume hydratante', desc: 'Acide hyaluronique', time: '15 sec', icon: 'üíß' },
                        { step: 'S√©rum nourrissant', desc: 'C√©ramides + peptides', time: '30 sec', icon: 'üíé' },
                        { step: 'Cr√®me riche', desc: 'Beurre de karit√© + squalane', time: '45 sec', icon: 'üßà' },
                        { step: 'SPF hydratant', desc: 'Protection + nutrition', time: '30 sec', icon: '‚òÄÔ∏è' }
                    ],
                    soir: [
                        { step: 'Huile d√©maquillante', desc: 'Jojoba ou argan', time: '1 min', icon: 'üåø' },
                        { step: 'Nettoyant cr√®me', desc: 'Sans sulfates', time: '30 sec', icon: 'üß¥' },
                        { step: 'Essence hydratante', desc: '7 couches d\'hydratation', time: '45 sec', icon: 'üí¶' },
                        { step: 'S√©rum r√©parateur', desc: 'R√©tinol 0.3% (2x/sem)', time: '30 sec', icon: '‚ö°' },
                        { step: 'Masque de nuit', desc: 'Sleeping mask nourrissant', time: '1 min', icon: 'üò¥' }
                    ]
                },
                'grasse': {
                    matin: [
                        { step: 'Gel moussant', desc: 'Acide salicylique 0.5%', time: '45 sec', icon: 'ü´ß' },
                        { step: 'Toner purifiant', desc: 'BHA + th√© vert', time: '20 sec', icon: 'üçµ' },
                        { step: 'S√©rum matifiant', desc: 'Niacinamide 10% + zinc', time: '30 sec', icon: '‚öóÔ∏è' },
                        { step: 'Gel hydratant', desc: 'Oil-free, non com√©dog√®ne', time: '30 sec', icon: 'üíß' },
                        { step: 'SPF fluide', desc: 'Fini mat, anti-brillance', time: '30 sec', icon: '‚òÄÔ∏è' }
                    ],
                    soir: [
                        { step: 'Eau micellaire', desc: 'D√©maquillage efficace', time: '45 sec', icon: 'üíß' },
                        { step: 'Mousse purifiante', desc: 'Nettoie en profondeur', time: '45 sec', icon: 'üßΩ' },
                        { step: 'Lotion exfoliante', desc: 'AHA 5% (3x/sem)', time: '20 sec', icon: '‚ú®' },
                        { step: 'S√©rum anti-imperfections', desc: 'R√©tinol + BHA', time: '30 sec', icon: 'üíâ' },
                        { step: 'Cr√®me l√©g√®re nuit', desc: 'R√©gule le s√©bum', time: '30 sec', icon: 'üåõ' }
                    ]
                },
                'mixte': {
                    matin: [
                        { step: 'Gel nettoyant doux', desc: '√âquilibre zone T', time: '30 sec', icon: 'üßº' },
                        { step: 'Tonique bi-phase', desc: 'Purifie et hydrate', time: '20 sec', icon: 'üíß' },
                        { step: 'S√©rum multi-zones', desc: 'Adapt√© √† chaque zone', time: '45 sec', icon: 'üéØ' },
                        { step: 'Cr√®me √©quilibrante', desc: 'Texture modulable', time: '45 sec', icon: '‚öñÔ∏è' },
                        { step: 'Protection solaire', desc: 'SPF 35+ hybride', time: '30 sec', icon: '‚òÄÔ∏è' }
                    ],
                    soir: [
                        { step: 'D√©maquillant bi-phase', desc: 'Yeux + visage', time: '1 min', icon: 'üåô' },
                        { step: 'Nettoyant √©quilibrant', desc: 'R√©gule sans ass√©cher', time: '30 sec', icon: 'üß¥' },
                        { step: 'Essence hydratante', desc: 'Premi√®re couche d\'hydratation', time: '20 sec', icon: 'üí¶' },
                        { step: 'S√©rum personnalis√©', desc: 'Cocktail d\'actifs cibl√©s', time: '45 sec', icon: 'üî¨' },
                        { step: 'Cr√®me nuit adaptative', desc: 'S\'ajuste √† tes besoins', time: '30 sec', icon: 'üåú' }
                    ]
                },
                'sensible': {
                    matin: [
                        { step: 'Eau micellaire douce', desc: 'Sans rin√ßage si irrit√©e', time: '30 sec', icon: 'üíß' },
                        { step: 'Brume apaisante', desc: 'Eau thermale pure', time: '15 sec', icon: 'üåä' },
                        { step: 'S√©rum barri√®re', desc: 'Centella + c√©ramides', time: '30 sec', icon: 'üõ°Ô∏è' },
                        { step: 'Cr√®me protectrice', desc: 'Anti-rougeurs, hypoallerg√©nique', time: '45 sec', icon: 'ü§ç' },
                        { step: 'SPF 50 min√©ral', desc: 'Zinc oxide only', time: '30 sec', icon: '‚òÄÔ∏è' }
                    ],
                    soir: [
                        { step: 'Lait d√©maquillant', desc: 'Ultra-doux, sans parfum', time: '1 min', icon: 'ü•õ' },
                        { step: 'Rin√ßage eau ti√®de', desc: 'Jamais d\'eau chaude !', time: '20 sec', icon: 'üíß' },
                        { step: 'S√©rum calmant', desc: 'Aloe vera + camomille', time: '30 sec', icon: 'üåø' },
                        { step: 'Cr√®me cocooning', desc: 'Texture baume r√©confortante', time: '45 sec', icon: 'üßà' },
                        { step: 'Huile apaisante', desc: 'Calendula (si tr√®s s√®che)', time: '20 sec', icon: '‚ú®' }
                    ]
                }
            };

            const selectedRoutine = routines[skinType] || routines['normale'];

            // Routine du matin d√©taill√©e
            routine += `
                <div class="routine-item" style="background: linear-gradient(135deg, #fff9e6, #fff5d6); border-left: 4px solid #ffc107;">
                    <h3 style="color: #ff8c42; font-size: 1.3em; margin-bottom: 20px;">
                        ‚òÄÔ∏è Ta routine du matin <span style="font-size: 0.8em; color: #8e9aaf;">(5-7 minutes)</span>
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
            `;

            selectedRoutine.matin.forEach((step, index) => {
                routine += `
                    <div style="display: flex; align-items: start; gap: 15px; padding: 12px; background: white; border-radius: 12px;">
                        <div style="min-width: 40px; height: 40px; background: linear-gradient(135deg, #ffeb3b, #ffc107); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                            ${index + 1}
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong style="color: #5c677d; font-size: 1.05em;">${step.icon} ${step.step}</strong>
                                <span style="color: #ffb088; font-size: 0.85em;">‚è± ${step.time}</span>
                            </div>
                            <p style="color: #8e9aaf; margin-top: 5px; font-size: 0.9em;">${step.desc}</p>
                        </div>
                    </div>
                `;
            });

            routine += `</div></div>`;

            // Routine du soir d√©taill√©e
            routine += `
                <div class="routine-item" style="background: linear-gradient(135deg, #f0e6ff, #e6d6ff); border-left: 4px solid #9c27b0;">
                    <h3 style="color: #8e44ad; font-size: 1.3em; margin-bottom: 20px;">
                        üåô Ta routine du soir <span style="font-size: 0.8em; color: #8e9aaf;">(7-10 minutes)</span>
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
            `;

            selectedRoutine.soir.forEach((step, index) => {
                routine += `
                    <div style="display: flex; align-items: start; gap: 15px; padding: 12px; background: white; border-radius: 12px;">
                        <div style="min-width: 40px; height: 40px; background: linear-gradient(135deg, #9c27b0, #7b1fa2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                            ${index + 1}
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong style="color: #5c677d; font-size: 1.05em;">${step.icon} ${step.step}</strong>
                                <span style="color: #b19cd9; font-size: 0.85em;">‚è± ${step.time}</span>
                            </div>
                            <p style="color: #8e9aaf; margin-top: 5px; font-size: 0.9em;">${step.desc}</p>
                        </div>
                    </div>
                `;
            });

            routine += `</div></div>`;

            // Traitements sp√©cifiques selon les pr√©occupations
        if (concerns && concerns.length > 0) {
            console.log('Pr√©occupations d√©tect√©es:', concerns); // Pour debug

            routine += `
                <div class="routine-item" style="background: linear-gradient(135deg, #e6f7ff, #d6efff); border-left: 4px solid #2196f3;">
                    <h3 style="color: #1976d2; font-size: 1.3em; margin-bottom: 20px;">
                        üéØ Traitements cibl√©s pour TES pr√©occupations (${concerns.length})
                    </h3>
                    <div style="display: grid; gap: 12px;">
            `;
    
            // Traiter uniquement les pr√©occupations s√©lectionn√©es
            concerns.forEach(concern => {
                console.log('Traitement pour:', concern); // Pour debug
        
                switch(concern) {
                    case 'acne':
                        routine += `
                            <div style="padding: 15px; background: white; border-radius: 12px;">
                                <strong style="color: #ff6b6b;">üî¥ Acne</strong>
                                <p style="color: #5c677d; margin-top: 8px;">‚Ä¢ Patch anti-imperfections la nuit sur les boutons</p>
                                <p style="color: #5c677d;">‚Ä¢ Masque √† l'argile verte 1x/semaine (10 min)</p>
                                <p style="color: #5c677d;">‚Ä¢ √âvite de toucher ton visage dans la journ√©e</p>
                            </div>
                        `;
                        break;
                
                    case 'rides':
                        routine += `
                            <div style="padding: 15px; background: white; border-radius: 12px;">
                                <strong style="color: #ff6b6b;">‚è∞ Anti-√¢ge</strong>
                                <p style="color: #5c677d; margin-top: 8px;">‚Ä¢ Massage facial 2 min chaque soir (mouvements vers le haut)</p>
                                <p style="color: #5c677d;">‚Ä¢ R√©tinol progressif : commencer 1x/sem puis augmenter</p>
                                <p style="color: #5c677d;">‚Ä¢ S√©rum contour des yeux matin ET soir</p>
                            </div>
                        `;
                        break;
                
                    case 'taches pigmentaires':
                        routine += `
                            <div style="padding: 15px; background: white; border-radius: 12px;">
                                <strong style="color: #ff6b6b;">üé® Taches</strong>
                                <p style="color: #5c677d; margin-top: 8px;">‚Ä¢ S√©rum vitamine C chaque matin (avant le SPF)</p>
                                <p style="color: #5c677d;">‚Ä¢ Exfoliation AHA 2x/semaine le soir</p>
                                <p style="color: #5c677d;">‚Ä¢ SPF 50 obligatoire, m√™me par temps nuageux !</p>
                            </div>
                        `;
                        break;
                
                    case 'cernes':
                        routine += `
                            <div style="padding: 15px; background: white; border-radius: 12px;">
                                <strong style="color: #ff6b6b;">üëÅÔ∏è Cernes & Poches</strong>
                                <p style="color: #5c677d; margin-top: 8px;">‚Ä¢ Massage drainant avec roll-on froid</p>
                                <p style="color: #5c677d;">‚Ä¢ Cr√®me caf√©ine matin et soir</p>
                                <p style="color: #5c677d;">‚Ä¢ Dormir t√™te l√©g√®rement sur√©lev√©e</p>
                            </div>
                        `;
                        break;
                
                    case 'teint terne':
                        routine += `
                            <div style="padding: 15px; background: white; border-radius: 12px;">
                                <strong style="color: #ff6b6b;">‚òÅÔ∏è Teint terne</strong>
                                <p style="color: #5c677d; margin-top: 8px;">‚Ä¢ Gommage enzymatique 2x/semaine</p>
                                <p style="color: #5c677d;">‚Ä¢ S√©rum √©clat vitamine C + niacinamide</p>
                                <p style="color: #5c677d;">‚Ä¢ Masque illuminateur hebdomadaire</p>
                            </div>
                        `;
                        break;
                
                    case 'cicatrices':
                        routine += `
                            <div style="padding: 15px; background: white; border-radius: 12px;">
                                <strong style="color: #ff6b6b;">ü©π Cicatrices</strong>
                                <p style="color: #5c677d; margin-top: 8px;">‚Ä¢ S√©rum r√©parateur centella asiatica</p>
                                <p style="color: #5c677d;">‚Ä¢ Micro-needling 1x/mois (avec dermatologue)</p>
                                <p style="color: #5c677d;">‚Ä¢ Protection solaire SPF 50 indispensable</p>
                            </div>
                        `;
                        break;
                
                    case 'rel√¢chement':
                        routine += `
                            <div style="padding: 15px; background: white; border-radius: 12px;">
                                <strong style="color: #ff6b6b;">üìâ Rel√¢chement cutan√©</strong>
                                <p style="color: #5c677d; margin-top: 8px;">‚Ä¢ Massage facial lifting 5 min/jour</p>
                                <p style="color: #5c677d;">‚Ä¢ S√©rum peptides + collag√®ne</p>
                                <p style="color: #5c677d;">‚Ä¢ Exercices de yoga facial</p>
                            </div>
                        `;
                        break;
                
                    case 'secheresse':
                        routine += `
                            <div style="padding: 15px; background: white; border-radius: 12px;">
                                <strong style="color: #ff6b6b;">üåµ S√©cheresse extr√™me</strong>
                                <p style="color: #5c677d; margin-top: 8px;">‚Ä¢ Layering : 7 couches d'hydratation</p>
                                <p style="color: #5c677d;">‚Ä¢ Huile visage scellante le soir</p>
                                <p style="color: #5c677d;">‚Ä¢ Humidificateur dans la chambre</p>
                            </div>
                        `;
                        break;
                
                    case 'sensibilite':
                        routine += `
                            <div style="padding: 15px; background: white; border-radius: 12px;">
                                <strong style="color: #ff6b6b;">üå°Ô∏è Hypersensibilit√©</strong>
                                <p style="color: #5c677d; margin-top: 8px;">‚Ä¢ Routine minimaliste (3-4 produits max)</p>
                                <p style="color: #5c677d;">‚Ä¢ √âviter les changements brusques de temp√©rature</p>
                                <p style="color: #5c677d;">‚Ä¢ Patch test obligatoire pour tout nouveau produit</p>
                            </div>
                        `;
                        break;
                
                    case 'brillance':
                        routine += `
                            <div style="padding: 15px; background: white; border-radius: 12px;">
                                <strong style="color: #ff6b6b;">‚ú® Brillance excessive</strong>
                                <p style="color: #5c677d; margin-top: 8px;">‚Ä¢ Papiers matifiants dans la journ√©e</p>
                                <p style="color: #5c677d;">‚Ä¢ Poudre translucide sur zone T</p>
                                <p style="color: #5c677d;">‚Ä¢ Ne jamais sur-nettoyer (effet rebond !)</p>
                            </div>
                        `;
                        break;
                
                    case 'points noirs':
                        routine += `
                            <div style="padding: 15px; background: white; border-radius: 12px;">
                                <strong style="color: #ff6b6b;">‚ö´ Points noirs</strong>
                                <p style="color: #5c677d; margin-top: 8px;">‚Ä¢ Nettoyage profond avec BHA (acide salicylique)</p>
                                <p style="color: #5c677d;">‚Ä¢ Masque au charbon 1x/semaine</p>
                                <p style="color: #5c677d;">‚Ä¢ Ne jamais extraire manuellement</p>
                            </div>
                        `;
                        break;
                
                    case 'pores dilates':
                        routine += `
                            <div style="padding: 15px; background: white; border-radius: 12px;">
                                <strong style="color: #ff6b6b;">üîç Pores dilat√©s</strong>
                                <p style="color: #5c677d; margin-top: 8px;">‚Ä¢ Tonique resserrant √† la niacinamide</p>
                                <p style="color: #5c677d;">‚Ä¢ Masque √† l'argile blanche hebdomadaire</p>
                                <p style="color: #5c677d;">‚Ä¢ Rin√ßage √† l'eau froide apr√®s nettoyage</p>
                            </div>
                        `;
                        break;
                }
            });
    
            routine += `
                    </div>
                </div>
            `;
        } else {
            console.log('Aucune pr√©occupation s√©lectionn√©e'); // Pour debug
        }

            // Conseils lifestyle personnalis√©s
            routine += `
                <div class="routine-item" style="background: linear-gradient(135deg, #fff0f8, #ffe6f2); border-left: 4px solid #e91e63;">
                    <h3 style="color: #c2185b; font-size: 1.3em; margin-bottom: 20px;">
                        üíù Tes boosters beaut√© personnalis√©s
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
            `;

            // Conseils selon le niveau de stress
            if (stressLevel > 7) {
                routine += `
                    <div style="padding: 12px; background: white; border-radius: 12px; text-align: center;">
                        <span style="font-size: 1.8em;">üòå</span>
                        <p style="color: #5c677d; margin-top: 5px; font-weight: 500;">Anti-stress</p>
                        <p style="color: #8e9aaf; font-size: 0.85em;">5 min de respiration profonde avant de dormir</p>
                    </div>
                `;
            }

            // Conseils selon l'√¢ge
            if (age < 25) {
                routine += `
                    <div style="padding: 12px; background: white; border-radius: 12px; text-align: center;">
                        <span style="font-size: 1.8em;">üå±</span>
                        <p style="color: #5c677d; margin-top: 5px; font-weight: 500;">Pr√©vention</p>
                        <p style="color: #8e9aaf; font-size: 0.85em;">Commence doucement avec les actifs</p>
                    </div>
                `;
            } else if (age >= 25 && age < 35) {
                routine += `
                    <div style="padding: 12px; background: white; border-radius: 12px; text-align: center;">
                        <span style="font-size: 1.8em;">‚ö°</span>
                        <p style="color: #5c677d; margin-top: 5px; font-weight: 500;">Boost collag√®ne</p>
                        <p style="color: #8e9aaf; font-size: 0.85em;">Vitamine C + peptides essentiels</p>
                    </div>
                `;
            } else {
                routine += `
                    <div style="padding: 12px; background: white; border-radius: 12px; text-align: center;">
                        <span style="font-size: 1.8em;">üíé</span>
                        <p style="color: #5c677d; margin-top: 5px; font-weight: 500;">R√©g√©n√©ration</p>
                        <p style="color: #8e9aaf; font-size: 0.85em;">R√©tinol + acide hyaluronique</p>
                    </div>
                `;
            }

            routine += `
                <div style="padding: 12px; background: white; border-radius: 12px; text-align: center;">
                    <span style="font-size: 1.8em;">üíß</span>
                    <p style="color: #5c677d; margin-top: 5px; font-weight: 500;">Hydratation</p>
                    <p style="color: #8e9aaf; font-size: 0.85em;">2L d'eau/jour minimum</p>
                </div>
                <div style="padding: 12px; background: white; border-radius: 12px; text-align: center;">
                    <span style="font-size: 1.8em;">üò¥</span>
                    <p style="color: #5c677d; margin-top: 5px; font-weight: 500;">Sommeil beaut√©</p>
                    <p style="color: #8e9aaf; font-size: 0.85em;">7-8h pour r√©g√©n√©rer</p>
                </div>
                <div style="padding: 12px; background: white; border-radius: 12px; text-align: center;">
                    <span style="font-size: 1.8em;">ü•ó</span>
                    <p style="color: #5c677d; margin-top: 5px; font-weight: 500;">Alimentation</p>
                    <p style="color: #8e9aaf; font-size: 0.85em;">Om√©ga-3 & antioxydants</p>
                </div>
            `;

            routine += `
                    </div>
                </div>
            `;

            // Rappel hebdomadaire
            routine += `
                <div class="routine-item" style="background: linear-gradient(135deg, #e8f5e9, #dff2df); border-left: 4px solid #4caf50;">
                    <h3 style="color: #388e3c; font-size: 1.3em; margin-bottom: 15px;">
                        üìÖ Ta routine hebdomadaire
                    </h3>
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: #4caf50; font-weight: bold;">Lundi & Jeudi:</span>
                            <span style="color: #5c677d;">Exfoliation douce (AHA/BHA)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: #4caf50; font-weight: bold;">Mercredi:</span>
                            <span style="color: #5c677d;">Masque hydratant/purifiant (15 min)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: #4caf50; font-weight: bold;">Dimanche:</span>
                            <span style="color: #5c677d;">Journ√©e d√©tox - routine minimaliste</span>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('routineContent').innerHTML = routine;
            showRoutine();
        }

        function showRoutine() {
            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep = 4;
            updateProgress();
            document.getElementById('result').classList.add('active');
            showNotification('üéâ Ta routine est pr√™te !');
        }

        // Fonction pour retourner au dashboard
        function showDashboard() {
            console.log('üè† Retour au dashboard');
    
            // R√©afficher le titre et la barre de progression
            const h1 = document.querySelector('.container h1');
            const subtitle = document.querySelector('.subtitle');
            const progressBar = document.getElementById('progressBar');
    
            if (h1) h1.style.display = 'block';
            if (subtitle) subtitle.style.display = 'block';
            if (progressBar) progressBar.style.display = 'flex';
    
            // Cacher photoAISection
            const photoSection = document.getElementById('photoAISection');
            if (photoSection) {
                photoSection.style.display = 'none';
                photoSection.classList.remove('active');
            }
    
            // Arr√™ter toute analyse en cours
            const resultsDiv = document.getElementById('photoAnalysisResults');
            if (resultsDiv) {
                resultsDiv.innerHTML = '';
                resultsDiv.style.display = 'none';
            }
    
            // Cacher toutes les sections SANS toucher au display
            document.querySelectorAll('.section').forEach(s => {
                s.classList.remove('active');
                // ‚úÖ NE PAS METTRE display: none ici
            });
    
            // Afficher le dashboard
            const dashboard = document.getElementById('result');
            if (dashboard) {
                dashboard.classList.add('active');
                dashboard.style.display = 'block'; // Forcer l'affichage
                window.scrollTo(0, 0);
            }
            checkDailyReminders();
        }
        // Fonction pour afficher la section Photos
function showPhotos() {
    console.log('üì∏ Affichage section photos');
    
    // R√©afficher titre et progression
    const h1 = document.querySelector('.container h1');
    const subtitle = document.querySelector('.subtitle');
    const progressBar = document.getElementById('progressBar');
    
    if (h1) h1.style.display = 'block';
    if (subtitle) subtitle.style.display = 'block';
    if (progressBar) progressBar.style.display = 'flex';
    
    // Cacher photoAISection
    const photoSection = document.getElementById('photoAISection');
    if (photoSection) {
        photoSection.style.display = 'none';
        photoSection.classList.remove('active');
    }
    
    // Arr√™ter toute analyse en cours
    const resultsDiv = document.getElementById('photoAnalysisResults');
    if (resultsDiv) {
        resultsDiv.innerHTML = '';
        resultsDiv.style.display = 'none';
    }
    
    // Cacher TOUTES les sections
    document.querySelectorAll('.section').forEach(s => {
        s.classList.remove('active');
        s.style.display = 'none';
    });
    
    // Afficher la galerie photos (ID = 'photos' pas 'photosSection')
    const photosSection = document.getElementById('photos');
    if (photosSection) {
        photosSection.classList.add('active');
        photosSection.style.display = 'block';
        window.scrollTo(0, 0);
    }
}    

        function showCheckIn() {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';  // IMPORTANT
            });
    
            const checkinSection = document.getElementById('checkin');
            if (checkinSection) {
                checkinSection.classList.add('active');
                checkinSection.style.display = 'block';  // ‚Üê AJOUTER CETTE LIGNE
            }
            loadPredictedScore();
        }

        function showAnalytics() {
            console.log('üìä Affichage Analytics');
    
            // Cacher toutes les sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
    
            // Afficher la section analytics
            const analyticsSection = document.getElementById('analytics');
            if (analyticsSection) {
                analyticsSection.classList.add('active');
                analyticsSection.style.display = 'block';
            }
    
            // Charger les donn√©es
            loadAnalytics();
    
            window.scrollTo(0, 0);
        }

        function showAIAssistant() {
            // Recharger le profil depuis localStorage avant d'afficher l'assistant
            const savedProfile = localStorage.getItem('skinProfile');
            if (savedProfile) {
                const profile = JSON.parse(savedProfile);
                skinType = profile.skinType || '';
                concerns = profile.concerns || [];
            }
    
            document.getElementById('analytics').classList.remove('active');
            document.getElementById('ai-assistant').classList.add('active');
            showNotification('‚ú® Assistant beaut√© activ√© !');
        }


        async function submitCheckIn() {
            // V√©rifier les limites
            if (!canUseFeature('checkIn')) {
                showPremiumModal('Check-ins illimit√©s');
                return;
            }
            const skinCondition = document.getElementById('checkinSkinCondition').value;
            const sleepHours = document.getElementById('sleepHours').value;
            const stressLevel = document.getElementById('checkinStressLevel').value;
    
            const checkin = {
                skin_condition: parseInt(skinCondition),
                stress_level: parseInt(stressLevel),
                sleep_hours: parseInt(sleepHours)
            };
    
             //Enregistrer via API
            try {
                showNotification('üîÑ Enregistrement...');
                await submitDailyCheckIn(checkin);
                showNotification('‚úÖ Check-in enregistr√© !');
                // Cacher la banni√®re de rappel
                const banner = document.getElementById('reminderBanner');
                if (banner) {
                    banner.style.display = 'none';
                }
                // Afficher le score pr√©dit mis √† jour
                const prediction = await loadPredictedScore();
                if (prediction) {
                    setTimeout(() => {
                        if (prediction.bonus > 0) {
                            showNotification(`üîÆ Score pr√©dit : ${prediction.predicted_score}/100 (+${prediction.bonus} gr√¢ce √† tes habitudes !)`);
                        } else if (prediction.bonus < 0) {
                            showNotification(`üîÆ Score pr√©dit : ${prediction.predicted_score}/100 (${prediction.bonus} - am√©liore tes habitudes !)`);
                        } else {
                            showNotification(`üîÆ Score pr√©dit : ${prediction.predicted_score}/100`);
                        }
                    }, 2500);
                }
             // Sauvegarder localement aussi
                checkin.date = new Date().toLocaleDateString();
                checkinsHistory.push(checkin);
                localStorage.setItem('checkinsHistory', JSON.stringify(checkinsHistory));
            } catch (error) {
                showNotification('‚ùå Erreur : ' + error.message);
            }
    
            document.getElementById('skinCondition').value = 5;
            document.getElementById('sleepHours').value = 7;
            updateSkinDisplay();
            // Utiliser un cr√©dit si gratuit
            useFeature('checkIn');
        }

        async function loadPredictedScore() {
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
    
            if (!currentUser.id) {
                return null;
            }
    
            try {
                const response = await fetch(`http://127.0.0.1:8000/api/v2/predicted-score/${currentUser.id}`);
                const data = await response.json();
        
                console.log('üîÆ Score pr√©dit re√ßu:', data);
        
                if (data.success && data.prediction) {
                    // Mettre √† jour la carte
                    displayPredictedScoreCard(data.prediction);
                    return data.prediction;
                }
        
                return null;
        
            } catch (error) {
                console.error('‚ùå Erreur chargement score pr√©dit:', error);
                return null;
            }
        }

        async function checkDailyReminders() {
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
    
            if (!currentUser.id) {
                return;
            }
    
            try {
                // V√©rifier le dernier check-in
                const response = await fetch(`http://127.0.0.1:8000/api/v2/last-checkin/${currentUser.id}`);
                const data = await response.json();
        
                console.log('üîî V√©rification rappels:', data);
        
                const banner = document.getElementById('reminderBanner');
                const message = document.getElementById('reminderMessage');
        
                if (banner && data.success) {
                    if (!data.has_checkin_today) {
                        // Pas de check-in aujourd'hui ‚Üí afficher le rappel
                        banner.style.display = 'block';
                        message.textContent = data.message;
                    } else {
                        // Check-in d√©j√† fait ‚Üí cacher le rappel
                        banner.style.display = 'none';
                    }
                }
        
            } catch (error) {
                console.error('‚ùå Erreur v√©rification rappels:', error);
            }
        }

        async function loadBeforeAfter() {
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
    
            if (!currentUser.id) {
                showNotification('‚ùå Connecte-toi pour voir ta progression');
                return;
            }
    
            const content = document.getElementById('beforeAfterContent');
            content.innerHTML = '<p style="color: #718096; text-align: center;">Chargement...</p>';
    
            try {
                const response = await fetch(`http://127.0.0.1:8000/api/v2/before-after/${currentUser.id}`);
                const data = await response.json();
        
                console.log('üì∏ Comparaison avant/apr√®s:', data);
        
                if (!data.success) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #718096;">
                            <div style="font-size: 3em; margin-bottom: 10px;">üì∑</div>
                            <p>${data.message}</p>
                        </div>
                    `;
                    return;
                }
        
                // Calculer la couleur selon la progression
                let progressColor = '#667eea';
                let progressIcon = '‚û°Ô∏è';
                if (data.progression > 0) {
                    progressColor = '#38a169';
                    progressIcon = 'üìà';
                } else if (data.progression < 0) {
                    progressColor = '#e53e3e';
                    progressIcon = 'üìâ';
                }
        
                // Formater les dates
                const beforeDate = new Date(data.before.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
                const afterDate = new Date(data.after.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
        
                content.innerHTML = `
                        <!-- Message de progression -->
                        <div style="text-align: center; padding: 15px; background: ${progressColor}22; border-radius: 10px; margin-bottom: 20px;">
                            <span style="font-size: 1.5em;">${progressIcon}</span>
                            <span style="color: ${progressColor}; font-weight: bold; font-size: 1.1em;">${data.message}</span>
                        </div>
            
                        <!-- Comparaison c√¥te √† c√¥te -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <!-- AVANT -->
                            <div style="text-align: center;">
                                <div style="font-weight: bold; color: #e53e3e; margin-bottom: 10px;">AVANT</div>
                                <div style="font-size: 0.85em; color: #718096; margin-bottom: 10px;">${beforeDate}</div>
                                ${data.before.photo ? 
                                    `<img src="data:image/jpeg;base64,${data.before.photo}" style="width: 100%; border-radius: 10px; margin-bottom: 10px;">` : 
                                    `<div style="width: 100%; height: 150px; background: #e2e8f0; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">üì∑</div>`
                                }
                                <div style="font-size: 2em; font-weight: bold; color: #e53e3e;">${data.before.score}/100</div>
                            </div>
                
                            <!-- APR√àS -->
                            <div style="text-align: center;">
                                <div style="font-weight: bold; color: #38a169; margin-bottom: 10px;">APR√àS</div>
                                <div style="font-size: 0.85em; color: #718096; margin-bottom: 10px;">${afterDate}</div>
                                ${data.after.photo ? 
                                    `<img src="data:image/jpeg;base64,${data.after.photo}" style="width: 100%; border-radius: 10px; margin-bottom: 10px;">` : 
                                    `<div style="width: 100%; height: 150px; background: #e2e8f0; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">üì∑</div>`
                                }
                                <div style="font-size: 2em; font-weight: bold; color: #38a169;">${data.after.score}/100</div>
                            </div>
                        </div>
                `;
        
            } catch (error) {
                console.error('‚ùå Erreur chargement avant/apr√®s:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e53e3e;">
                        <p>Erreur lors du chargement</p>
                    </div>
                `;
            }
        }

        function updateStressDisplay() {
            const value = document.getElementById('stressLevel').value;
            document.getElementById('stressDisplay').textContent = value + ' / 10';
        }

        function updateCheckinStressDisplay() {
            const value = document.getElementById('checkinStressLevel').value;
            document.getElementById('checkinStressDisplay').textContent = value + ' / 10';
        }

        function updateCheckinSkinDisplay() {
            const value = document.getElementById('checkinSkinCondition').value;
            document.getElementById('checkinSkinDisplay').textContent = value + ' / 10';
        }

function displayPredictedScoreCard(prediction) {
    if (!prediction) return;
    
    // Score
    const scoreEl = document.getElementById('predictedScoreValue');
    if (scoreEl) {
        scoreEl.textContent = prediction.predicted_score + '/100';
        
        // Couleur selon le bonus
        if (prediction.bonus > 0) {
            scoreEl.style.color = '#38a169';
        } else if (prediction.bonus < 0) {
            scoreEl.style.color = '#e53e3e';
        } else {
            scoreEl.style.color = '#667eea';
        }
    }
    
    // Message
    const messageEl = document.getElementById('predictedScoreMessage');
    if (messageEl) {
        messageEl.textContent = prediction.message;
        
        if (prediction.bonus > 0) {
            messageEl.style.background = '#c6f6d522';
            messageEl.style.color = '#38a169';
        } else if (prediction.bonus < 0) {
            messageEl.style.background = '#fed7d722';
            messageEl.style.color = '#e53e3e';
        } else {
            messageEl.style.background = '#667eea22';
            messageEl.style.color = '#4a5568';
        }
    }
    
    // Facteurs
    const factorsEl = document.getElementById('predictedScoreFactors');
    if (factorsEl && prediction.factors && prediction.factors.length > 0) {
        factorsEl.innerHTML = prediction.factors.map(f => `
            <div style="display: flex; justify-content: space-between; align-items: center; 
                        padding: 10px; background: white; border-radius: 8px; margin-bottom: 8px;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <span>${f.message}</span>
                <span style="font-weight: bold; color: ${f.impact.startsWith('+') ? '#38a169' : '#e53e3e'};">
                    ${f.impact}
                </span>
            </div>
        `).join('');
    } else if (factorsEl) {
        factorsEl.innerHTML = '';
    }
}

        function selectPhotoType(type) {
            photoType = type;
            document.querySelectorAll('.photo-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
        }

        function uploadPhoto(event) {
            // V√©rifier les limites
            if (!canUseFeature('photo')) {
                showPremiumModal('Photos illimit√©es');
                return;
            }
    
            const file = event.target.files[0];
            if (file) {
                useFeature('photo');
                showNotification('üì∏ Photo ajout√©e avec succ√®s !');
            }
        }

async function loadAnalytics() {
    const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
    
    if (!currentUser.id) {
        console.log('‚ùå Utilisateur non connect√©');
        document.getElementById('statsOverview').innerHTML = `
            <div style="grid-column: span 2; text-align: center; padding: 30px; color: #718096;">
                <p>Connectez-vous pour voir vos analytics</p>
            </div>
        `;
        return;
    }
    
    try {
        // R√©cup√©rer les statistiques
        const response = await fetch(`http://127.0.0.1:8000/api/v2/analysis-stats/${currentUser.id}`);
        const data = await response.json();
        
        console.log('üìä Stats re√ßues:', data);
        
        if (data.success && data.stats) {
            const stats = data.stats;
            
            // Mettre √† jour les statistiques
            document.getElementById('statTotalAnalyses').textContent = stats.total_analyses || 0;
            document.getElementById('statAverageScore').textContent = stats.average_score || '--';
            document.getElementById('statLatestScore').textContent = stats.latest_score || '--';
            
            // Progression avec couleur
            const progression = stats.progression || 0;
            const progressionEl = document.getElementById('statProgression');
            if (progression > 0) {
                progressionEl.textContent = `+${progression}`;
                progressionEl.parentElement.style.background = 'linear-gradient(135deg, #43e97b, #38f9d7)';
            } else if (progression < 0) {
                progressionEl.textContent = `${progression}`;
                progressionEl.parentElement.style.background = 'linear-gradient(135deg, #f5576c, #f093fb)';
            } else {
                progressionEl.textContent = '0';
            }
            
            // Afficher la tendance
            if (stats.total_analyses >= 2) {
                const trendSection = document.getElementById('trendSection');
                const trendMessage = document.getElementById('trendMessage');
                trendSection.style.display = 'block';
                
                if (stats.trend === 'improving') {
                    trendMessage.innerHTML = 'üéâ <strong style="color: #38a169;">Ta peau s\'am√©liore !</strong> Continue comme √ßa, ta routine fonctionne bien.';
                } else if (stats.trend === 'declining') {
                    trendMessage.innerHTML = '‚ö†Ô∏è <strong style="color: #e53e3e;">Attention</strong>, ton score diminue. V√©rifie ta routine et ton hygi√®ne de vie.';
                } else {
                    trendMessage.innerHTML = '‚û°Ô∏è <strong style="color: #667eea;">Score stable</strong>. Continue ta routine actuelle pour maintenir ces r√©sultats.';
                }
            }
            
            // G√©n√©rer le graphique
            if (stats.history && stats.history.length > 0) {
                generateProgressionChart(stats.history);
            }
            
            // Charger l'historique d√©taill√©
            loadAnalysisHistory(currentUser.id);
        }
        
    } catch (error) {
        console.error('‚ùå Erreur chargement analytics:', error);
    }
}

function generateProgressionChart(history) {
    const chartContainer = document.getElementById('progressionChart');
    const labelsContainer = document.getElementById('chartLabels');
    
    // Inverser pour avoir du plus ancien au plus r√©cent
    const sortedHistory = [...history].reverse().slice(-7); // Max 7 derni√®res analyses
    
    if (sortedHistory.length === 0) {
        chartContainer.innerHTML = '<p style="color: #a0aec0; text-align: center; width: 100%;">Pas encore de donn√©es</p>';
        return;
    }
    
    // Trouver le max pour la normalisation
    const maxScore = 100;
    
    // G√©n√©rer les barres
    let barsHTML = '';
    let labelsHTML = '';
    
    sortedHistory.forEach((analysis, index) => {
        const score = analysis.global_score || 0;
        const heightPercent = (score / maxScore) * 100;
        const date = new Date(analysis.analysis_date);
        const dateStr = `${date.getDate()}/${date.getMonth() + 1}`;
        
        // Couleur selon le score
        let barColor = '#43e97b'; // Vert
        if (score < 50) barColor = '#f5576c'; // Rouge
        else if (score < 70) barColor = '#ffa726'; // Orange
        else if (score < 85) barColor = '#667eea'; // Bleu
        
        barsHTML += `
            <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                <div style="font-size: 0.8em; color: #4a5568; margin-bottom: 5px;">${score}</div>
                <div style="width: 100%; max-width: 40px; height: ${heightPercent}%; min-height: 20px; 
                            background: linear-gradient(to top, ${barColor}, ${barColor}dd); 
                            border-radius: 8px 8px 0 0; transition: height 0.5s ease;"></div>
            </div>
        `;
        
        labelsHTML += `<div style="flex: 1; text-align: center;">${dateStr}</div>`;
    });
    
    chartContainer.innerHTML = barsHTML;
    labelsContainer.innerHTML = labelsHTML;
}

async function loadAnalysisHistory(userId) {
    try {
        const response = await fetch(`http://127.0.0.1:8000/api/v2/analysis-history/${userId}?limit=10`);
        const data = await response.json();
        
        const historyContainer = document.getElementById('analysisHistory');
        
        if (data.success && data.history && data.history.length > 0) {
            let historyHTML = '';
            
            data.history.forEach(analysis => {
                const date = new Date(analysis.analysis_date);
                const dateStr = date.toLocaleDateString('fr-FR', { 
                    day: 'numeric', 
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const score = analysis.global_score;
                let scoreColor = '#43e97b';
                if (score < 50) scoreColor = '#f5576c';
                else if (score < 70) scoreColor = '#ffa726';
                else if (score < 85) scoreColor = '#667eea';
                
                const problems = analysis.problems_detected || [];
                const problemsText = problems.length > 0 
                    ? `${problems.length} probl√®me(s) d√©tect√©(s)` 
                    : 'Aucun probl√®me d√©tect√©';
                
                historyHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; 
                                padding: 15px; border-bottom: 1px solid #e2e8f0;">
                        <div>
                            <div style="font-weight: bold; color: #2d3748;">${dateStr}</div>
                            <div style="font-size: 0.85em; color: #718096;">${problemsText}</div>
                        </div>
                        <div style="background: ${scoreColor}; color: white; padding: 8px 15px; 
                                    border-radius: 20px; font-weight: bold;">
                            ${score}/100
                        </div>
                    </div>
                `;
            });
            
            historyContainer.innerHTML = historyHTML;
        } else {
            historyContainer.innerHTML = '<p style="color: #a0aec0; text-align: center;">Aucune analyse pour le moment</p>';
        }
        
    } catch (error) {
        console.error('‚ùå Erreur chargement historique:', error);
    }
}

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // === ASSISTANT IA INTELLIGENT ===
        async function generateRecommendations() {
            // FORCER le chargement du profil depuis localStorage
            const savedProfile = localStorage.getItem('skinProfile');
            if (!savedProfile) {
                const output = document.getElementById('aiOutput');
                output.innerHTML = '<p style="text-align:center; color:#ff6b6b;">Cr√©e d\'abord ton profil de peau !</p>';
                return;
            }
    
            // Charger les donn√©es du profil
            const profile = JSON.parse(savedProfile);
            skinType = profile.skinType;
            concerns = profile.concerns;
    
            console.log('Profil charg√© pour IA:', skinType, concerns);
    
            const output = document.getElementById('aiOutput');
            output.classList.add('active');
    
            showAILoading();
    
            // Utiliser un setTimeout pour √©viter le flash
            setTimeout(() => {
                // G√©n√©rer directement les recommandations locales
                const localData = generateLocalRecommendations();
                if (localData && localData.recommendations) {
                displayRecommendations(localData.recommendations);
                }
            }, 1500); // D√©lai pour montrer le chargement
        }

        function generatePredictions() {
    // FORCER le chargement du profil
            const savedProfile = localStorage.getItem('skinProfile');
            if (!savedProfile) {
                const output = document.getElementById('aiOutput');
                output.innerHTML = '<p style="text-align:center; color:#ff6b6b;">Cr√©e d\'abord ton profil de peau !</p>';
                return;
            }
    
            const profile = JSON.parse(savedProfile);
            skinType = profile.skinType;
            concerns = profile.concerns;
    
            const output = document.getElementById('aiOutput');
            output.classList.add('active');
    
            showAILoading();
            
            setTimeout(() => {
                // V√©rifier si un profil existe
                if (!skinType) {
                    output.innerHTML = '<p style="text-align:center; color:#ff6b6b;">Cr√©e d\'abord ton profil pour voir les pr√©dictions !</p>';
                    return;
                }
                
                // Si pas assez de donn√©es, on simule
                if (!checkinsHistory || checkinsHistory.length === 0) {
                    checkinsHistory = [
                        {skinCondition: 5, stressLevel: 7, date: new Date()},
                        {skinCondition: 5.5, stressLevel: 6, date: new Date()},
                        {skinCondition: 6, stressLevel: 6, date: new Date()}
                    ];
                }
                
                const predictions = predictFutureResults(checkinsHistory);
                displayPredictions(predictions);
            }, 2500);
        }

        function generateInsights() {
            // FORCER le chargement du profil
            const savedProfile = localStorage.getItem('skinProfile');
            if (!savedProfile) {
                const output = document.getElementById('aiOutput');
                output.innerHTML = '<p style="text-align:center; color:#ff6b6b;">Cr√©e d\'abord ton profil de peau !</p>';
                return;
            }
    
            const profile = JSON.parse(savedProfile);
            skinType = profile.skinType;
            concerns = profile.concerns;
    
            const output = document.getElementById('aiOutput');
            output.classList.add('active');
    
            showAILoading();
    
            setTimeout(() => {
        
                // V√©rifier si un profil existe
                if (!skinType) {
                    output.innerHTML = '<p style="text-align:center; color:#ff6b6b;">Cr√©e d\'abord ton profil pour obtenir des insights !</p>';
                    return;
                }
                
                const insights = generatePersonalInsights(checkinsHistory, skinType, concerns);
                displayInsights(insights);
            }, 2000);
        }

        function generateTips() {
            // FORCER le chargement du profil
            const savedProfile = localStorage.getItem('skinProfile');
            if (!savedProfile) {
                const output = document.getElementById('aiOutput');
                output.innerHTML = '<p style="text-align:center; color:#ff6b6b;">Cr√©e d\'abord ton profil de peau !</p>';
                return;
            }
    
            const profile = JSON.parse(savedProfile);
            skinType = profile.skinType;
            concerns = profile.concerns;
    
            const output = document.getElementById('aiOutput');
            output.classList.add('active');
    
            showAILoading();
    
            setTimeout(() => {
        
                // V√©rifier si un profil existe
                if (!skinType) {
                    output.innerHTML = '<p style="text-align:center; color:#ff6b6b;">Cr√©e d\'abord ton profil pour recevoir des conseils !</p>';
                    return;
                }
                
                const tips = generateAdaptiveTips(checkinsHistory, skinType, concerns);
                displayTips(tips);
            }, 1500);
        }

        function showAILoading() {
            const output = document.getElementById('aiOutput');
            output.innerHTML = `
                <div class="ai-loading">
                    <i class="fas fa-spinner"></i>
                    <p>J'analyse tes donn√©es avec bienveillance...</p>
                </div>
            `;
        }

        // Fonctions d'analyse IA
        function analyzeAndRecommend(profile, checkins) {
            const recommendations = [];
            
            if (profile.skinType === 'grasse' || profile.concerns.includes('acne')) {
                recommendations.push({
                    product: 'Niacinamide 10% + Zinc 1%',
                    brand: 'The Ordinary',
                    price: '12‚Ç¨',
                    reason: 'R√©duit la production de s√©bum et les imperfections',
                    urgency: 'high'
                });
            }
            
            if (profile.skinType === 's√®che' || profile.concerns.includes('s√©cheresse')) {
                recommendations.push({
                    product: 'Cr√®me Hydratante C√©ramides',
                    brand: 'CeraVe',
                    price: '15‚Ç¨',
                    reason: 'Restaure la barri√®re cutan√©e',
                    urgency: 'high'
                });
            }
            
            if (profile.concerns.includes('rides') || profile.concerns.includes('taches pigmentaires')) {
                recommendations.push({
                    product: 'S√©rum Vitamine C 20%',
                    brand: 'Skinceuticals',
                    price: '95‚Ç¨',
                    reason: 'Anti-√¢ge et √©claircissant',
                    urgency: 'medium'
                });
            }
            
            recommendations.push({
                product: 'SPF 50+ Fluide Invisible',
                brand: 'La Roche-Posay',
                price: '18‚Ç¨',
                reason: 'Protection UV essentielle',
                urgency: 'high'
            });
            
            return recommendations;
        }

        function predictFutureResults(checkins) {
            const hasData = checkins && checkins.length > 0;
            const currentScore = hasData ? 
                checkins[checkins.length - 1].skinCondition : 5;
            
            const predictions = {
                currentScore: currentScore,
                dataQuality: checkins.length > 10 ? 'Excellente' : 
                             checkins.length > 5 ? 'Bonne' : 
                             checkins.length > 2 ? 'Moyenne' : 'Faible',
                trend: 'Am√©lioration',
                predictions: [
                    {
                        period: '2 semaines',
                        score: Math.min(10, currentScore + 1),
                        confidence: 85,
                        description: 'Peau plus √©quilibr√©e, moins d\'imperfections'
                    },
                    {
                        period: '1 mois',
                        score: Math.min(10, currentScore + 2),
                        confidence: 75,
                        description: 'Texture affin√©e, √©clat naturel visible'
                    },
                    {
                        period: '3 mois',
                        score: Math.min(10, currentScore + 3),
                        confidence: 65,
                        description: 'Transformation compl√®te, peau rayonnante'
                    }
                ]
            };
            
            return predictions;
        }

        function generatePersonalInsights(checkins, skinType, concerns) {
            const insights = [];
            
            if (checkins.length > 5) {
                const avgSkin = checkins.reduce((acc, c) => acc + c.skinCondition, 0) / checkins.length;
                if (avgSkin > 7) {
                    insights.push({
                        type: 'positive',
                        title: 'üéâ Excellents progr√®s !',
                        content: 'Ta peau s\'am√©liore constamment. Continue cette routine !'
                    });
                }
            }
            
            if (concerns.includes('acne')) {
                insights.push({
                    type: 'warning',
                    title: '‚ö†Ô∏è Attention aux produits com√©dog√®nes',
                    content: '√âvite les huiles min√©rales et privil√©gie les formules non-com√©dog√®nes'
                });
            }
            
            insights.push({
                type: 'info',
                title: 'üí° Astuce du jour',
                content: 'Change ta taie d\'oreiller 2x/semaine pour √©viter l\'accumulation de bact√©ries'
            });
            
            return insights;
        }

        function generateAdaptiveTips(checkins, skinType, concerns) {
            const tips = [];
            
            tips.push({
                icon: 'üíß',
                title: 'Hydratation optimale',
                content: 'Bois au moins 2L d\'eau par jour pour une peau hydrat√©e de l\'int√©rieur',
                priority: 'high'
            });
            
            if (skinType === 'grasse') {
                tips.push({
                    icon: 'üßº',
                    title: 'Double nettoyage',
                    content: 'Le soir, utilise d\'abord une huile nettoyante puis un gel moussant',
                    priority: 'medium'
                });
            }
            
            tips.push({
                icon: 'üò¥',
                title: 'Sommeil r√©parateur',
                content: 'Vise 7-8h de sommeil pour permettre √† ta peau de se r√©g√©n√©rer',
                priority: 'high'
            });
            
            tips.push({
                icon: 'ü•ó',
                title: 'Alimentation beaut√©',
                content: 'Privil√©gie les aliments riches en om√©ga-3 et antioxydants',
                priority: 'medium'
            });
            
            return tips;
        }

        function displayRecommendations(recommendations) {
            const output = document.getElementById('aiOutput');
            let html = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h3><i class="fas fa-shopping-cart"></i> Recommandations Personnalis√©es</h3>
                    <p>Bas√©es sur ton type de peau ${skinType || ''} et tes pr√©occupations</p>
                </div>
            `;
    
            recommendations.forEach(rec => {
        // Les donn√©es sont dans rec.product
                const product = rec.product;
                const productName = product.name || product;
                const productPrice = product.price ? product.price + (typeof product.price === 'number' ? '‚Ç¨' : '') : '12‚Ç¨';
                const productRating = product.rating;
                const productDescription = product.description || '';
                const category = rec.category || 'Soin';
                const reasons = rec.reasons || [rec.reason];
                const urgency = rec.urgency || 'medium';
                const matchScore = rec.match_score;
        
                html += `
                    <div class="ai-recommendation" style="background: white; border-radius: 15px; padding: 20px; margin: 15px 0; border-left: 4px solid #ff6b6b; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong style="color: #2d3748; font-size: 1.1em;">${productName}</strong>
                            <span style="background: ${urgency === 'high' ? '#f56565' : urgency === 'medium' ? '#ed8936' : '#48bb78'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8em;">
                                ${urgency === 'high' ? 'Priorit√©' : urgency === 'medium' ? 'Conseill√©' : 'Option'}
                            </span>
                        </div>
                        <p style="color: #718096; margin: 5px 0; font-size: 0.9em;">
                            <strong>Cat√©gorie:</strong> ${category} 
                            ${productRating ? `‚Ä¢ <strong>Note:</strong> ${productRating}/5 ‚≠ê` : ''}
                            ${matchScore ? `‚Ä¢ <strong>Compatibilit√©:</strong> ${matchScore}%` : ''}
                        </p>
                        ${reasons && reasons.length > 0 ? `
                            <p style="color: #4a5568; margin: 10px 0; padding: 10px; background: #f7fafc; border-radius: 8px;">
                                <strong>Pourquoi ce produit:</strong> ${Array.isArray(reasons) ? reasons.join(' ‚Ä¢ ') : reasons}
                            </p>
                        ` : ''}
                        ${productDescription ? `
                            <p style="color: #718096; margin: 8px 0; font-style: italic;">
                                ${productDescription}
                            </p>
                        ` : ''}
                        <p style="color: #667eea; font-weight: 700; font-size: 1.3em; margin-top: 10px;">
                            ${productPrice}
                        </p>
                    </div>
                `;
            });
    
            output.innerHTML = html;
            showNotification('üéØ Recommandations g√©n√©r√©es avec succ√®s !');
        }

        function displayPredictions(predictions) {
            const output = document.getElementById('aiOutput');
            
            let html = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h3><i class="fas fa-crystal-ball"></i> Pr√©dictions d'√âvolution</h3>
                    <p>Qualit√© des donn√©es: ${predictions.dataQuality} ‚Ä¢ Tendance: ${predictions.trend}</p>
                </div>
                <div class="ai-recommendation">
                    <div style="text-align: center;">
                        <div style="font-size: 3em; font-weight: 700; color: #667eea;">${predictions.currentScore}</div>
                        <div style="color: #718096;">√âtat actuel de ta peau</div>
                    </div>
                </div>
            `;
            
            predictions.predictions.forEach(pred => {
                html += `
                    <div class="ai-recommendation">
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: 700; color: #48bb78;">${pred.score}/10</div>
                            <div style="color: #718096; margin: 5px 0;">Dans ${pred.period}</div>
                            <div style="margin: 10px 0; color: #4a5568;">${pred.description}</div>
                            <div style="font-size: 0.9em; color: #718096;">Confiance: ${pred.confidence}%</div>
                        </div>
                    </div>
                `;
            });
            
            output.innerHTML = html;
            showNotification('üîÆ Pr√©dictions g√©n√©r√©es !');
        }

        function displayInsights(insights) {
            const output = document.getElementById('aiOutput');
            let html = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h3><i class="fas fa-lightbulb"></i> Insights Personnalis√©s</h3>
                    <p>Patterns d√©couverts dans tes donn√©es</p>
                </div>
            `;
            
            insights.forEach(insight => {
                const bgColor = insight.type === 'positive' ? '#f0fff4' : 
                               insight.type === 'warning' ? '#fff5f0' : '#fff0f8';
                const borderColor = insight.type === 'positive' ? '#66d9a0' : 
                                   insight.type === 'warning' ? '#ffb088' : '#ff6b6b';
                
                html += `
                    <div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 12px; padding: 20px; margin: 15px 0;">
                        <div style="font-weight: 700; color: #2d3748; margin-bottom: 8px;">${insight.title}</div>
                        <div style="color: #4a5568; line-height: 1.6;">${insight.content}</div>
                    </div>
                `;
            });
            
            output.innerHTML = html;
            showNotification('üí° Insights g√©n√©r√©s !');
        }

        function displayTips(tips) {
            const output = document.getElementById('aiOutput');
            let html = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h3><i class="fas fa-magic"></i> Conseils Adaptatifs</h3>
                    <p>Tips personnalis√©s pour optimiser ta routine</p>
                </div>
            `;
            
            tips.forEach(tip => {
                html += `
                    <div class="ai-recommendation">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="font-weight: 700; color: #2d3748; font-size: 1.1em;">${tip.icon} ${tip.title}</div>
                            <span style="background: ${tip.priority === 'high' ? '#48bb78' : '#ed8936'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8em;">
                                ${tip.priority === 'high' ? 'Priorit√©' : 'Conseil'}
                            </span>
                        </div>
                        <div style="color: #4a5568; line-height: 1.6;">${tip.content}</div>
                    </div>
                `;
            });
            
            output.innerHTML = html;
            showNotification('‚ú® Conseils adaptatifs g√©n√©r√©s !');
        }

        // === FONCTIONS CYCLE TRACKER (CORRECTION 1) ===
function showCycleTracker() {
    const savedProfile = localStorage.getItem('skinProfile');
    if (!savedProfile) {
        showNotification('‚ö†Ô∏è Cr√©e d\'abord ton profil !');
        return;
    }
    
    // Cacher titre et progression
    const h1 = document.querySelector('.container h1');
    const subtitle = document.querySelector('.subtitle');
    const progressBar = document.getElementById('progressBar');
    
    if (h1) h1.style.display = 'none';
    if (subtitle) subtitle.style.display = 'none';
    if (progressBar) progressBar.style.display = 'none';
    
    // Cacher toutes les sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
        section.style.display = 'none';
    });
    
    // Afficher le cycle tracker EN PLEIN √âCRAN
    const cycleSection = document.getElementById('cycleTrackerSection');
    if (cycleSection) {
        cycleSection.classList.add('active', 'fullscreen'); // ‚Üê AJOUTER 'fullscreen'
        cycleSection.style.display = 'block';
    }
}
        // === FONCTIONS MOOD TRACKER & PSYCHO-DERMATOLOGIE ===
        let currentMood = '';
        let currentMoodEmoji = '';
        let selectedTriggers = [];
        let moodHistory = [];

function showMoodTracker() {  
    const savedProfile = localStorage.getItem('skinProfile');
    if (!savedProfile) {
        showNotification('‚ö†Ô∏è Cr√©e d\'abord ton profil !');
        return;
    }
    
    // Cacher titre et progression
    const h1 = document.querySelector('.container h1');
    const subtitle = document.querySelector('.subtitle');
    const progressBar = document.getElementById('progressBar');
    
    if (h1) h1.style.display = 'none';
    if (subtitle) subtitle.style.display = 'none';
    if (progressBar) progressBar.style.display = 'none';
    
    // Cacher TOUTES les sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
        section.style.display = 'none';
    });
    
    // Afficher le mood tracker EN PLEIN √âCRAN
    const moodSection = document.getElementById('moodTrackerSection');
    if (moodSection) {
        moodSection.classList.add('active', 'fullscreen'); // ‚Üê AJOUTER 'fullscreen'
        moodSection.style.display = 'block';
        loadMoodHistory();
    }
}

        function selectMood(mood, emoji, element) {
            currentMood = mood;
            currentMoodEmoji = emoji;
    
            // Retirer toutes les s√©lections
            document.querySelectorAll('.mood-option').forEach(option => {
                option.classList.remove('selected');
            });
    
            // Ajouter la s√©lection
            element.classList.add('selected');
        }

        function toggleTrigger(trigger, element) {
            const index = selectedTriggers.indexOf(trigger);
            if (index > -1) {
                selectedTriggers.splice(index, 1);
                element.classList.remove('selected');
            } else {
                selectedTriggers.push(trigger);
                element.classList.add('selected');
            }
        }

        function saveMoodCheckIn() {
            if (!currentMood) {
                showNotification('‚ö†Ô∏è S√©lectionne ton humeur d\'abord !');
                return;
            }
    
            // R√©cup√©rer l'identifiant unique de l'utilisateur
            const userProfile = JSON.parse(localStorage.getItem('skinProfile') || '{}');
            const userId = userProfile.email || userProfile.name || 'default';
    
            const sleepQuality = document.getElementById('sleepQuality').value;
            const anxietyLevel = document.getElementById('anxietyLevel').value;
    
            const moodData = {
                date: new Date().toLocaleDateString(),
                timestamp: new Date().toISOString(),
                mood: currentMood,
                moodEmoji: currentMoodEmoji,
                moodScore: getMoodScore(currentMood),
                sleepQuality: parseInt(sleepQuality),
                anxietyLevel: parseInt(anxietyLevel),
                triggers: selectedTriggers,
                skinCondition: localStorage.getItem('lastSkinCondition') || 5,
                userId: userId  // Ajouter l'ID utilisateur
            };
    
            // Charger l'historique SP√âCIFIQUE √† cet utilisateur
            const storageKey = `moodHistory_${userId}`;
            const existingHistory = JSON.parse(localStorage.getItem(storageKey) || '[]');
            existingHistory.push(moodData);
            localStorage.setItem(storageKey, JSON.stringify(existingHistory));
    
            // Mettre √† jour moodHistory pour l'affichage
            moodHistory = existingHistory;
    
            showNotification('‚úÖ Mood check-in enregistr√© !');
    
            // R√©initialiser
            currentMood = '';
            currentMoodEmoji = '';
            selectedTriggers = [];
            document.querySelectorAll('.mood-option').forEach(o => o.classList.remove('selected'));
            document.querySelectorAll('.trigger-btn').forEach(b => b.classList.remove('selected'));
    
            // Afficher l'analyse
            document.getElementById('moodAnalysis').style.display = 'block';
            generatePsychoAnalysis();
        }

        function getMoodScore(mood) {
            const scores = {
                'tr√®s mal': 1,
                'mal': 3,
                'neutre': 5,
                'bien': 7,
                'tr√®s bien': 9
            };
            return scores[mood] || 5;
        }

        function loadMoodHistory() {
            // Charger uniquement les donn√©es de l'utilisateur actuel
            const userProfile = JSON.parse(localStorage.getItem('skinProfile') || '{}');
            const userId = userProfile.email || userProfile.name || 'default';
            const storageKey = `moodHistory_${userId}`;
    
            const saved = localStorage.getItem(storageKey);
            if (saved) {
                moodHistory = JSON.parse(saved);
            } else {
                moodHistory = [];
            }
    
            console.log(`Donn√©es mood charg√©es pour ${userId}:`, moodHistory.length, 'entr√©es');
        }

        function generatePsychoAnalysis() {
            // Analyse de corr√©lation
            generateCorrelationChart();
    
            // Insights psycho-dermatologiques
            generatePsychoDermaInsights();
    
            // Recommandations holistiques
            generateHolisticRecommendations();
        }

        function generateCorrelationChart() {
            const chartDiv = document.getElementById('correlationChart');
    
            // Prendre les 7 derniers jours
            const recentData = moodHistory.slice(-7);
    
            if (recentData.length === 0) {
                chartDiv.innerHTML = '<p style="text-align: center; color: #718096;">Pas encore assez de donn√©es</p>';
                return;
            }
    
            // Cr√©er un graphique simple en barres
            let chartHtml = '<div style="display: flex; align-items: flex-end; justify-content: space-around; height: 200px; border-bottom: 2px solid #e2e8f0;">';
    
            recentData.forEach(data => {
                const moodHeight = data.moodScore * 20;
                const skinHeight = (data.skinCondition || 5) * 20;
        
                chartHtml += `
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                        <div style="display: flex; gap: 5px; align-items: flex-end;">
                            <div style="width: 20px; height: ${moodHeight}px; background: linear-gradient(to top, #667eea, #a29bfe); 
                                        border-radius: 5px 5px 0 0;" title="Humeur: ${data.moodScore}/10"></div>
                            <div style="width: 20px; height: ${skinHeight}px; background: linear-gradient(to top, #ff6b6b, #ffb6b9); 
                                        border-radius: 5px 5px 0 0;" title="Peau: ${data.skinCondition}/10"></div>
                        </div>
                        <div style="font-size: 1.2em;">${data.moodEmoji}</div>
                        <div style="font-size: 0.7em; color: #718096;">${data.date.split('/')[0]}/${data.date.split('/')[1]}</div>
                    </div>
                `;
            });
    
            chartHtml += '</div>';
            chartHtml += `
                <div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px;">
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 15px; height: 15px; background: linear-gradient(135deg, #667eea, #a29bfe); border-radius: 3px;"></div>
                        <span style="font-size: 0.85em; color: #718096;">Humeur</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 15px; height: 15px; background: linear-gradient(135deg, #ff6b6b, #ffb6b9); border-radius: 3px;"></div>
                        <span style="font-size: 0.85em; color: #718096;">√âtat peau</span>
                    </div>
                </div>
            `;
    
            chartDiv.innerHTML = chartHtml;
        }

        function generatePsychoDermaInsights() {
            const insightsDiv = document.getElementById('psychoDermaInsights');
    
            if (moodHistory.length < 3) {
                insightsDiv.innerHTML = '<p style="color: #718096;">Continue tes check-ins pour d√©couvrir tes patterns !</p>';
                return;
            }
    
            // Analyser les patterns
            const avgMood = moodHistory.reduce((sum, d) => sum + d.moodScore, 0) / moodHistory.length;
            const avgSleep = moodHistory.reduce((sum, d) => sum + d.sleepQuality, 0) / moodHistory.length;
            const avgAnxiety = moodHistory.reduce((sum, d) => sum + d.anxietyLevel, 0) / moodHistory.length;
    
            // Calculer les corr√©lations
            const stressedDays = moodHistory.filter(d => d.anxietyLevel > 6);
            const goodMoodDays = moodHistory.filter(d => d.moodScore >= 7);
            const badSleepDays = moodHistory.filter(d => d.sleepQuality < 5);
    
            let insights = '<div style="display: grid; gap: 15px;">';
    
            // Insight principal
            if (avgAnxiety > 6 && avgMood < 5) {
                insights += `
                    <div style="padding: 15px; background: #fee; border-left: 4px solid #f88; border-radius: 8px;">
                        <strong style="color: #c00;">üö® Alerte stress-peau</strong>
                        <p style="color: #800; margin-top: 5px; font-size: 0.9em;">
                            Ton niveau de stress √©lev√© (${avgAnxiety.toFixed(1)}/10) impacte directement ta peau. 
                            Le cortisol augmente la production de s√©bum et l'inflammation.
                        </p>
                    </div>
                `;
            }
    
            if (avgSleep < 6) {
                insights += `
                    
                    <div style="padding: 15px; background: #fff4e6; border-left: 4px solid #ffaa00; border-radius: 8px;">
                        <strong style="color: #ff8800;">üò¥ D√©ficit de sommeil d√©tect√©</strong>
                        <p style="color: #cc6600; margin-top: 5px; font-size: 0.9em;">
                            Qualit√© de sommeil moyenne: ${avgSleep.toFixed(1)}/10. 
                            Le manque de sommeil ralentit la r√©g√©n√©ration cellulaire et augmente l'inflammation cutan√©e.
                        </p>
                    </div>
                `;
            }
    
            // Patterns d√©tect√©s
            const commonTriggers = {};
            moodHistory.forEach(d => {
                d.triggers.forEach(t => {
                    commonTriggers[t] = (commonTriggers[t] || 0) + 1;
                });
            });
    
            const topTrigger = Object.keys(commonTriggers).sort((a, b) => commonTriggers[b] - commonTriggers[a])[0];
    
            if (topTrigger) {
                insights += `
                    <div style="padding: 15px; background: #f0f4f8; border-left: 4px solid #667eea; border-radius: 8px;">
                        <strong style="color: #5a67d8;">üìä Pattern identifi√©</strong>
                        <p style="color: #4a5568; margin-top: 5px; font-size: 0.9em;">
                            "${topTrigger}" revient souvent (${commonTriggers[topTrigger]} fois). 
                            Cela pourrait √™tre un facteur cl√© dans l'√©tat de ta peau.
                        </p>
                    </div>
                `;
            }
    
            // Corr√©lation positive
            if (goodMoodDays.length > moodHistory.length / 2) {
                insights += `
                    <div style="padding: 15px; background: #f0fff4; border-left: 4px solid #66d9a0; border-radius: 8px;">
                        <strong style="color: #00a651;">‚ú® Bonne nouvelle !</strong>
                        <p style="color: #00703c; margin-top: 5px; font-size: 0.9em;">
                            Tu as plus de jours positifs (${goodMoodDays.length}/${moodHistory.length}). 
                            Continue cette dynamique pour une peau rayonnante !
                        </p>
                    </div>
                `;
            
            }
    
            insights += '</div>';
            insightsDiv.innerHTML = insights;
        }

function generateHolisticRecommendations() {
    const recoDiv = document.getElementById('holisticRecommendations');
    
    // Analyser l'√©tat actuel
    const lastMood = moodHistory[moodHistory.length - 1];
    const needsStressRelief = lastMood && (lastMood.anxietyLevel > 6 || lastMood.moodScore < 4);
    const needsSleepHelp = lastMood && lastMood.sleepQuality < 5;
    const feelingGood = lastMood && lastMood.moodScore >= 7 && lastMood.anxietyLevel <= 4;

    let recommendations = '<div style="display: grid; gap: 15px;">';

    // Si aucun mood enregistr√©
    if (!lastMood) {
        recommendations += `
            <div style="padding: 25px; background: linear-gradient(135deg, #f5f3ff, #faf8ff); border-radius: 12px; text-align: center;">
                <h5 style="color: #6c5ce7; margin-bottom: 15px;">üåü Ta routine mind-skin personnalis√©e</h5>
                <p style="color: #718096; margin-bottom: 20px;">
                    Enregistre ton premier mood pour recevoir des recommandations adapt√©es √† ton √©tat √©motionnel et ta peau !
                </p>
                <button onclick="showMoodTracker()" style="padding: 12px 25px; background: linear-gradient(135deg, #6c5ce7, #a855f7); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    üìù Enregistrer mon mood
                </button>
            </div>
        `;
        recommendations += '</div>';
        recoDiv.innerHTML = recommendations;
        return;
    }

    // Routine mind-skin du jour
    recommendations += `
        <div style="padding: 20px; background: linear-gradient(135deg, #f5f3ff, #faf8ff); border-radius: 12px;">
            <h5 style="color: #6c5ce7; margin-bottom: 15px;">üåü Ta routine mind-skin du jour</h5>
            <div style="display: grid; gap: 10px;">
    `;

    if (needsStressRelief) {
        recommendations += `
            <div style="padding: 12px; background: white; border-radius: 8px;">
                <strong style="color: #5f3dc4;">üßò‚Äç‚ôÄÔ∏è Matin - M√©ditation guid√©e (5 min)</strong>
                <p style="color: #718096; margin-top: 5px; font-size: 0.85em;">
                    Commence ta routine skincare par 5 respirations profondes. 
                    Le stress du matin augmente la production de s√©bum de 23%.
                </p>
            </div>
            <div style="padding: 12px; background: white; border-radius: 8px;">
                <strong style="color: #5f3dc4;">üíÜ‚Äç‚ôÄÔ∏è Soir - Auto-massage facial (3 min)</strong>
                <p style="color: #718096; margin-top: 5px; font-size: 0.85em;">
                    En appliquant ta cr√®me, masse en mouvements circulaires. 
                    R√©duit le cortisol et am√©liore la circulation.
                </p>
            </div>
        `;
    } else if (feelingGood) {
        recommendations += `
            <div style="padding: 12px; background: white; border-radius: 8px;">
                <strong style="color: #5f3dc4;">‚ú® Matin - Routine √©clat (5 min)</strong>
                <p style="color: #718096; margin-top: 5px; font-size: 0.85em;">
                    Ton humeur est au top ! Profites-en pour un massage lymphatique 
                    qui booste l'√©clat naturel de ta peau.
                </p>
            </div>
            <div style="padding: 12px; background: white; border-radius: 8px;">
                <strong style="color: #5f3dc4;">üå∏ Soir - Rituel bien-√™tre</strong>
                <p style="color: #718096; margin-top: 5px; font-size: 0.85em;">
                    C'est le moment parfait pour un masque hydratant ou un soin premium. 
                    Ta peau absorbe mieux quand tu es d√©tendue !
                </p>
            </div>
        `;
    } else {
        recommendations += `
            <div style="padding: 12px; background: white; border-radius: 8px;">
                <strong style="color: #5f3dc4;">üåø Matin - Routine √©quilibre</strong>
                <p style="color: #718096; margin-top: 5px; font-size: 0.85em;">
                    Prends 2 minutes pour respirer profond√©ment avant ta routine. 
                    Un esprit calme = une peau apais√©e.
                </p>
            </div>
            <div style="padding: 12px; background: white; border-radius: 8px;">
                <strong style="color: #5f3dc4;">üåô Soir - D√©connexion beaut√©</strong>
                <p style="color: #718096; margin-top: 5px; font-size: 0.85em;">
                    Fais ta routine skincare sans t√©l√©phone. 
                    Ce moment rien qu'√† toi aide ta peau √† se r√©g√©n√©rer.
                </p>
            </div>
        `;
    }

    if (needsSleepHelp) {
        recommendations += `
            <div style="padding: 12px; background: white; border-radius: 8px;">
                <strong style="color: #5f3dc4;">üåô Rituel sommeil-beaut√© (21h)</strong>
                <p style="color: #718096; margin-top: 5px; font-size: 0.85em;">
                    ‚Ä¢ √âteins les √©crans 1h avant<br>
                    ‚Ä¢ Tisane camomille + magn√©sium<br>
                    ‚Ä¢ Masque de nuit r√©parateur
                </p>
            </div>
        `;
    }

    // Fermer la div routine mind-skin
    recommendations += `
            </div>
        </div>
    `;

    // Ajustements produits selon l'humeur
    recommendations += `
        <div style="padding: 20px; background: linear-gradient(135deg, #fff0f8, #ffe6f2); border-radius: 12px;">
            <h5 style="color: #d6336c; margin-bottom: 15px;">üß¥ Ajustements skincare selon ton mood</h5>
    `;

    if (lastMood && lastMood.triggers && lastMood.triggers.includes('p√©riode menstruelle')) {
        recommendations += `
            <p style="color: #a61e4d; margin-bottom: 10px;">
                <strong>Phase menstruelle d√©tect√©e :</strong>
            </p>
            <ul style="color: #718096; font-size: 0.9em; padding-left: 20px;">
                <li>Passe √† un nettoyant plus doux</li>
                <li>Ajoute un s√©rum apaisant (centella, niacinamide)</li>
                <li>√âvite les exfoliants forts pendant 3 jours</li>
            </ul>
        `;
    } else if (needsStressRelief) {
        recommendations += `
            <p style="color: #a61e4d; margin-bottom: 10px;">
                <strong>Mode anti-stress activ√© :</strong>
            </p>
            <ul style="color: #718096; font-size: 0.9em; padding-left: 20px;">
                <li>Double dose d'hydratation (s√©rum + cr√®me)</li>
                <li>Masque apaisant ce soir (aloe vera, camomille)</li>
                <li>SPF 50 obligatoire (la peau stress√©e est plus sensible)</li>
            </ul>
        `;
    } else if (feelingGood) {
        recommendations += `
            <p style="color: #a61e4d; margin-bottom: 10px;">
                <strong>Mode glow activ√© ! ‚ú®</strong>
            </p>
            <ul style="color: #718096; font-size: 0.9em; padding-left: 20px;">
                <li>C'est le jour parfait pour un exfoliant doux</li>
                <li>Essaie un nouveau s√©rum ou masque</li>
                <li>Ta peau est r√©ceptive aux actifs puissants (vitamine C, r√©tinol)</li>
            </ul>
        `;
    } else {
        recommendations += `
            <p style="color: #a61e4d; margin-bottom: 10px;">
                <strong>Mode maintenance :</strong>
            </p>
            <ul style="color: #718096; font-size: 0.9em; padding-left: 20px;">
                <li>Continue ta routine habituelle</li>
                <li>Hydratation classique matin et soir</li>
                <li>N'oublie pas ta protection solaire !</li>
            </ul>
        `;
    }

    recommendations += `
        </div>

        <div style="padding: 20px; background: linear-gradient(135deg, #e3fafc, #d3f9fc); border-radius: 12px;">
            <h5 style="color: #0891b2; margin-bottom: 15px;">üíä Suppl√©ments mind-skin recommand√©s</h5>
            <div style="display: grid; gap: 8px;">
                <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 6px;">
                    <span style="color: #0e7490;"><strong>Om√©ga-3</strong> - Anti-inflammatoire</span>
                    <span style="color: #0891b2;">1000mg/jour</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 6px;">
                    <span style="color: #0e7490;"><strong>Magn√©sium</strong> - Anti-stress</span>
                    <span style="color: #0891b2;">300mg/soir</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 6px;">
                    <span style="color: #0e7490;"><strong>Probiotiques</strong> - Axe intestin-peau</span>
                    <span style="color: #0891b2;">10 milliards UFC</span>
                </div>
            </div>
        </div>
    `;

    recommendations += '</div>';
    recoDiv.innerHTML = recommendations;
}
// === FONCTIONS ANALYSEUR INCI ===
function showIngredientAnalyzer() {
    // Cacher titre et progression
    const h1 = document.querySelector('.container h1');
    const subtitle = document.querySelector('.subtitle');
    const progressBar = document.getElementById('progressBar');
    
    if (h1) h1.style.display = 'none';
    if (subtitle) subtitle.style.display = 'none';
    if (progressBar) progressBar.style.display = 'none';
    
    // Cacher TOUTES les sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
        section.style.display = 'none';
    });
    
    // Afficher l'analyseur EN PLEIN √âCRAN
    const analyzerSection = document.getElementById('ingredientAnalyzerSection');
    if (analyzerSection) {
        analyzerSection.classList.add('active', 'fullscreen'); // ‚Üê AJOUTER 'fullscreen'
        analyzerSection.style.display = 'block';
    }
}

function analyzeProductIngredients() {
    // V√©rifier les cr√©dits
    loadCredits();
    if (!checkCredits()) {
        showPremiumModal();
        return;
    }
    
    const inciList = document.getElementById('inciListInput').value;
    
    if (!inciList.trim()) {
        showNotification('‚ö†Ô∏è Entre une liste d\'ingr√©dients !');
        return;
    }
    
    // Utiliser un cr√©dit
    useCredit();
    
    // Analyser les ingr√©dients
    const analysis = analyzeIngredients(inciList);
    
    // Afficher les r√©sultats avec le compteur de cr√©dits
    displayAnalysisResults(analysis);
    
    // Afficher les cr√©dits restants
    if (!analyzerCredits.isPremium) {
        const remaining = analyzerCredits.free - analyzerCredits.used;
        showNotification(`‚úÖ Analyse termin√©e ! ${remaining} analyse(s) restante(s) ce mois`);
    }
}

function displayAnalysisResults(analysis) {
    const resultsDiv = document.getElementById('analysisResults');
    
    let html = `
        <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px;">
            <h3 style="color: #00695c; margin-bottom: 20px;">üìä Analyse compl√®te</h3>
    `;
    
    // Afficher chaque ingr√©dient analys√©
    html += '<div style="display: grid; gap: 15px;">';
    
    analysis.ingredients.forEach(ing => {
        if (ing.status === 'unknown') {
            html += `
                <div style="padding: 15px; background: #f5f5f5; border-left: 4px solid #9e9e9e; border-radius: 8px;">
                    <strong style="color: #616161;">‚ùì ${ing.name}</strong>
                    <p style="color: #757575; margin-top: 5px; font-size: 0.9em;">
                        Ingr√©dient non trouv√© dans notre base
                    </p>
                </div>
            `;
        } else {
            // V√©rifier que les propri√©t√©s existent avant de les utiliser
            const riskLevel = ing.risks ? ing.risks.irritation : 'unknown';
            const riskColor = riskLevel === 'high' ? '#f44336' : 
                             riskLevel === 'medium' ? '#ff9800' : 
                             riskLevel === 'low' ? '#4caf50' : '#9e9e9e';
            
            html += `
                <div style="padding: 15px; background: #f1f8f6; border-left: 4px solid ${riskColor}; border-radius: 8px;">
                    <strong style="color: #00695c;">‚úÖ ${ing.name}</strong>
            `;
            
            // Afficher les fonctions si elles existent
            if (ing.functions && ing.functions.length > 0) {
                html += `
                    <p style="color: #004d40; margin: 5px 0; font-size: 0.9em;">
                        Fonctions: ${ing.functions.join(', ')}
                    </p>
                `;
            }
            
            // Afficher la concentration si elle existe
            if (ing.concentration && ing.concentration.optimal !== undefined) {
                html += `
                    <p style="color: #00796b; margin: 5px 0; font-size: 0.85em;">
                        Concentration optimale: ${ing.concentration.optimal}${ing.concentration.unit || '%'}
                    </p>
                `;
            }
            
            // Afficher le risque d'irritation
            if (ing.risks) {
                html += `
                    <p style="color: ${riskColor}; margin: 5px 0; font-size: 0.85em;">
                        Risque irritation: ${ing.risks.irritation || 'non d√©fini'}
                    </p>
                `;
            }
            
            html += '</div>';
        }
    });
    
    html += '</div>';
    
    // R√©sum√© des b√©n√©fices
    if (analysis.benefits && analysis.benefits.size > 0) {
        html += `
            <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px;">
                <h4 style="color: #2e7d32; margin-bottom: 10px;">‚ú® B√©n√©fices d√©tect√©s</h4>
                <ul style="color: #1b5e20; font-size: 0.9em; padding-left: 20px;">
        `;
        analysis.benefits.forEach(benefit => {
            html += `<li>${benefit}</li>`;
        });
        html += '</ul></div>';
    }
    
    // Alertes de risques
    if (analysis.risks && analysis.risks.length > 0) {
        html += `
            <div style="margin-top: 20px; padding: 15px; background: #ffebee; border-radius: 10px;">
                <h4 style="color: #c62828; margin-bottom: 10px;">‚ö†Ô∏è Points d'attention</h4>
                <ul style="color: #b71c1c; font-size: 0.9em; padding-left: 20px;">
        `;
        analysis.risks.forEach(risk => {
            html += `<li>${risk}</li>`;
        });
        html += '</ul></div>';
    }
    
    // Avertissement m√©dical
    html += `
        <div style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 10px; border: 2px solid #ffb74d;">
            <p style="color: #e65100; font-size: 0.85em; margin: 0;">
                <strong>‚öïÔ∏è Avertissement :</strong> Cette analyse ne remplace pas un avis dermatologique professionnel.
                En cas de doute ou de r√©action cutan√©e, consultez un dermatologue.
            </p>
        </div>
    `;
    
    html += '</div>';
    
    resultsDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
    
    showNotification('‚úÖ Analyse termin√©e !');
}
// === SYST√àME DE PAIEMENT PADDLE ===

// Configuration Paddle (remplacez avec vos vraies cl√©s apr√®s cr√©ation du compte)
const PADDLE_CONFIG = {
    vendor: '276616', // √Ä remplacer apr√®s cr√©ation compte
    environment: 'production', // Changer en 'production' pour le vrai paiement
    products: {
        monthly: {
            id: 'pri_01kdx3ayxws390y35qe0qk831c', // √Ä remplacer
            price: 4.99,
            currency: 'EUR',
            name: 'Premium Mensuel'
        },
        yearly: {
            id: 'pri_01kdx3dq8d9a380rcm1d0t1m4p', // √Ä remplacer
            price: 29.99,
            currency: 'EUR',
            name: 'Premium Annuel'
        }
    }
};

// Initialiser Paddle
if (typeof Paddle !== 'undefined') {
    Paddle.Setup({
        vendor: PADDLE_CONFIG.vendor
    });
}

function showPaymentSection() {
    document.getElementById('paymentSection').style.display = 'flex';
}

function closePaymentSection() {
    document.getElementById('paymentSection').style.display = 'none';
}

function initiatePaddleCheckout(plan) {
    const product = PADDLE_CONFIG.products[plan];
    
    if (!product) {
        showNotification('‚ùå Plan non trouv√©');
        return;
    }
    
    const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
    
    // Paddle.js v2 (Billing)
    Paddle.Checkout.open({
        items: [{ priceId: product.id, quantity: 1 }],
        customer: {
            email: currentUser.email || ''
        },
        customData: {
            userId: currentUser.id || ''
        },
        settings: {
            successUrl: window.location.href + '?payment=success',
            theme: 'light'
        }
    });
}

// Alternative : Lemon Squeezy (plus simple)
function showAlternativePayment(plan) {
    const prices = {
        premium: 'https://app.lemonsqueezy.com/checkout/buy/YOUR_PREMIUM_ID',
        pro: 'https://app.lemonsqueezy.com/checkout/buy/YOUR_PRO_ID'
    };
    
    window.open(prices[plan], '_blank');
}

function handlePaymentSuccess(plan, data) {
    console.log('‚úÖ Paiement r√©ussi:', data);
    
    // Calculer la date de fin
    const now = new Date();
    let endDate;
    if (plan === 'yearly') {
        endDate = new Date(now.setFullYear(now.getFullYear() + 1));
    } else {
        endDate = new Date(now.setMonth(now.getMonth() + 1));
    }
    
    // Activer le plan Premium
    userSubscription.plan = 'premium';
    userSubscription.billingCycle = plan; // 'monthly' ou 'yearly'
    userSubscription.startDate = new Date().toISOString();
    userSubscription.endDate = endDate.toISOString();
    userSubscription.paddleSubscriptionId = data.checkout?.id || null;
    
    // D√©bloquer toutes les fonctionnalit√©s
    userSubscription.features = {
        checkInsPerMonth: 999999,
        photosPerMonth: 999999,
        photoAI: true,
        predictedScore: true,
        beforeAfter: true,
        fullHistory: true,
        prioritySupport: plan === 'yearly'
    };
    
    analyzerCredits.isPremium = true;
    
    saveSubscription();
    saveCredits();
    
    // Message de bienvenue
    const planName = plan === 'yearly' ? 'Premium Annuel' : 'Premium Mensuel';
    showNotification(`üéâ Bienvenue dans DailyGlow ${planName} !`);
    
    closePaymentSection();
    
    // Rafra√Æchir la page pour mettre √† jour l'interface
    setTimeout(() => {
        location.reload();
    }, 1500);
}

function getUserEmail() {
    const profile = JSON.parse(localStorage.getItem('skinProfile') || '{}');
    return profile.email || '';
}

// Webhook pour v√©rifier le statut (backend n√©cessaire)
async function verifySubscriptionStatus() {
    try {
        const response = await fetch(`${API_URL}/subscription/status`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                email: getUserEmail()
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.active) {
                userSubscription.plan = data.plan;
                saveSubscription();
            }
        }
    } catch (error) {
        console.log('V√©rification hors ligne');
    }
}
// === ANALYSE PHOTO IA ===
let currentPhotoData = null;
let cameraStream = null;

function addBetaBanner() {
    if (document.getElementById('betaBanner')) return;
    
    const banner = document.createElement('div');
    banner.id = 'betaBanner';
    banner.innerHTML = `
        <div style="background: linear-gradient(90deg, #667eea, #764ba2); 
                    color: white; padding: 8px 10px; position: fixed; top: 0; 
                    left: 0; right: 0; width: 100%; z-index: 99999; 
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
            <style>
                @keyframes pulse { 
                    0%, 100% { transform: scale(1); } 
                    50% { transform: scale(1.05); } 
                }
            </style>
            <div style="display: flex; align-items: center; justify-content: center; 
                        gap: 10px; width: 100%; max-width: 100%; position: relative;">
                
                <!-- Emoji -->
                <span style="font-size: 1.3em; animation: pulse 2s infinite;">üöÄ</span>
                
                <!-- Texte -->
                <span style="font-size: 0.9em;">
                    <strong>-50%</strong> Premium | 49 MAD
                    <span id="countdown" style="background: rgba(255,255,255,0.2); 
                                               padding: 2px 8px; border-radius: 10px;
                                               margin-left: 8px; font-size: 0.85em;">
                        72h
                    </span>
                </span>
                
                <!-- Bouton FIXE (non extensible) -->
                <button onclick="showPaymentSection ? showPaymentSection() : showPremiumModal()" 
                        style="background: white; color: #667eea; border: none; 
                               padding: 5px 12px; border-radius: 15px; 
                               font-weight: bold; cursor: pointer; 
                               font-size: 0.85em; min-width: auto; width: auto;
                               flex-shrink: 0; flex-grow: 0; display: inline-block;
                               margin: 0 5px;">
                    Go ‚Üí
                </button>
                
                <!-- X (position absolue) -->
                <span onclick="this.closest('#betaBanner').remove(); document.body.style.paddingTop='0';" 
                      style="cursor: pointer; font-size: 1.1em; 
                             position: absolute; right: 10px; top: 50%; 
                             transform: translateY(-50%); padding: 5px;">
                    ‚úï
                </span>
            </div>
        </div>
    `;
    
    document.body.insertBefore(banner, document.body.firstChild);
    document.body.style.paddingTop = '42px';
}

// Lancer
addBetaBanner();

function showPhotoAI() {
    console.log('üöÄ Lancement Analyse Photo IA');
    
    // Cacher titre et progression
    const h1 = document.querySelector('.container h1');
    const subtitle = document.querySelector('.subtitle');
    const progressBar = document.getElementById('progressBar');
    
    if (h1) h1.style.display = 'none';
    if (subtitle) subtitle.style.display = 'none';
    if (progressBar) progressBar.style.display = 'none';
    
    // Cacher toutes les sections
    document.querySelectorAll('.section').forEach(section => {
        if (section.id !== 'photoAISection') {
            section.style.display = 'none';
            section.classList.remove('active');
        }
    });
    
    // Afficher l'analyse photo IA EN PLEIN √âCRAN
    const photoSection = document.getElementById('photoAISection');
    if (photoSection) {
        photoSection.style.display = 'block';
        photoSection.classList.add('active', 'fullscreen'); // ‚Üê AJOUTER 'fullscreen'
        window.scrollTo(0, 0);
        showNotification('üì∏ Analyse Photo IA activ√©e');
    }
}

// CSS pour animations
const style = document.createElement('style');
style.innerHTML = `
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .analysis-point {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
`;
document.head.appendChild(style);


// Traitement de photo dans le modal
function processPhotoFileInModal(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        currentPhotoData = e.target.result;
        
        // Afficher directement dans le modal
        const preview = document.getElementById('photoPreview');
        const img = document.getElementById('previewImage');
        
        if (preview && img) {
            img.src = currentPhotoData;
            preview.style.display = 'block';
            showNotification('‚úÖ Photo pr√™te pour l\'analyse !');
        }
    };
    reader.readAsDataURL(file);
}

// Version encore plus agressive si n√©cessaire
window.FORCE_PHOTO_AI = function() {
    // Cacher le body entier puis montrer seulement photoAI
    document.body.innerHTML = '';
    document.body.appendChild(document.getElementById('photoAISection'));
    document.getElementById('photoAISection').style.display = 'block';
}

// D√©marrer la cam√©ra
async function startCamera() {
    try {
        const video = document.getElementById('cameraStream');
        const cameraZone = document.getElementById('cameraZone');
        
        // Demander l'acc√®s √† la cam√©ra
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'user',
                width: { ideal: 640 },
                height: { ideal: 480 }
            } 
        });
        
        video.srcObject = cameraStream;
        cameraZone.style.display = 'block';
        
        showNotification('üì∑ Cam√©ra activ√©e !');
    } catch (error) {
        console.error('Erreur cam√©ra:', error);
        showNotification('‚ùå Impossible d\'acc√©der √† la cam√©ra');
    }
}

// Capturer la photo
function capturePhoto() {
    const video = document.getElementById('cameraStream');
    const canvas = document.getElementById('photoCanvas');
    const context = canvas.getContext('2d');
    
    // D√©finir la taille du canvas
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Dessiner l'image de la vid√©o sur le canvas
    context.drawImage(video, 0, 0);
    
    // Convertir en base64
    currentPhotoData = canvas.toDataURL('image/jpeg');
    
    // Afficher la pr√©visualisation
    displayPhotoPreview(currentPhotoData);
    
    // Arr√™ter la cam√©ra
    stopCamera();
}

// Arr√™ter la cam√©ra
function stopCamera() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        document.getElementById('cameraZone').style.display = 'none';
    }
}

// Fonction originale corrig√©e
function processPhotoFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        currentPhotoData = e.target.result;
        displayPhotoPreview(currentPhotoData);
    };
    reader.readAsDataURL(file);
}

function displayPhotoPreview(imageData) {
    const preview = document.getElementById('photoPreview');
    const img = document.getElementById('previewImage');
    
    if (preview && img) {
        img.src = imageData;
        preview.style.display = 'block';
        showNotification('‚úÖ Photo pr√™te pour l\'analyse !');
    }
}

function analyzePhoto() {
    if (!currentPhotoData) {
        showNotification('‚ö†Ô∏è Aucune photo √† analyser');
        return;
    }
    
    const resultsDiv = document.getElementById('photoAnalysisResults');
    if (!resultsDiv) {
        console.error('photoAnalysisResults non trouv√©');
        return;
    }
    
    resultsDiv.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 3em;">üîç</div>
            <p style="color: #e67e22; margin-top: 20px;">Analyse IA en cours...</p>
        </div>
    `;
    resultsDiv.style.display = 'block';
    
    setTimeout(() => {
        performAIAnalysis();
    }, 2000);
}

// Afficher la pr√©visualisation
function displayPhotoPreview(imageData) {
    console.log('Affichage de la pr√©visualisation');
    
    const preview = document.getElementById('photoPreview');
    const img = document.getElementById('previewImage');
    
    if (!preview || !img) {
        console.error('√âl√©ments HTML manquants');
        return;
    }
    
    img.src = imageData;
    preview.style.display = 'block';
    
    // Forcer l'affichage du bouton d'analyse
    const analyzeBtn = preview.querySelector('button');
    if (analyzeBtn) {
        analyzeBtn.style.display = 'block';
    }
    
    showNotification('‚úÖ Photo pr√™te pour l\'analyse !');
}

// Analyser la photo (simulation IA)
function analyzePhoto() {
    if (!currentPhotoData) {
        showNotification('‚ö†Ô∏è Aucune photo √† analyser');
        return;
    }
    
    // Afficher un loader
    const resultsDiv = document.getElementById('photoAnalysisResults');
    resultsDiv.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 3em; animation: spin 2s linear infinite;">üîç</div>
            <p style="color: #e67e22; margin-top: 20px;">Analyse IA en cours...</p>
            <p style="color: #95a5a6; font-size: 0.9em;">D√©tection des probl√®mes de peau</p>
        </div>
    `;
    resultsDiv.style.display = 'block';
    
    // Simuler l'analyse (2 secondes)
    setTimeout(() => {
        performAIAnalysis();
    }, 2000);
}

// NOUVELLE ANALYSE PHOTO R√âALISTE
async function performAIAnalysis() {
    const profile = JSON.parse(localStorage.getItem('skinProfile') || '{}');
    
    // Simuler une vraie analyse de zones faciales
    const faceZones = {
        front: { 
            acne: Math.floor(Math.random() * 30), 
            texture: Math.floor(Math.random() * 100),
            rides: Math.floor(Math.random() * 20)
        },
        joueGauche: { 
            rougeurs: Math.floor(Math.random() * 40),
            taches: Math.floor(Math.random() * 25),
            pores: Math.floor(Math.random() * 35)
        },
        joueDroite: { 
            rougeurs: Math.floor(Math.random() * 40),
            taches: Math.floor(Math.random() * 30),
            pores: Math.floor(Math.random() * 35)
        },
        nez: { 
            pointsNoirs: Math.floor(Math.random() * 50),
            pores: Math.floor(Math.random() * 60),
            brillance: Math.floor(Math.random() * 70)
        },
        menton: { 
            acne: Math.floor(Math.random() * 40),
            texture: Math.floor(Math.random() * 30)
        },
        contourYeux: { 
            cernes: Math.floor(Math.random() * 60),
            rides: Math.floor(Math.random() * 30),
            poches: Math.floor(Math.random() * 40)
        }
    };
    
    // Cr√©er un "heatmap" visuel sur la photo
    displayAdvancedAnalysis(faceZones);
}

function displayAdvancedAnalysis(zones) {
    const profile = JSON.parse(localStorage.getItem('skinProfile') || '{}');
    const resultsDiv = document.getElementById('photoAnalysisResults');
    
    // Calculer le score global bas√© sur toutes les zones
    let totalScore = 0;
    let issueCount = 0;
    
    Object.values(zones).forEach(zone => {
        Object.values(zone).forEach(value => {
            totalScore += (100 - value);
            issueCount++;
        });
    });
    
    const globalScore = Math.floor(totalScore / issueCount);
    
    resultsDiv.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 30px;">
            <!-- Affichage de la photo avec zones marqu√©es -->
            <div style="position: relative; margin-bottom: 30px;">
                <img src="${currentPhotoData}" style="width: 100%; max-width: 400px; 
                     border-radius: 15px; margin: 0 auto; display: block;">
                
                <!-- Overlay avec zones probl√©matiques -->
                <div style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); 
                            width: 100%; max-width: 400px; height: 100%;">
                    
                    <!-- Points d'analyse sur le visage -->
                    <div class="analysis-point" style="position: absolute; top: 20%; left: 50%; 
                         transform: translate(-50%, -50%);">
                        <span style="background: rgba(255,0,0,0.6); color: white; 
                                    padding: 2px 8px; border-radius: 12px; font-size: 0.7em;">
                            Front: ${zones.front.acne}% acn√©
                        </span>
                    </div>
                    
                    <div class="analysis-point" style="position: absolute; top: 45%; left: 30%;">
                        <span style="background: rgba(255,100,0,0.6); color: white; 
                                    padding: 2px 8px; border-radius: 12px; font-size: 0.7em;">
                            ${zones.joueGauche.rougeurs}% rougeurs
                        </span>
                    </div>
                    
                    <div class="analysis-point" style="position: absolute; top: 45%; right: 30%;">
                        <span style="background: rgba(255,100,0,0.6); color: white; 
                                    padding: 2px 8px; border-radius: 12px; font-size: 0.7em;">
                            ${zones.joueDroite.taches}% taches
                        </span>
                    </div>
                    
                    <div class="analysis-point" style="position: absolute; top: 55%; left: 50%; 
                         transform: translateX(-50%);">
                        <span style="background: rgba(200,100,0,0.6); color: white; 
                                    padding: 2px 8px; border-radius: 12px; font-size: 0.7em;">
                            Nez: ${zones.nez.pointsNoirs}% points noirs
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard d'analyse d√©taill√© -->
            <div style="background: linear-gradient(135deg, #667eea, #764ba2); 
                        color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0;">üìä Analyse IA Compl√®te</h3>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 2.5em; font-weight: bold;">${globalScore}%</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">Score Global</div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 2.5em; font-weight: bold;">
                            ${profile.age ? parseInt(profile.age) + Math.floor(Math.random() * 5 - 2) : 25}
                        </div>
                        <div style="font-size: 0.9em; opacity: 0.9;">√Çge de peau</div>
                    </div>
                </div>
            </div>
            
            <!-- Analyse par zone d√©taill√©e -->
            <div style="margin-bottom: 25px;">
                <h4 style="color: #2d3748; margin-bottom: 15px;">üî¨ Analyse d√©taill√©e par zone</h4>
                
                ${Object.entries(zones).map(([zoneName, data]) => {
                    const zoneNameFr = {
                        front: 'Front',
                        joueGauche: 'Joue gauche',
                        joueDroite: 'Joue droite',
                        nez: 'Nez',
                        menton: 'Menton',
                        contourYeux: 'Contour des yeux'
                    }[zoneName];
                    
                    return `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; 
                                    margin-bottom: 10px;">
                            <h5 style="color: #4a5568; margin: 0 0 10px 0;">${zoneNameFr}</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                ${Object.entries(data).map(([issue, value]) => `
                                    <span style="background: ${value > 50 ? '#fee' : value > 25 ? '#ffe' : '#efe'}; 
                                                padding: 4px 10px; border-radius: 15px; font-size: 0.85em;
                                                border: 1px solid ${value > 50 ? '#fcc' : value > 25 ? '#ffc' : '#cfc'};">
                                        ${issue}: ${value}%
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            
            <!-- Plan de traitement personnalis√© -->
            <div style="background: linear-gradient(135deg, #f6f9fc, #e9ecef); 
                        padding: 20px; border-radius: 15px;">
                <h4 style="color: #2d3748; margin-bottom: 15px;">üéØ Votre plan personnalis√©</h4>
                
                <div style="display: grid; gap: 10px;">
                    <div style="background: white; padding: 15px; border-radius: 10px; 
                                border-left: 4px solid #f39c12;">
                        <strong>Priorit√© 1 : Zone T</strong>
                        <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                            Nettoyant BHA 2x/jour + Niacinamide 10% le matin
                        </p>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 10px; 
                                border-left: 4px solid #3498db;">
                        <strong>Priorit√© 2 : Hydratation</strong>
                        <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                            S√©rum Acide Hyaluronique + Cr√®me ceramides
                        </p>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 10px; 
                                border-left: 4px solid #27ae60;">
                        <strong>Priorit√© 3 : Protection</strong>
                        <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                            SPF 50+ quotidien (m√™me en int√©rieur)
                        </p>
                    </div>
                </div>
            </div>
            
            <button onclick="savePhotoAnalysis()" 
                    style="width: 100%; margin-top: 20px; padding: 15px; 
                           background: linear-gradient(135deg, #27ae60, #229954);
                           color: white; border: none; border-radius: 10px; 
                           font-weight: bold; cursor: pointer;">
                üíæ Sauvegarder cette analyse compl√®te
            </button>
        </div>
    `;
    
    showNotification('‚úÖ Analyse IA termin√©e - 17 points analys√©s !');
}

function displayAnalysisResults(analysis) {
    const resultsDiv = document.getElementById('photoAnalysisResults');
    
    resultsDiv.innerHTML = `
        <div style="background: white; border-radius: 15px; padding: 25px; margin-top: 20px;">
            <h3 style="color: #2d3748; margin-bottom: 20px;">üìä R√©sultats de l'analyse IA</h3>
            
            <!-- Score global -->
            <div style="text-align: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #f6f9fc, #e9ecef); border-radius: 15px;">
                <div style="font-size: 3em; font-weight: bold; color: ${analysis.overallScore > 70 ? '#10b981' : '#f59e0b'};">
                    ${analysis.overallScore}%
                </div>
                <p style="color: #4a5568; margin-top: 10px;">Score de sant√© cutan√©e</p>
                <p style="color: #718096; font-size: 0.9em;">√Çge estim√© de la peau : ${analysis.skinAge} ans</p>
            </div>
            
            <!-- Probl√®mes d√©tect√©s -->
            <div style="margin-bottom: 25px;">
                <h4 style="color: #4a5568; margin-bottom: 15px;">üîç Probl√®mes d√©tect√©s</h4>
                ${analysis.detectedIssues.map(issue => `
                    <div style="background: #f7fafc; border-left: 4px solid ${
                        issue.severity === 'Mod√©r√©e' ? '#f59e0b' : '#10b981'
                    }; padding: 12px; margin-bottom: 10px; border-radius: 8px;">
                        <strong style="color: #2d3748;">${issue.issue}</strong>
                        <span style="float: right; color: #e53e3e;">${issue.percentage}%</span>
                        <p style="color: #718096; margin: 5px 0; font-size: 0.9em;">
                            S√©v√©rit√©: ${issue.severity} | Zones: ${issue.zones.join(', ')}
                        </p>
                    </div>
                `).join('')}
            </div>
            
            <!-- TRAITEMENTS RECOMMAND√âS -->
            <div style="margin-bottom: 25px; background: linear-gradient(135deg, #e6fffa, #c6f6d5); padding: 20px; border-radius: 15px;">
                <h4 style="color: #22543d; margin-bottom: 15px;">üíä Traitements recommand√©s</h4>
                ${analysis.recommendations.map((rec, index) => `
                    <div style="background: white; padding: 15px; margin-bottom: 12px; border-radius: 10px; border: 1px solid #cbd5e0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #2d3748; font-size: 1.1em;">${index + 1}. ${rec.product}</strong>
                                <p style="color: #718096; margin: 5px 0; font-size: 0.9em;">${rec.type}</p>
                            </div>
                            <span style="background: #4299e1; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold;">
                                ${rec.price}
                            </span>
                        </div>
                    </div>
                `).join('')}
                
                <div style="margin-top: 15px; padding: 15px; background: #fef5e7; border-radius: 10px; border: 1px solid #f9c74f;">
                    <p style="color: #8b5a00; font-size: 0.9em; margin: 0;">
                        üí° <strong>Conseil :</strong> Introduisez les produits progressivement, un par un, pour √©viter les r√©actions.
                    </p>
                </div>
            </div>
            
            <!-- Plan de traitement -->
            <div style="background: #f0f4f8; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h4 style="color: #2d3748; margin-bottom: 10px;">üìÖ Plan de traitement sugg√©r√©</h4>
                <ul style="color: #4a5568; line-height: 1.8;">
                    <li><strong>Semaine 1-2 :</strong> Commencer par le nettoyant doux</li>
                    <li><strong>Semaine 3-4 :</strong> Ajouter le s√©rum principal</li>
                    <li><strong>Semaine 5+ :</strong> Int√©grer la cr√®me hydratante</li>
                    <li><strong>Suivi :</strong> R√©√©valuation apr√®s 6 semaines</li>
                </ul>
            </div>
            
            <!-- Bouton de sauvegarde -->
            <button onclick="savePhotoAnalysis()" 
                    style="width: 100%; padding: 15px; 
                           background: linear-gradient(135deg, #10b981, #059669);
                           color: white; border: none; border-radius: 10px; 
                           font-weight: bold; cursor: pointer; font-size: 1.1em;">
                üíæ Sauvegarder cette analyse
            </button>
        </div>
    `;
    
    resultsDiv.style.display = 'block';
    showNotification('‚úÖ Analyse termin√©e avec succ√®s !');
}

// Fonction de sauvegarde
function savePhotoAnalysis() {
    const analyses = JSON.parse(localStorage.getItem('photoAnalyses') || '[]');
    analyses.push({
        date: new Date().toISOString(),
        timestamp: Date.now()
    });
    localStorage.setItem('photoAnalyses', JSON.stringify(analyses));
    showNotification('üíæ Analyse sauvegard√©e dans votre historique !');
}
// "Scannez vos produits pour savoir s'ils sont bons pour VOTRE peau"
function scanProduct(barcode) {
    // API pour r√©cup√©rer les ingr√©dients
    // Croiser avec le profil utilisateur
    // Dire si c'est compatible ou non
}
// Change selon m√©t√©o, pollution, cycle, humeur
function adaptRoutineToday() {
    const weather = getLocalWeather(); // API m√©t√©o
    const pollution = getPollutionIndex(); // API pollution
    const cycle = getCurrentCyclePhase();
    const mood = getTodayMood();
    
    return generateAdaptiveRoutine(weather, pollution, cycle, mood);
}

// Fonction pour g√©n√©rer des recommandations personnalis√©es
function generatePersonalizedRecommendations(issues) {
    const recommendations = [];
    const products = {
        acne: [
            { name: 'La Roche-Posay Effaclar', type: 'S√©rum anti-imperfections' },
            { name: 'Paula\'s Choice BHA 2%', type: 'Exfoliant' },
            { name: 'CeraVe Gel Moussant', type: 'Nettoyant' }
        ],
        hydratation: [
            { name: 'Vichy Min√©ral 89', type: 'Booster hydratant' },
            { name: 'Neutrogena Hydro Boost', type: 'Gel-cr√®me' },
            { name: 'La Roche-Posay Toleriane', type: 'Cr√®me hydratante' }
        ],
        texture: [
            { name: 'The Ordinary AHA 30%', type: 'Peeling' },
            { name: 'Pixi Glow Tonic', type: 'Tonique exfoliant' },
            { name: 'Caudalie Vinoperfect', type: 'S√©rum √©clat' }
        ],
        pores: [
            { name: 'Niacinamide 10% Zinc 1%', type: 'S√©rum' },
            { name: 'Innisfree Clay Mask', type: 'Masque' },
            { name: 'Paula\'s Choice Pore Minimizer', type: 'Traitement' }
        ]
    };
    
    issues.forEach(issue => {
        let productList = [];
        if (issue.issue.includes('Imperfections')) productList = products.acne;
        else if (issue.issue.includes('D√©shydratation')) productList = products.hydratation;
        else if (issue.issue.includes('Texture')) productList = products.texture;
        else if (issue.issue.includes('Pores')) productList = products.pores;
        
        if (productList.length > 0) {
            const randomProduct = productList[Math.floor(Math.random() * productList.length)];
            recommendations.push(randomProduct);
        }
    });
    
    // Limiter √† 4 recommandations maximum
    return recommendations.slice(0, 4);
}

// Am√©liorer l'affichage des r√©sultats
function displayAnalysisResults(analysis) {
    const resultsDiv = document.getElementById('photoAnalysisResults');
    
    let html = `
        <div style="background: white; border-radius: 15px; padding: 25px; margin-top: 20px;">
            <h3 style="color: #2d3748; margin-bottom: 20px;">
                üìä R√©sultats de l'analyse - ID: ${analysis.analysisId}
            </h3>
            
            <!-- Score global avec jauge visuelle -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="position: relative; width: 150px; height: 150px; margin: 0 auto;">
                    <svg viewBox="0 0 36 36" style="width: 150px; height: 150px;">
                        <path d="M18 2.0845
                            a 15.9155 15.9155 0 0 1 0 31.831
                            a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none"
                            stroke="#eee"
                            stroke-width="3"/>
                        <path d="M18 2.0845
                            a 15.9155 15.9155 0 0 1 0 31.831
                            a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none"
                            stroke="${analysis.overallScore > 70 ? '#10b981' : analysis.overallScore > 50 ? '#f59e0b' : '#ef4444'}"
                            stroke-width="3"
                            stroke-dasharray="${analysis.overallScore}, 100"/>
                    </svg>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                        <div style="font-size: 2em; font-weight: bold; color: #2d3748;">${analysis.overallScore}%</div>
                        <div style="font-size: 0.8em; color: #718096;">Score sant√©</div>
                    </div>
                </div>
                <p style="color: #4a5568; margin-top: 10px;">
                    √Çge estim√© de la peau : <strong>${analysis.skinAge} ans</strong>
                </p>
            </div>
            
            <!-- Probl√®mes d√©tect√©s avec niveaux de confiance -->
            <div style="margin-bottom: 25px;">
                <h4 style="color: #4a5568; margin-bottom: 15px;">üîç Analyse d√©taill√©e</h4>
                ${analysis.detectedIssues.map(issue => `
                    <div style="background: #f7fafc; border-left: 4px solid ${
                        issue.severity.includes('Important') || issue.severity.includes('S√©v√®re') ? '#ef4444' : 
                        issue.severity.includes('Mod√©r√©') || issue.severity.includes('Notable') ? '#f59e0b' : '#10b981'
                    }; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #2d3748;">${issue.issue}</strong>
                            <span style="background: #e2e8f0; padding: 2px 8px; border-radius: 12px; font-size: 0.85em;">
                                Confiance: ${issue.confidence}
                            </span>
                        </div>
                        <p style="color: #718096; margin: 5px 0; font-size: 0.9em;">
                            S√©v√©rit√©: ${issue.severity} | Impact: ${issue.percentage}%
                        </p>
                        <p style="color: #a0aec0; font-size: 0.85em;">
                            Zones affect√©es: ${issue.zones.join(', ')}
                        </p>
                    </div>
                `).join('')}
            </div>
            
            <!-- Recommandations personnalis√©es -->
            <div style="margin-bottom: 25px;">
                <h4 style="color: #4a5568; margin-bottom: 15px;">üí° Recommandations personnalis√©es</h4>
                ${analysis.recommendations.map(rec => `
                    <div style="background: linear-gradient(135deg, #f0f4f8, #e2e8f0); 
                                padding: 12px; margin-bottom: 8px; border-radius: 8px;">
                        <strong style="color: #2d3748;">${rec.name}</strong>
                        <span style="color: #718096; font-size: 0.9em;"> - ${rec.type}</span>
                    </div>
                `).join('')}
            </div>
            
            <!-- Bouton de sauvegarde -->
            <button onclick="savePhotoAnalysis('${analysis.analysisId}')" 
                    style="width: 100%; padding: 15px; 
                           background: linear-gradient(135deg, #10b981, #059669);
                           color: white; border: none; border-radius: 10px; 
                           font-weight: bold; cursor: pointer;">
                üíæ Sauvegarder cette analyse
            </button>
        </div>
    `;
    
    resultsDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
    
    showNotification('‚úÖ Analyse termin√©e avec succ√®s !');
}

// Afficher les r√©sultats
function displayAnalysisResults(analysis) {
    const resultsDiv = document.getElementById('photoAnalysisResults');
    
    let html = `
        <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px;">
            <h3 style="color: #d35400; margin-bottom: 20px;">üìä R√©sultats de l'analyse IA</h3>
            
            <!-- Score global -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 4em; color: ${analysis.overallScore > 75 ? '#27ae60' : analysis.overallScore > 50 ? '#f39c12' : '#e74c3c'};">
                    ${analysis.overallScore}%
                </div>
                <p style="color: #7f8c8d;">Score de sant√© de la peau</p>
                <p style="color: #95a5a6; font-size: 0.9em;">√Çge estim√© de la peau : ${analysis.skinAge} ans</p>
            </div>
            
            <!-- Probl√®mes d√©tect√©s -->
            <h4 style="color: #2c3e50; margin: 20px 0;">üîç Probl√®mes d√©tect√©s</h4>
            <div style="display: grid; gap: 15px;">
    `;
    
    analysis.detectedIssues.forEach(issue => {
        const severityColor = issue.severity === 'S√©v√®re' ? '#e74c3c' : 
                             issue.severity === 'Mod√©r√©e' ? '#f39c12' : '#27ae60';
        
        html += `
            <div style="padding: 15px; background: #f8f9fa; border-left: 4px solid ${severityColor}; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong style="color: #2c3e50;">${issue.issue}</strong>
                    <span style="background: ${severityColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">
                        ${issue.severity}
                    </span>
                </div>
                <p style="color: #7f8c8d; margin: 8px 0; font-size: 0.9em;">
                    Zones affect√©es : ${issue.zones.join(', ')}
                </p>
                <div style="background: #ecf0f1; height: 10px; border-radius: 5px; margin-top: 10px;">
                    <div style="background: ${severityColor}; height: 100%; width: ${issue.percentage}%; border-radius: 5px;"></div>
                </div>
                <p style="color: #95a5a6; margin-top: 5px; font-size: 0.85em;">
                    ${issue.percentage}% de la zone analys√©e
                </p>
            </div>
        `;
    });
    
    html += `
            </div>
            
            <!-- Recommandations -->
            <h4 style="color: #2c3e50; margin: 20px 0 10px;">üíä Traitements recommand√©s</h4>
            <div style="display: grid; gap: 10px;">
    `;
    
    analysis.recommendations.forEach(rec => {
        const ingredient = ingredientsDatabase[rec.ingredient];
        html += `
            <div style="padding: 12px; background: #e8f8f5; border-radius: 8px;">
                <strong style="color: #16a085;">${rec.product}</strong>
                <p style="color: #2c3e50; margin: 5px 0; font-size: 0.9em;">
                    ${rec.frequency}
                </p>
                ${ingredient ? `
                    <p style="color: #7f8c8d; margin: 5px 0; font-size: 0.85em; font-style: italic;">
                        ${ingredient.benefits[0]}
                    </p>
                ` : ''}
            </div>
        `;
    });
    
    html += `
            </div>
            
            <!-- Bouton d'action -->
            <button onclick="savePhotoAnalysis()" 
                    style="width: 100%; margin-top: 20px; padding: 15px; 
                           background: linear-gradient(135deg, #27ae60, #229954);
                           color: white; border: none; border-radius: 10px; cursor: pointer;">
                üíæ Sauvegarder l'analyse
            </button>
        </div>
    `;
    
    resultsDiv.innerHTML = html;
}

// Sauvegarder l'analyse
function savePhotoAnalysis() {
    const analyses = JSON.parse(localStorage.getItem('photoAnalyses') || '[]');
    analyses.push({
        date: new Date().toISOString(),
        photo: currentPhotoData.substring(0, 100) + '...', // Sauvegarder juste un aper√ßu
        timestamp: Date.now()
    });
    localStorage.setItem('photoAnalyses', JSON.stringify(analyses));
    
    showNotification('‚úÖ Analyse sauvegard√©e !');
}
function showPremiumModal(feature) {
    // Au lieu d'afficher le modal, montrer les options de paiement
    showPaymentSection();
}

function closePremiumModal() {
    document.getElementById('premiumModal').style.display = 'none';
}

function subscribePremium() {
    // Ici, int√©grer PayPal ou Paddle
    showNotification('üöÄ Redirection vers le paiement...');
    // Pour test, activer premium temporairement
    analyzerCredits.isPremium = true;
    saveCredits();
    closePremiumModal();
}
// === ANALYSEUR DE COMPATIBILIT√â DE ROUTINE ===
function analyzeRoutineCompatibility() {
    const morningProducts = [];
    const eveningProducts = [];
    const incompatibilities = [];
    
    // V√©rifier les incompatibilit√©s communes
    if (morningProducts.includes('vitamin-c') && morningProducts.includes('niacinamide')) {
        incompatibilities.push({
            products: ['Vitamin C', 'Niacinamide'],
            issue: 'pH incompatible',
            solution: 'Utilisez Vitamin C le matin, Niacinamide le soir'
        });
    }
    
    if (eveningProducts.includes('retinol') && eveningProducts.includes('benzoyl-peroxide')) {
        incompatibilities.push({
            products: ['Retinol', 'Benzoyl Peroxide'],
            issue: 'Irritation excessive',
            solution: 'Alternez les jours d\'utilisation'
        });
    }
    
    return { morning: morningProducts, evening: eveningProducts, incompatibilities };
}

// === G√âN√âRATEUR DE ROUTINE OPTIMIS√âE ===
function generateOptimizedRoutine() {
    const profile = JSON.parse(localStorage.getItem('skinProfile') || '{}');
    const routine = {
        morning: [],
        evening: []
    };
    
    // Matin - Protection et pr√©vention
    routine.morning.push({
        step: 1,
        type: 'Nettoyant',
        recommendation: skinType === 'grasse' ? 'Gel moussant avec Salicylic Acid' : 'Lait nettoyant doux',
        ingredient: skinType === 'grasse' ? 'salicylic-acid' : 'glycerin'
    });
    
    routine.morning.push({
        step: 2,
        type: 'S√©rum',
        recommendation: 'S√©rum Vitamin C 10-15%',
        ingredient: 'vitamin-c',
        warning: 'Ne pas m√©langer avec Niacinamide'
    });
    
    routine.morning.push({
        step: 3,
        type: 'Hydratant',
        recommendation: 'Cr√®me avec Ceramides',
        ingredient: 'ceramides'
    });
    
    routine.morning.push({
        step: 4,
        type: 'Protection',
        recommendation: 'SPF 30+ avec Zinc Oxide',
        ingredient: 'zinc-oxide'
    });
    
    // Soir - Traitement et r√©paration
    routine.evening.push({
        step: 1,
        type: 'D√©maquillant',
        recommendation: 'Huile d√©maquillante ou eau micellaire',
        ingredient: 'squalane'
    });
    
    if (concerns.includes('rides') || concerns.includes('acne')) {
        routine.evening.push({
            step: 2,
            type: 'Traitement',
            recommendation: 'Retinol 0.025-0.1%',
            ingredient: 'retinol',
            warning: 'Commencer progressivement, 2x/semaine'
        });
    }
    
    routine.evening.push({
        step: 3,
        type: 'Hydratant',
        recommendation: 'Cr√®me riche avec Peptides',
        ingredient: 'peptides'
    });
    
    return routine;
}
        function loadCycleData() {
            const savedCycle = localStorage.getItem('cycleData');
            if (savedCycle) {
                const data = JSON.parse(savedCycle);
                document.getElementById('cycleSetup').style.display = 'none';
                document.getElementById('cycleAnalysis').style.display = 'block';
                displayCycleAnalysis(data);
            }
        }

        function setupCycle() {
            const lastPeriodDate = document.getElementById('lastPeriodDate').value;
            const cycleLength = document.getElementById('cycleLength').value;
            const periodDuration = document.getElementById('periodDuration').value;
    
            if (!lastPeriodDate) {
                showNotification('‚ö†Ô∏è S√©lectionne la date de tes derni√®res r√®gles');
                return;
            }
    
            // Calculer la phase actuelle et d√©tecter un retard
            const today = new Date();
            const lastPeriod = new Date(lastPeriodDate);
            const daysSinceLastPeriod = Math.floor((today - lastPeriod) / (1000 * 60 * 60 * 24));
            const cyclesPass√©s = Math.floor(daysSinceLastPeriod / parseInt(cycleLength));
            const dayOfCycle = daysSinceLastPeriod % parseInt(cycleLength);
    
            // D√âTECTION DE RETARD
            let alertRetard = null;
            if (daysSinceLastPeriod > parseInt(cycleLength) + 7) { // Plus de 7 jours de retard
                const joursRetard = daysSinceLastPeriod - parseInt(cycleLength);
                alertRetard = {
                    jours: joursRetard,
                    cycles: cyclesPass√©s,
                    message: joursRetard > 30 ? 'important' : 'mod√©r√©'
                };
            }
    
            let phase = 'menstruelle';
            let phaseEmoji = 'ü©∏';
            let skinTips = [];
            let productRecommendations = [];
    
            // Logique des phases (si pas de retard important)
            if (alertRetard && alertRetard.jours > 14) {
                phase = 'retard';
                phaseEmoji = '‚ö†Ô∏è';
                skinTips = [
                    '‚ö†Ô∏è Cycle irr√©gulier d√©tect√© - la peau peut √™tre impr√©visible',
                    'üå°Ô∏è Les fluctuations hormonales peuvent causer des changements cutan√©s',
                    'üíß Maintiens une routine douce et constante'
                ];
                productRecommendations = [
                    { type: 'Routine', suggestion: 'Produits doux et non-irritants' },
                    { type: 'Hydratation', suggestion: 'Cr√®me barri√®re protectrice' }
                ];
            } else if (dayOfCycle <= periodDuration) {
                phase = 'menstruelle';
                phaseEmoji = 'ü©∏';
                skinTips = [
                    'üå°Ô∏è Peau plus sensible et r√©active',
                    'üíß Hydratation maximale n√©cessaire',
                    'üß¥ Privil√©gie les produits doux et apaisants'
                ];
                productRecommendations = [
                    { type: 'Nettoyant', suggestion: 'Gel ultra-doux sans sulfates' },
                    { type: 'Hydratant', suggestion: 'Cr√®me riche en c√©ramides' }
                ];
            } else if (dayOfCycle <= 13) {
                phase = 'folliculaire';
                phaseEmoji = 'üå±';
                skinTips = [
                    'üåü Peau en phase de r√©g√©n√©ration',
                    '‚ú® Moment id√©al pour exfolier (AHA/BHA)',
                    'üíâ Les actifs sont mieux absorb√©s'
                ];
                productRecommendations = [
                    { type: 'Exfoliant', suggestion: 'Acide glycolique 5-7%' },
                    { type: 'S√©rum', suggestion: 'Vitamine C + peptides' }
                ];
            } else if (dayOfCycle <= 16) {
                phase = 'ovulatoire';
                phaseEmoji = '‚ú®';
                skinTips = [
                    'üåü Pic de radiance naturelle',
                    'üíé Peau √† son meilleur √©tat',
                    'üì∏ Moment parfait pour les photos'
                ];
                productRecommendations = [
                    { type: 'Booster', suggestion: 'S√©rum √©clat √† la niacinamide' },
                    { type: 'Protection', suggestion: 'SPF 50+ l√©ger' }
                ];
            } else {
                phase = 'lut√©ale';
                phaseEmoji = 'üåô';
                skinTips = [
                    '‚ö†Ô∏è Risque accru d\'imperfections',
                    'üõ°Ô∏è Renforce ta barri√®re cutan√©e',
                    'üßò‚Äç‚ôÄÔ∏è Gestion du stress importante'
                ];
                productRecommendations = [
                    { type: 'Traitement', suggestion: 'S√©rum anti-imperfections au zinc' },
                    { type: 'Masque', suggestion: 'Argile purifiante 1x/semaine' }
                ];
            }
    
            const daysUntilPeriod = parseInt(cycleLength) - dayOfCycle;
    
            // Sauvegarder les donn√©es
            const cycleData = {
                userId: localStorage.getItem('skinProfile') ? JSON.parse(localStorage.getItem('skinProfile')).name : 'user',
                lastPeriodDate: lastPeriodDate,
                cycleLength: cycleLength,
                periodDuration: periodDuration,
                phase: phase,
                phaseEmoji: phaseEmoji,
                day: dayOfCycle,
                daysSinceLastPeriod: daysSinceLastPeriod,
                daysUntilPeriod: daysUntilPeriod,
                skinTips: skinTips,
                productRecommendations: productRecommendations,
                alertRetard: alertRetard
            };
    
            localStorage.setItem('cycleData', JSON.stringify(cycleData));
    
            // Afficher l'analyse
            document.getElementById('cycleSetup').style.display = 'none';
            document.getElementById('cycleAnalysis').style.display = 'block';
            displayCycleAnalysis(cycleData);
    
            // Afficher une alerte si retard important
            if (alertRetard) {
                if (alertRetard.jours > 30) {
                    showNotification('‚ö†Ô∏è Retard de ' + alertRetard.jours + ' jours d√©tect√© - Consultation recommand√©e');
                } else {
                    showNotification('üìÖ Retard de ' + alertRetard.jours + ' jours d√©tect√©');
                }
            } else {
                showNotification('‚úÖ Cycle configur√© avec succ√®s !');
            }
        }

        function displayCycleAnalysis(data) {
            // Phase actuelle
            const phaseDisplay = document.getElementById('currentPhaseDisplay');
            if (phaseDisplay) {
                let alertHtml = '';
        
                // Si retard d√©tect√©, afficher une alerte
                if (data.alertRetard) {
                    if (data.alertRetard.jours > 30) {
                        alertHtml = `
                            <div style="background: #fee; border: 2px solid #f88; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                                <h4 style="color: #c00; margin-bottom: 10px;">‚ö†Ô∏è Retard important d√©tect√©</h4>
                                <p style="color: #800; margin: 5px 0;">
                                    <strong>${data.alertRetard.jours} jours</strong> depuis tes derni√®res r√®gles
                                    (${data.alertRetard.cycles} cycle${data.alertRetard.cycles > 1 ? 's' : ''} complet${data.alertRetard.cycles > 1 ? 's' : ''} de retard)
                                </p>
                                <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                    <p style="color: #666; margin: 5px 0; font-size: 0.9em;">
                                        <strong>Actions recommand√©es :</strong>
                                    </p>
                                    <ul style="color: #666; font-size: 0.9em; margin: 5px 0; padding-left: 20px;">
                                       <li>Faire un test de grossesse si applicable</li>
                                       <li>Consulter un professionnel de sant√©</li>
                                       <li>Noter tout sympt√¥me inhabituel</li>
                                    </ul>
                                </div>
                            </div>
                        `;
                    } else if (data.alertRetard.jours > 7) {
                        alertHtml = `
                            <div style="background: #ffeaa7; border: 2px solid #fdcb6e; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                                <h4 style="color: #f39c12; margin-bottom: 10px;">üìÖ Retard d√©tect√©</h4>
                                <p style="color: #d68910; margin: 5px 0;">
                                    <strong>${data.alertRetard.jours} jours</strong> de retard
                                </p>
                                <p style="color: #856404; font-size: 0.9em; margin-top: 10px;">
                                    Cela peut √™tre d√ª au stress, changements de poids, ou autres facteurs.
                                    Si le retard persiste, consulte un professionnel.
                                </p>
                            </div>
                        `;
                    }
                }
        
                phaseDisplay.innerHTML = alertHtml + `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 4em; margin-bottom: 10px;">${data.phaseEmoji || 'üåô'}</div>
                        <h3 style="color: #ec407a; margin-bottom: 10px;">
                            Phase ${data.phase || 'inconnue'}
                            ${data.alertRetard ? ' (cycle irr√©gulier)' : ''}
                        </h3>
                        <p style="color: #4a5568;">
                            ${data.alertRetard ? 
                                `${data.daysSinceLastPeriod} jours depuis les derni√®res r√®gles` : 
                                `Jour ${data.day || '?'} du cycle`}
                        </p>
                        <p style="color: #718096; font-size: 0.9em;">
                            ${data.alertRetard && data.alertRetard.jours > 14 ? 
                                'Prochaines r√®gles : √Ä d√©terminer' : 
                                data.daysUntilPeriod ? `Prochaines r√®gles : Dans ${data.daysUntilPeriod} jours` : '√Ä calculer'}
                        </p>
                    </div>
                `;
            }
    
            // Conseils peau
            const tipsDisplay = document.getElementById('skinTipsDisplay');
            if (tipsDisplay && data.skinTips) {
                let tipsHtml = '<ul style="list-style: none; padding: 0;">';
                data.skinTips.forEach(tip => {
                    tipsHtml += `
                        <li style="padding: 10px; margin-bottom: 10px; background: #fce4ec; 
                                   border-radius: 8px; color: #880e4f;">
                            ${tip}
                        </li>
                    `;
                });
                tipsHtml += '</ul>';
                tipsDisplay.innerHTML = tipsHtml;
            }
    
            // Produits recommand√©s
            const productsDisplay = document.getElementById('productRecommendationsDisplay');
            if (productsDisplay && data.productRecommendations) {
                let productsHtml = '<div style="display: grid; gap: 15px;">';
                data.productRecommendations.forEach(product => {
                    productsHtml += `
                        <div style="display: flex; justify-content: space-between; align-items: center; 
                                   padding: 15px; background: #f7fafc; border-radius: 10px;">
                            <div>
                                <div style="color: #718096; font-size: 0.9em;">${product.type}</div>
                                <div style="color: #2d3748; font-weight: 600;">${product.suggestion}</div>
                            </div>
                        </div>
                    `;
                });
                productsHtml += '</div>';
                productsDisplay.innerHTML = productsHtml;
            }
        }

        // Charger l'historique au d√©marrage et le profil sauvegard√©
        window.addEventListener('DOMContentLoaded', function() {
            // Charger l'historique des check-ins
            const savedCheckins = localStorage.getItem('checkinsHistory');
            if (savedCheckins) {
                checkinsHistory = JSON.parse(savedCheckins);
            }
            
            // Charger le profil sauvegard√©
            const savedProfile = localStorage.getItem('skinProfile');
            if (savedProfile) {
                const profile = JSON.parse(savedProfile);
                skinType = profile.skinType || '';
                concerns = profile.concerns || [];
            }
        });
        function returnToGallery() {
    // R√©afficher le titre et progression
    document.querySelector('.container h1').style.display = 'block';
    document.querySelector('.subtitle').style.display = 'block';
    document.getElementById('progressBar').style.display = 'flex';
    
    // Cacher photoAISection
    document.getElementById('photoAISection').style.display = 'none';
    
    // Afficher photosSection
    showPhotos();
}
function returnToDashboard() {
    console.log('üè† Retour au dashboard');
    
    // R√©afficher titre et progression
    const h1 = document.querySelector('.container h1');
    const subtitle = document.querySelector('.subtitle');
    const progressBar = document.getElementById('progressBar');
    
    if (h1) h1.style.display = 'block';
    if (subtitle) subtitle.style.display = 'block';
    if (progressBar) progressBar.style.display = 'flex';
    
    // ENLEVER la classe fullscreen de toutes les sections sp√©ciales
    document.querySelectorAll('.section').forEach(s => {
        s.classList.remove('fullscreen'); // ‚Üê AJOUTER CETTE LIGNE
    });
    
    // Cacher photoAISection
    const photoSection = document.getElementById('photoAISection');
    if (photoSection) {
        photoSection.style.display = 'none';
        photoSection.classList.remove('active');
    }
    
    // Cacher toutes les sections
    document.querySelectorAll('.section').forEach(s => {
        s.classList.remove('active');
        s.style.display = 'none';
    });
    
    // Afficher le dashboard
    const dashboard = document.getElementById('result');
    if (dashboard) {
        dashboard.classList.add('active');
        dashboard.style.display = 'block';
    }
    
    window.scrollTo(0, 0);
}
function returnToPhotos() {
    console.log('üì∏ Retour √† la section Photos');
    
    const h1 = document.querySelector('.container h1');
    const subtitle = document.querySelector('.subtitle');
    const progressBar = document.getElementById('progressBar');
    
    if (h1) h1.style.display = 'block';
    if (subtitle) subtitle.style.display = 'block';
    if (progressBar) progressBar.style.display = 'flex';
    
    document.querySelectorAll('.section').forEach(s => {
        s.classList.remove('fullscreen');
        s.classList.remove('active');
        s.style.display = 'none';
    });
    
    const photosSection = document.getElementById('photos');
    if (photosSection) {
        photosSection.classList.add('active');
        photosSection.style.display = 'block';
    }
    
    window.scrollTo(0, 0);
}
    </script>
</body>
</html>